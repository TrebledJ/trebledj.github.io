<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="__debug" content="HKCERT CTF 2023 – Decompetition: Vitamin C++"><meta name="__debug" content="HKCERT CTF 2023 – Decompetition: Vitamin C++"><meta name="__debug" content="A beginner-friendly writeup to reverse-engineering C++. Years of complex shenanigans condensed!"><title>HKCERT CTF 2023 – Decompetition: Vitamin C++ - TrebledJ&#39;s Pages</title><meta name="description" content="A beginner-friendly writeup to reverse-engineering C++. Years of complex shenanigans condensed!"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="keywords" content="trebledj,hkcert ctf 2023 – decompetition: vitamin c++,a beginner-friendly writeup to reverse-engineering c++. years of complex shenanigans condensed!,ctf,writeup,reverse,cpp,tutorial,programming"><meta name="robots" content="index,follow"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' *.disqus.com *.disquscdn.com code.jquery.com cdn.jsdelivr.net gist.github.com static.cloudflareinsights.com; style-src 'self' 'unsafe-inline' *.disquscdn.com cdn.jsdelivr.net cdnjs.cloudflare.com github.githubassets.com; font-src 'self' data: cdn.jsdelivr.net cdnjs.cloudflare.com; img-src 'self' data: c.disquscdn.com; frame-src 'self' disqus.com *.soundcloud.com; connect-src 'self' cloudflareinsights.com;"><link href="/feeds/posts.xml" rel="alternate" title="RSS Feed for TrebledJ&#39;s Pages" type="application/rss+xml"><meta property="og:site_name" content="TrebledJ&#39;s Pages"><meta property="og:type" content="article"><meta property="og:title" content="HKCERT CTF 2023 – Decompetition: Vitamin C++"><meta property="twitter:title" content="HKCERT CTF 2023 – Decompetition: Vitamin C++"><meta property="og:description" content="A beginner-friendly writeup to reverse-engineering C++. Years of complex shenanigans condensed!

Oh boy, another C++ reverse challenge. :rubs_hands_in_delight: Decompetition: Vitamin C++ is a reverse engineering challenge in this year&#39;s HKCERT CTF, an annual online capture-the-flag competition hosted in Hong Kong. The..."><meta property="twitter:description" content="A beginner-friendly writeup to reverse-engineering C++. Years of complex shenanigans condensed!

Oh boy, another C++ reverse challenge. :rubs_hands_in_delight: Decompetition: Vitamin C++ is a reverse engineering challenge in this year&#39;s HKCERT CTF, an annual online capture-the-flag competition hosted in Hong Kong. The..."><meta property="og:url" content="https://trebledj.me/posts/hkcert-2023-decompetition-vitamin-cpp/"><meta name="twitter:card" content="summary_large_image"><meta property="og:image" content="https://trebledj.me/img/posts/ctf/hkcert23/assets/vitamin-cpp-640w.webp"><meta property="twitter:image" content="https://trebledj.me/img/posts/ctf/hkcert23/assets/vitamin-cpp-640w.webp"><meta property="article:published_time" content="2023-11-16T00:00:00.000Z"><meta property="article:author" content="TrebledJ"><meta property="article:section" content="ctfs"><meta property="article:tag" content="ctf"><meta property="article:tag" content="writeup"><meta property="article:tag" content="reverse"><meta property="article:tag" content="cpp"><meta property="article:tag" content="tutorial"><meta property="article:tag" content="programming"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css" media="print"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" media="print"><link rel="stylesheet" href="/css/third-party/prism-diff.css" media="print"><script>document.querySelectorAll('link[media|="print"]').forEach(e=>{e.addEventListener("load",()=>e.media="all"),e.sheet&&(e.media="all")})</script><script>const defaultTheme="dark";let icon=void 0;var reloadDisqus=void 0;function modeInit(){var e=localStorage.getItem("theme");setMode("dark"===e?"dark":"light"===e?"light":defaultTheme)}function modeInitIcon(){icon=document.getElementById("mode-switch-icon"),isLightTheme()&&(icon.classList.remove("fa-moon"),icon.classList.add("fa-sun"),icon.classList.add("mode-switch-transform"))}function isLightTheme(){return"light"===localStorage.getItem("theme")}function modeSwitcher(){var e=localStorage.getItem("theme");"dark"===e?(setMode("light"),reloadDisqus&&reloadDisqus()):"light"===e?(setMode("dark"),reloadDisqus&&reloadDisqus()):setMode(defaultTheme)}function setMode(e){"dark"===e?(document.documentElement.setAttribute("data-theme","dark"),localStorage.setItem("theme","dark")):"light"===e&&(document.documentElement.setAttribute("data-theme","light"),localStorage.setItem("theme","light")),icon&&(icon.classList.toggle("fa-moon"),icon.classList.toggle("fa-sun"),icon.classList.toggle("mode-switch-transform"))}modeInit(),document.addEventListener("DOMContentLoaded",()=>{document.getElementById("mode-switch").addEventListener("click",()=>{modeSwitcher()})})</script><script defer="defer" src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js"></script><script defer="defer" src="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js"></script><link rel="icon" href="/favicon.ico" type="image/x-icon"><html class="no-js"></html><body><header><nav class="navbar navbar-expand-md py-2"><div class="container-fluid justify-content-between align-items-center"><button aria-controls="navbar-container" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler shadow-none" data-bs-target="#navbar-container" data-bs-toggle="collapse" type="button"><span id="navbar-toggler-icon"><i class="fas fa-bars"></i></span></button> <a class="navbar-brand no-decoration" href="/">TrebledJ&#39;s Pages</a><div class="navbar-collapse collapse" id="navbar-container"><ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="/">Home</a></li><li class="nav-item"><a class="nav-link" href="/about">About</a></li><li class="nav-item"><a class="nav-link" href="/posts">Posts</a></li><li class="nav-item"><a class="nav-link" href="/tags/project/">Projects</a></li><li class="nav-item"><a class="nav-link" href="/music">Music</a></li></ul><ul class="navbar-nav"><li><a class="nav-link me-2" data-bs-toggle="modal" data-bs-target="#search-modal" aria-label="Search..." role="button"><i class="fas fa-search nav-icon"></i></a></li><li><a class="nav-link" id="mode-switch" aria-label="Theme Switch" role="button"><i id="mode-switch-icon" class="fas fa-moon nav-icon"></i></a><script>modeInitIcon()</script></li></ul></div></div></nav><div id="scroll-progress-bar"></div></header><div aria-hidden="true" aria-labelledby="search-modal-label" class="modal fade" id="search-modal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header pb-2 d-flex flex-row justify-content-between"><div class="container-fluid ps-0" id="search-box-container"><input type="text" autofocus class="container-fluid" id="search-box" placeholder="Search"> <i class="fas fa-search"></i></div><button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button></div><div class="modal-body" id="search-results-list"></div></div></div></div><button id="btn-back-to-top" class="btn btn-lg" type="button" aria-label="Back to Top"><i class="fas fa-arrow-up"></i></button><div id="btn-mobile-toc" class="dropup"><button type="button" class="btn btn-lg" data-bs-toggle="dropdown" aria-label="Content"><i class="fas fa-list-ul"></i></button><ul class="dropdown-menu toc-container"><nav class="toc"><ol><li><a href="#description">Description</a></li><li><a href="#analysis">Analysis</a></li><li><a href="#trie-me">Trie Me</a></li><li><a href="#setting-up-the-structure">Setting Up the Structure</a><ol><li><a href="#demangling-names">Demangling Names</a></li><li><a href="#classy-types">Classy Types</a></li></ol></li><li><a href="#reversing">Reversing</a><ol><li><a href="#plagiarise-a-decompiler">Plagiarise a Decompiler</a></li><li><a href="#implement-the-data-structure">Implement the Data Structure</a></li><li><a href="#on-various-features">On Various Features</a></li><li><a href="#on-scoping">On Scoping</a></li><li><a href="#on-structured-bindings">On Structured Bindings</a></li><li><a href="#on-const-ref">On Const Ref</a></li><li><a href="#on-for-range-loops">On For-Range Loops</a></li><li><a href="#on-control-flow">On Control Flow</a></li><li><a href="#other-useful-tips">Other Useful Tips</a></li></ol></li><li><a href="#the-infernal-flag">The Infernal Flag</a></li><li><a href="#final-remarks">Final Remarks</a></li><li><a href="#solve-sauce">Solve Sauce</a></li><li><a href="#flag">Flag</a></li></ol></nav></ul></div><div class="main-container"><div class="page-container col-lg-12"><div class="container-lg px-0"><article class="w-100 post-article" itemscope itemtype="http://schema.org/BlogPosting"><div class="row d-flex flex-row-reverse gx-6"><div class="col-lg-4 d-none d-lg-block"><div class="dim-deep"><div class="metadata-container d-flex"><div class="d-flex flex-row align-items-center"><span><i class="fas fa-calendar post-meta-icon me-1"></i> </span><span class="fs-7 post-posted-date">Posted on <span itemprop="dateCreated">2023&#8209;11&#8209;16</span></span></div><div class="d-flex flex-row align-items-center"></div><div class="d-flex flex-row align-items-center"><span><i class="far fa-clock post-meta-icon me-1"></i> </span><span class="fs-7">12 minute read</span></div></div><div class="metadata-tag-container d-flex flex-row align-items-top"><span><i class="fas fa-tag post-meta-icon me-1 mt-2"></i></span><div class="tag-list d-flex flex-row flex-wrap align-items-center"><span><a class="tag" href="/tags/ctf/" itemprop="keywords">ctf</a> </span><span><a class="tag" href="/tags/writeup/" itemprop="keywords">writeup</a> </span><span><a class="tag" href="/tags/reverse/" itemprop="keywords">reverse</a> </span><span><a class="tag" href="/tags/cpp/" itemprop="keywords">cpp</a> </span><span><a class="tag" href="/tags/tutorial/" itemprop="keywords">tutorial</a> </span><span><a class="tag" href="/tags/programming/" itemprop="keywords">programming</a></span></div></div></div><br><div id="toc-sidebar" class="sticky-right dim-deep"><div class="toc-container"><span><a id="toc-content">Content</a></span><nav class="toc"><ol><li><a href="#description">Description</a></li><li><a href="#analysis">Analysis</a></li><li><a href="#trie-me">Trie Me</a></li><li><a href="#setting-up-the-structure">Setting Up the Structure</a><ol><li><a href="#demangling-names">Demangling Names</a></li><li><a href="#classy-types">Classy Types</a></li></ol></li><li><a href="#reversing">Reversing</a><ol><li><a href="#plagiarise-a-decompiler">Plagiarise a Decompiler</a></li><li><a href="#implement-the-data-structure">Implement the Data Structure</a></li><li><a href="#on-various-features">On Various Features</a></li><li><a href="#on-scoping">On Scoping</a></li><li><a href="#on-structured-bindings">On Structured Bindings</a></li><li><a href="#on-const-ref">On Const Ref</a></li><li><a href="#on-for-range-loops">On For-Range Loops</a></li><li><a href="#on-control-flow">On Control Flow</a></li><li><a href="#other-useful-tips">Other Useful Tips</a></li></ol></li><li><a href="#the-infernal-flag">The Infernal Flag</a></li><li><a href="#final-remarks">Final Remarks</a></li><li><a href="#solve-sauce">Solve Sauce</a></li><li><a href="#flag">Flag</a></li></ol></nav><br></div><div class="toc-link-container"><span><a href="#related">Related</a></span></div><div class="toc-link-container"><span><a href="#comments">Comments</a></span></div></div></div><div class="col-lg-8 post-body-container"><div class="article-header"><h1 class="post-title" itemprop="name headline">HKCERT CTF 2023 – Decompetition: Vitamin C++</h1><p class="post-desc" itemprop="alternativeHeadline">A beginner-friendly writeup to reverse-engineering C++. Years of complex shenanigans condensed!</p><div class="d-lg-none dim-deep"><div class="metadata-container d-flex"><div class="d-flex flex-row align-items-center"><span><i class="fas fa-calendar post-meta-icon me-1"></i> </span><span class="fs-7 post-posted-date">Posted on <span itemprop="dateCreated">2023&#8209;11&#8209;16</span></span></div><div class="d-flex flex-row align-items-center"></div><div class="d-flex flex-row align-items-center"><span><i class="far fa-clock post-meta-icon me-1"></i> </span><span class="fs-7">12 minute read</span></div></div><div class="metadata-tag-container d-flex flex-row align-items-top"><span><i class="fas fa-tag post-meta-icon me-1 mt-2"></i></span><div class="tag-list d-flex flex-row flex-wrap align-items-center"><span><a class="tag" href="/tags/ctf/" itemprop="keywords">ctf</a> </span><span><a class="tag" href="/tags/writeup/" itemprop="keywords">writeup</a> </span><span><a class="tag" href="/tags/reverse/" itemprop="keywords">reverse</a> </span><span><a class="tag" href="/tags/cpp/" itemprop="keywords">cpp</a> </span><span><a class="tag" href="/tags/tutorial/" itemprop="keywords">tutorial</a> </span><span><a class="tag" href="/tags/programming/" itemprop="keywords">programming</a></span></div></div></div></div><hr><div class="post-body" itemprop="articleBody text"><a class="lightbox-single" title="HKCERT CTF 2023 – Decompetition: Vitamin C++" href="/img/posts/ctf/hkcert23/assets/vitamin-cpp-640w.webp"><img class="mb-2 rw center w-100" src="/img/posts/ctf/hkcert23/assets/vitamin-cpp-640w.webp" loading="eager" decoding="async" style="aspect-ratio:auto 640/360" alt="HKCERT CTF 2023 – Decompetition: Vitamin C++" title="HKCERT CTF 2023 – Decompetition: Vitamin C++" srcset="/img/posts/ctf/hkcert23/assets/vitamin-cpp-512w.webp 512w, /img/posts/ctf/hkcert23/assets/vitamin-cpp-640w.webp 640w" sizes="(max-width: 512px) 512px, 640px"></a><p>Oh boy, another C++ reverse challenge. :rubs_hands_in_delight:</p><p><em>Decompetition: Vitamin C++</em> is a reverse engineering challenge in this year's HKCERT CTF, an annual online capture-the-flag competition hosted in Hong Kong. The format is slightly different from usual rev chals in that we’re required to <em>derive the source code</em> of a binary. This really tests our understanding of how the language is compiled into machine code.</p><p>So whether you’re a first-timer or a veteran at reversing C++, this is a fun(?) way to dive deep into or review neat aspects of the language.</p><p>If you want to follow along, you can grab the challenge here: <a href="https://github.com/blackb6a/hkcert-ctf-2023-challenges/tree/master/57-decomp-cpp">GitHub</a> (<a href="https://github.com/TrebledJ/ctf-binaries/tree/main/hkcert-2023/decompetition-vitamin-cpp">Backup</a>). I’ll also be relying on <a href="https://ghidra-sre.org/">Ghidra</a> as my decompiler, because I <s>am poor</s> want to support open-source.</p><h2 id="description" tabindex="-1"><a class="md-anchor" href="#description" aria-hidden="true"></a> Description</h2><p>Author: <a href="https://twitter.com/harrier_lcc">harrier</a><br>4/5 stars ⭐️. 5/311 solves.</p><blockquote><p>So let's learn reverse with Decompetition!<sup class="footnote-ref"><a href="#fn1" id="fnref1">1</a></sup> The goal is simple: try to recover the original source code as much as possible, while understand the code logic deeply to get the internal flag! Only with two of those together, you will win this flag.</p><p><a href="https://en.cppreference.com/w/cpp">STL</a> is used everywhere, so it would be nice to be able to reverse them!</p><p>Note there is an internal flag with flag format <code>internal{}</code>. Please do not submit this directly to the platform.</p><p>g++ version: g++ (Debian 12.2.0-14) 12.2.0</p><pre class="language-sh"><code class="language-sh"><span class="token function">nc</span> chal.hkcert23.pwnable.hk <span class="token number">28157</span></code></pre></blockquote><p>And a note on testing:</p><blockquote><p>If you want to run this locally, you can install all the prerequisite library with <code>pip</code>, and run <code>python compiler trie.disasm</code>.</p><pre class="language-sh"><code class="language-sh">pip <span class="token function">install</span> pyyaml capstone intervaltree pyelftools diff_match_patch</code></pre></blockquote><p>Thus, to get the flag, we need to:</p><ol><li>Obtain the source code (97.5% similarity).</li><li>Obtain the internal flag by reversing the source code.</li><li>Submit the internal flag (not to the platform, but to the remote connection).</li><li>Profit!</li></ol><p>(You can see this process play out in compiler.py.)</p><p>The first step is the most challenging. Even if we have a decent understanding of the program, we still need the source code to continue.</p><p>Let’s start by analysing what we’re given and how we can approach the problem. We'll aim for 100% similarity, but go step by step.</p><h2 id="analysis" tabindex="-1"><a class="md-anchor" href="#analysis" aria-hidden="true"></a> Analysis</h2><p>Unzipping our bag of goodies, we’re given:</p><ul><li><strong>compiler.py</strong>. This is the backend doing all the compilation and diffing.<ul><li>Only <code>TrieNode</code> methods, <code>wordhash</code>, and <code>main</code> are diffed.</li><li>Prior to compiling, our code is prefixed with some boilerplate (includes of <code>unordered_map</code>, <code>string</code>, and <code>iostream</code>).</li></ul></li><li><strong>build.sh</strong>. Checks our code against bad patterns, and compiles the program.</li><li><strong>trie</strong>. This is the binary file of our target source code. Open this in your favourite decompiler.</li><li><strong>trie.disasm</strong>. This is the disassembly used by compiler.py for diffing.</li><li><strong>flag.txt</strong>. Read and printed by compiler.py after submitting the internal flag.</li><li>A bunch of other Python files to make things work.</li></ul><p>Is there a way we can simplify the process?</p><p>Inline assembly with <code>asm</code>, <code>attribute</code> trickery, and macros are disallowed.</p><p>A quick Google search for TrieNodes resulted in disappointment. The <code>mix()</code> function is especially unique, as tries generally just do insert/search. So we can probably conclude: the implementation was either hand-spun or modified substantially.</p><p>It appears the most productive approach is to tackle the problem head on.</p><p>But hey, it’s just a simple lil’ trie, not a friggin standard template container or Boost/Qt library. We can do this!</p><h2 id="trie-me" tabindex="-1"><a class="md-anchor" href="#trie-me" aria-hidden="true"></a> Trie Me</h2><p><a class="lightbox-single" title="If you never trie, you will never know." href="/img/posts/ctf/hkcert23/assets/there-is-no-trie-500w.webp"><img class="mb-2 rw center w-45" src="/img/posts/ctf/hkcert23/assets/there-is-no-trie-500w.webp" loading="lazy" decoding="async" style="aspect-ratio:auto 500/575" alt="Do or do not, there is no trie!" title="If you never trie, you will never know." srcset="/img/posts/ctf/hkcert23/assets/there-is-no-trie-500w.webp 500w" sizes="500px"></a></p><p>Let’s briefly review tries. What is a trie?</p><p>Tries, or prefix trees, are data structures commonly used to efficiently store and retrieve strings. They are particularly useful for tasks like autocomplete or spell checking. The key idea behind tries is that each node in the tree represents a <em>prefix of a string</em>, and the edges represent the <em>characters</em> that can follow that prefix.</p><p class="caption"><a class="lightbox-single" title="A trie containing the words: *that*, *there*, *this*, *does*, and *did*." href="/img/trie12-791w.webp"><img class="mb-2 rw center w-60 alpha-img" src="/img/trie12-791w.webp" loading="lazy" decoding="async" style="aspect-ratio:auto 791/900" alt="A trie containing the words: *that*, *there*, *this*, *does*, and *did*." title="A trie containing the words: *that*, *there*, *this*, *does*, and *did*." srcset="/img/trie12-512w.webp 512w, /img/trie12-791w.webp 791w" sizes="(max-width: 512px) 512px, 791px"></a><sup>Example of trie containing the words <em>that</em>, <em>there</em>, <em>this</em>, <em>does</em>, and <em>did</em>. Each edge represents a letter to the next prefix. (<a href="https://theoryofprogramming.wordpress.com/2015/01/16/trie-tree-implementation/">Source</a>)</sup></p><ul><li>In terms of matching an exact string, the complexity is similar to a hashmap: <code>O(n)</code> insert/search time, w.r.t. the length of the string. But a hashmap is typically faster as it requires fewer operations.</li><li>The power of tries comes with alphabetical ordering and prefix search (which is why they’re useful for autocomplete). Hashmaps can't do this.</li></ul><h2 id="setting-up-the-structure" tabindex="-1"><a class="md-anchor" href="#setting-up-the-structure" aria-hidden="true"></a> Setting Up the Structure</h2><h3 id="demangling-names" tabindex="-1"><a class="md-anchor" href="#demangling-names" aria-hidden="true"></a> Demangling Names</h3><p>Let’s start by demangling functions! This way, we’ll roughly know its name and signature—big clues, from a <a class="tag" href="/tags/functional/">functional</a> viewpoint.</p><p>In C++, function and class names are <em><strong>mangled</strong></em>. So instead of using sensible names like <code>TrieNode::mix</code>, <code>std::string::substr</code>, and <code>std::endl</code>, the compiler stores hellish sequences like <code>_ZN8TrieNode3mixEc</code>, <code>_ZNKSt7__cxx1112basic_stringIcSt11char_traitsIcESaIcEE6substrEmm</code>, and <code>_ZSt4endlIcSt11char_traitsIcEERSt13basic_ostreamIT_T0_ES6_</code>. (Yes, <code>endl</code> is a function.)</p><details><summary>Why do C++ compilers behave this way?</summary><div class="details-content"><p>This has to do with function overloading. For example:</p><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token keyword">float</span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string s<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span></code></pre><p class="caption"><sup>C++ function overloading in action. Same name. Different parameters.</sup></p><p>With function overloading, names are reused. Now if the names are the same, how can the linker find and call the right function? The compiler solves this by encoding a function’s signature into its name, so that all names are unique. (We don't have this problem in plain old C, because function overloading isn’t even a concept!)</p><div class="details-collapse-bottom"><sub><a class="details-collapse-button">(collapse)</a></sub></div></div></details><p>To demangle these cryptic monstrosities, we can throw them into online tools (e.g. <a href="http://demangler.com/">demangler.com</a>) or just use a C++-enabled decompiler (e.g. Ghidra) which automatically demangles names.</p><h3 id="classy-types" tabindex="-1"><a class="md-anchor" href="#classy-types" aria-hidden="true"></a> Classy Types</h3><p>When discussing C++, it’s hard to avoid the topic of classes. These supercharged C-structs are the basis of any object-oriented program.</p><p>Looking at the demangled function names, we can identify the <code>TrieNode</code> class. What next?</p><p>There are two parts to reversing a class:</p><ol><li>Methods/functions. How does the class behave? What does it do?<ul><li>These are easy to find due to the prefix (e.g. <code>TrieNode::</code>). Reversing their content is a different question, which we'll address in upcoming sections.</li></ul></li><li>Members. What comprises a class? What is its state?<ul><li>This is a tricky question to answer, as variable names are usually stripped. Careful analysis of reads/writes is required (<abbr data-bs-placement="top" data-bs-toggle="tooltip" title="cross references">xrefs</abbr> are useful!).<ul><li>Is it set to only 0 or 1? And used in conditions? Probably a boolean.</li><li>Is it compared to other numbers a lot and used near loops? Probably an integer representing size.</li></ul></li><li>By peeking at the <code>TrieNode</code> constructor, we figure out that <code>TrieNode</code> has three members.<ol><li>An <abbr data-bs-placement="top" data-bs-toggle="tooltip" title="std::unordered_map<char, TrieNode*>">unordered map (aka hashmap) from chars to nodes</abbr>. Size: 0x38 bytes. As this resembles the edges of the node, we'll call variable this <code>next_node</code>.</li><li>A bool. Size: 1 byte.</li><li>Another bool. Size: 1 byte.</li></ol></li></ul></li></ol><p>Overall, our structure should resemble:</p><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span> <span class="token comment">// FYI, this is discouraged in actual software engineering: https://stackoverflow.com/q/1452721/10239789.</span>

<span class="token keyword">void</span> <span class="token function">wordhash</span><span class="token punctuation">(</span>string s<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// return type: ???</span>

<span class="token keyword">struct</span> <span class="token class-name">TrieNode</span> <span class="token punctuation">{</span>
	<span class="token comment">// Members.</span>
	unordered_map<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span> TrieNode<span class="token operator">*</span><span class="token operator">></span> next_node<span class="token punctuation">;</span>
	<span class="token keyword">bool</span> bool1<span class="token punctuation">;</span>
	<span class="token keyword">bool</span> bool2<span class="token punctuation">;</span>

	<span class="token comment">// Constructor.</span>
	<span class="token comment">// Initialise variables. `next_node`'s constructor is called automatically.</span>
	<span class="token function">TrieNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> bool1<span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">,</span> bool2<span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">}</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>   <span class="token comment">// Member Initialiser List: https://cplusplus.com/articles/1vbCpfjN/</span>

	<span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span>string s<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// return type: ???</span>
	<span class="token keyword">void</span> <span class="token function">search</span><span class="token punctuation">(</span>string s<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// return type: ???</span>
	<span class="token keyword">void</span> <span class="token function">mix</span><span class="token punctuation">(</span><span class="token keyword">char</span> cmix<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// return type: ???</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><p class="caption"><sup>Return types are unknown, because most compilers don't mangle them with the name. For now, they've been substituted with <code>void</code> and left as an exercise for the reader.</sup></p><details><summary>On Struct vs. Class</summary><div class="details-content"><p>Structs are public by default. Classes are private by default.</p><p>Public/private are concepts which fall under <abbr data-bs-placement="top" data-bs-toggle="tooltip" title="object-oriented programming">OOP</abbr> <em><strong>encapsulation</strong></em>. With encapsulation, we bundle data and only expose certain API methods for public users, whilst hiding implementation. With a cyber analogy, this is not unlike exposing certain ports (HTTP/HTTPS) on a machine, and protecting other ports with a firewall.</p><p>I chose to use <code>struct</code> here because I'm lazy and want to make members public.<sup class="footnote-ref"><a href="#fn2" id="fnref2">2</a></sup> Some of them are accessed directly in <code>main</code> anyway.</p><p>Read more:</p><ul><li><a href="https://stackoverflow.com/a/36917400/10239789">StackOverflow: Struct vs. Class</a>.</li><li><a href="https://www.softwaretestinghelp.com/encapsulation-in-cpp/">Encapsulation</a></li></ul><div class="details-collapse-bottom"><sub><a class="details-collapse-button">(collapse)</a></sub></div></div></details><h2 id="reversing" tabindex="-1"><a class="md-anchor" href="#reversing" aria-hidden="true"></a> Reversing</h2><h3 id="plagiarise-a-decompiler" tabindex="-1"><a class="md-anchor" href="#plagiarise-a-decompiler" aria-hidden="true"></a> Plagiarise a Decompiler</h3><p>Now that we have a basic structure set up, it's time to dig deeper. We need to go from binary to source code. Hmm… that sounds like a job for… a decompiler!</p><p>So let’s start with that! We can <s>plagiarise</s> copy output from Ghidra and rewrite it to make programmatic sense.</p><div class="alert alert-info d-flex align-items-start"><i class="fas fa-circle-info ms-1 me-3 mt-1 fs-4" role="img"></i><div class="alert-content flex-fill mt-0"><p><strong>Exercise</strong>: Reverse the <code>wordhash</code> function.</p><details><summary>Solution</summary><div class="details-content"><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">char</span> <span class="token function">wordhash</span><span class="token punctuation">(</span>string s<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">char</span> hash <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> s<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        hash <span class="token operator">^=</span> s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> hash<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><p>This is a simple hash function which <em>xors</em> all characters in a string. It's not a very <em>effective</em> hasher, because it's prone to <a href="https://en.wikipedia.org/wiki/Hash_collision">collisions</a> (also it's not <a href="https://isocpp.org/wiki/faq/const-correctness">const-correct</a>). But eh, this is just for a CTF challenge.</p><div class="details-collapse-bottom"><sub><a class="details-collapse-button">(collapse)</a></sub></div></div></details></div></div><h3 id="implement-the-data-structure" tabindex="-1"><a class="md-anchor" href="#implement-the-data-structure" aria-hidden="true"></a> Implement the Data Structure</h3><p>Time to implement the core of the program: the TrieNode class. As before, we can refer to Ghidra's output.</p><div class="alert alert-info d-flex align-items-start"><i class="fas fa-circle-info ms-1 me-3 mt-1 fs-4" role="img"></i><div class="alert-content flex-fill mt-0"><p><strong>Exercise</strong>: Reverse <code>TrieNode::insert</code>, <code>TrieNode::search</code>, and <code>TrieNode::mix</code>.</p><ul><li>We can make good use of Ghidra's Rename, Retype, and Edit Function Signature tools to clean up the code.</li><li>Ghidra sometimes loads incorrect function signatures (e.g. for <code>operator[]</code>). You may wish to edit the signature so that it displays arguments properly.<sup class="footnote-ref"><a href="#fn3" id="fnref3">3</a></sup></li></ul><p>I'll leave the first two functions as an exercise for the reader. :)</p><p><code>mix()</code> seems to be a total oddball, as tries don't usually have such a function.</p><p class="caption"><a class="lightbox-single" title="Ghidra decompilation of the TrieNode::mix function." href="/img/posts/ctf/hkcert23/assets/trienode-mix-1536w.webp"><img class="mb-2 rw center w-100" src="/img/posts/ctf/hkcert23/assets/trienode-mix-1536w.webp" loading="lazy" decoding="async" style="aspect-ratio:auto 1536/1098" alt="Ghidra decompilation of the TrieNode::mix function." title="Ghidra decompilation of the TrieNode::mix function." srcset="/img/posts/ctf/hkcert23/assets/trienode-mix-512w.webp 512w, /img/posts/ctf/hkcert23/assets/trienode-mix-1536w.webp 1536w" sizes="(max-width: 512px) 512px, 1536px"></a><sup>Ghidra decompilation of <code>TrieNode::mix()</code>.</sup></p><details><summary><code>TrieNode::mix</code>: Possible Solution</summary><div class="details-content"><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">mix</span><span class="token punctuation">(</span><span class="token keyword">char</span> cmix<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	unordered_map<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span> TrieNode<span class="token operator">*</span><span class="token operator">></span> new_map<span class="token punctuation">;</span>

	<span class="token comment">// For each edge...</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> it <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-></span>next_node<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token operator">-></span>next_node<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">auto</span> pair <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token punctuation">;</span>
		<span class="token keyword">char</span> ch <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>pair<span class="token punctuation">)</span><span class="token punctuation">;</span>
		TrieNode<span class="token operator">*</span> node <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>pair<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// ...update the character.</span>
		new_map<span class="token punctuation">[</span>ch <span class="token operator">^</span> cmix<span class="token punctuation">]</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// A new map is used so that old mappings aren't kept.</span>
	<span class="token comment">// Update the map of the current node.</span>
	<span class="token keyword">this</span><span class="token operator">-></span>next_node <span class="token operator">=</span> new_map<span class="token punctuation">;</span>

	<span class="token comment">// Recurse into child nodes with the same xor key.</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> it <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-></span>next_node<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token operator">-></span>next_node<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">auto</span> pair <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token punctuation">;</span>
		<span class="token keyword">char</span> ch <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>pair<span class="token punctuation">)</span><span class="token punctuation">;</span>
		TrieNode<span class="token operator">*</span> node <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>pair<span class="token punctuation">)</span><span class="token punctuation">;</span>
		node<span class="token operator">-></span><span class="token function">mix</span><span class="token punctuation">(</span>cmix<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>Now if you run this through the compiler diff, it should respond with some lines:</p><pre class="language-diff-cpp"><code class="language-diff-cpp"><span class="token deleted-sign deleted language-cpp"><span class="token prefix deleted">-</span>  call    _ZSt3getILm0EKcP8TrieNodeERNSt13tuple_elementIXT_ESt4pairIT0_T1_EE4typeERS7_
</span><span class="token inserted-sign inserted language-cpp"><span class="token prefix inserted">+</span>  call    _ZSt3getILm0EKcP8TrieNodeERKNSt13tuple_elementIXT_ESt4pairIT0_T1_EE4typeERKS7_
</span></code></pre><p>Subtle. But there is a good reason why this occurs. We'll look at this in more detail later.</p><div class="details-collapse-bottom"><sub><a class="details-collapse-button">(collapse)</a></sub></div></div></details></div></div><h3 id="on-various-features" tabindex="-1"><a class="md-anchor" href="#on-various-features" aria-hidden="true"></a> On Various Features</h3><p>Common, but worth mentioning.</p><details><summary>On <code>auto</code></summary><div class="details-content"><p><code>auto</code> is a special keyword introduced in C++11 typically used to tell the compiler: &quot;figure out this type for me&quot;.</p><p>It has seen wide adoption and growing support in the standard (more features for <code>auto</code> are added each standard). Now (C++20) it's used widely in template parameters and lambda parameters.</p><div class="details-collapse-bottom"><sub><a class="details-collapse-button">(collapse)</a></sub></div></div></details><details><summary>On Iterators</summary><div class="details-content"><p>The previous solution for <code>mix()</code> made use of <em>iterators</em>. These are commonly used by the <abbr data-bs-placement="top" data-bs-toggle="tooltip" title="Standard Template Library">STL</abbr>, providing a generic interface for iterating over containers.</p><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> it <span class="token operator">=</span> container<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> container<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><p>We generally start with <code>.begin()</code> and iterate with <a href="https://stackoverflow.com/a/1077047/10239789">prefix increment</a> (<code>++it</code>) until we hit the <code>.end()</code> iterator. With iterators, we can apply generic <a href="https://en.cppreference.com/w/cpp/algorithm">algorithms</a> on generic containers.</p><div class="details-collapse-bottom"><sub><a class="details-collapse-button">(collapse)</a></sub></div></div></details><details><summary>On Unordered Map</summary><div class="details-content"><p>You may be wondering: why <code>std::unordered_map</code>? Why not <code>std::map</code>? Why type 10 extra keystrokes?</p><p>The reason is time complexity.</p><ul><li><code>std::map</code> is a binary search tree, giving <code>O(log n)</code> search time on average (where <code>n</code> is the number of entries).</li><li><code>std::unordered_map</code> is a hashmap, giving <code>O(1)</code> search time on average. Takes more space though.</li></ul><p>As the value of n increases, the number of operations required for <code>std::map</code> will increase at a faster rate compared to <code>std::unordered_map</code>. This is because <code>std::unordered_map</code> is not affected by the number of entries in the map (except in the case of rehashing); hence, the constant time complexity, <code>O(1)</code>.</p><p>In the interest of performance, it's typical to opt for <code>unordered_map</code>.</p><p>But in our case, since a node only has 256 possible edges (<code>char</code>), the potential speed boost is limited, and the choice between <code>map</code> and <code>unordered_map</code> is debatable. ¯\_(ツ)_/¯</p><div class="details-collapse-bottom"><sub><a class="details-collapse-button">(collapse)</a></sub></div></div></details><h3 id="on-scoping" tabindex="-1"><a class="md-anchor" href="#on-scoping" aria-hidden="true"></a> On Scoping</h3><p>An object in C++ has a <strong>constructor</strong> and <strong>destructor</strong>, functions that run at the beginning and end of its lifetime. The object's <em><strong>scope</strong></em> affects the placement of its constructor and destructor.<sup class="footnote-ref"><a href="#fn4" id="fnref4">4</a></sup></p><p>Let’s look at some examples:</p><pre class="language-cpp"><code class="language-cpp"><span class="token comment">// String in outer scope.</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	std<span class="token double-colon punctuation">::</span>string s<span class="token punctuation">;</span> <span class="token comment">// &lt;- string constructor called</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// do stuff</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token comment">// &lt;- string destructor called</span></code></pre><pre class="language-cpp"><code class="language-cpp"><span class="token comment">// String in inner scope.</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		std<span class="token double-colon punctuation">::</span>string s<span class="token punctuation">;</span> <span class="token comment">// &lt;- string constructor called</span>
		<span class="token comment">// do stuff</span>
	<span class="token punctuation">}</span>   <span class="token comment">// &lt;- string destructor called</span>
<span class="token punctuation">}</span></code></pre><p>Do you C the difference?</p><p>Things become complicated when we further consider <a href="https://www.internalpointers.com/post/understanding-meaning-lvalues-and-rvalues-c">lvalues and rvalues</a> (think: variables and temporaries).</p><details><summary>Complicated Examples</summary><div class="details-content"><pre class="language-cpp"><code class="language-cpp"><span class="token comment">// Passing lvalue string to normal parameter.</span>
<span class="token comment">// Copy constructor is called and a temp object is created.</span>
<span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span>string s<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	std<span class="token double-colon punctuation">::</span>string s<span class="token punctuation">;</span> <span class="token comment">// &lt;- string constructor called</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// do stuff</span>
		<span class="token comment">// ---</span>
		<span class="token comment">// &lt;- string copy constructor called (copies s to a temporary)</span>
		<span class="token function">print</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// &lt;- string destructor (of temporary string) called</span>
		<span class="token comment">// ---</span>
		<span class="token comment">// do more stuff</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>   <span class="token comment">// &lt;- string destructor called</span></code></pre><pre class="language-cpp"><code class="language-cpp"><span class="token comment">// Passing rvalue string to normal parameter.</span>
<span class="token comment">// Regular constructor is called and a temp object is created.</span>
<span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span>string s<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// do stuff</span>
		<span class="token comment">// ---</span>
		<span class="token comment">// `const char*` literal is implicitly converted to std::string.</span>
		<span class="token comment">// &lt;- string constructor called (creates a temporary)</span>
		<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Hello world!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// &lt;- string destructor (of temporary string) called</span>
		<span class="token comment">// ---</span>
		<span class="token comment">// do more stuff</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><div class="details-collapse-bottom"><sub><a class="details-collapse-button">(collapse)</a></sub></div></div></details><p>I don't intend to cover every single possible case. But yes, C++ is <em>extremely</em> nuanced in this regard. (See also: <a href="https://cplusplus.com/doc/tutorial/classes/">classes</a>, <a href="https://cplusplus.com/doc/tutorial/classes2/">special member functions</a>, <a href="https://stackoverflow.com/q/3106110/10239789">move semantics</a>.)</p><div class="alert alert-success d-flex align-items-start"><i class="fas fa-lightbulb ms-1 me-3 mt-1 fs-4" role="img"></i><div class="alert-content flex-fill mt-0"><p>The point is: <strong>object scoping is all reflected at assembly level</strong>. We can get a good understanding where an object is declared by <em>paying attention to its constructors and destructors</em>.</p><p>This applies to classes, such as STL containers. Primitives (int, char, pointers) don't have constructors/destructors, so it’s trickier to tell where they're instantiated. It's even trickier with heavy optimisations.</p></div></div><div class="alert alert-info d-flex align-items-start"><i class="fas fa-circle-info ms-1 me-3 mt-1 fs-4" role="img"></i><div class="alert-content flex-fill mt-0"><p><strong>Exercise</strong>: Reverse the <code>main</code> function.</p><ul><li>Use the position of constructors and destructors to determine the scope of various strings.</li><li>Beware backslashes in the inserted strings.</li></ul><details><summary>Possible Solution</summary><div class="details-content"><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> opt<span class="token punctuation">;</span>
    string str<span class="token punctuation">;</span>
    TrieNode<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">TrieNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// `const char*` literal is implicitly converted to std::string.</span>
    node<span class="token operator">-></span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token string">"\x72\x50\x54\x52\x73\x66\x51\x5a\x79\x72\x75\x4b\x7f\x4e\x4d\x55\x47\x7e\x68\x7e\x72\x51\x42\x71"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// node->insert(string("...")); also works</span>
    <span class="token comment">// -- snip --</span>
    <span class="token comment">// node->insert("...");</span>
    
    node<span class="token operator">-></span>should_mix <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Enter [1] for insert string"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Enter [2] for search string"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Option: "</span><span class="token punctuation">;</span>
        cin <span class="token operator">>></span> opt<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>opt <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Input string to insert: "</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            cin <span class="token operator">>></span> str<span class="token punctuation">;</span>
            node<span class="token operator">-></span><span class="token function">insert</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>opt <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Input string to search: "</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            cin <span class="token operator">>></span> str<span class="token punctuation">;</span>
            <span class="token keyword">bool</span> res <span class="token operator">=</span> node<span class="token operator">-></span><span class="token function">search</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"String "</span> <span class="token operator">&lt;&lt;</span> str <span class="token operator">&lt;&lt;</span> <span class="token string">" exists."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"String "</span> <span class="token operator">&lt;&lt;</span> str <span class="token operator">&lt;&lt;</span> <span class="token string">" does not exists."</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Bye"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><div class="details-collapse-bottom"><sub><a class="details-collapse-button">(collapse)</a></sub></div></div></details></div></div><p>From here on, we'll continue making incremental adjustments to improve our score, while learning various C++ nuances and features.</p><h3 id="on-structured-bindings" tabindex="-1"><a class="md-anchor" href="#on-structured-bindings" aria-hidden="true"></a> On Structured Bindings</h3><p>Here we take a detour to peek at build.sh. And something sparkly catches our eye:</p><pre class="language-sh"><code class="language-sh">g++ <span class="token string">"<span class="token variable">$@</span>"</span> -fno-asm <span class="token parameter variable">-std</span><span class="token operator">=</span>c++17 <span class="token parameter variable">-g</span> <span class="token parameter variable">-o</span> <span class="token string">"<span class="token variable">$binary</span>"</span> <span class="token string">"<span class="token variable">$source</span>"</span></code></pre><p>Our code is compiled with C++17—what an oddly specific standard!</p><p>One cool feature introduced by this standard is <strong>structured bindings</strong>, which is as close as we can get to Python iterable unpacking.</p><pre class="language-diff-cpp"><code class="language-diff-cpp"><span class="token unchanged language-cpp"><span class="token prefix unchanged"> </span> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> it <span class="token operator">=</span> next_node<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> next_node<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="token deleted-sign deleted language-cpp"><span class="token prefix deleted">-</span>     <span class="token keyword">auto</span> pair <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token punctuation">;</span>
<span class="token prefix deleted">-</span>     <span class="token keyword">char</span> ch <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>pair<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token prefix deleted">-</span>     TrieNode<span class="token operator">*</span> node <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>pair<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="token inserted-sign inserted language-cpp"><span class="token prefix inserted">+</span>     <span class="token keyword">auto</span> <span class="token punctuation">[</span>ch<span class="token punctuation">,</span> node<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token punctuation">;</span>
</span><span class="token unchanged language-cpp"><span class="token prefix unchanged"> </span>     new_map<span class="token punctuation">[</span>ch <span class="token operator">^</span> cmix<span class="token punctuation">]</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>
<span class="token prefix unchanged"> </span> <span class="token punctuation">}</span>
</span></code></pre><p>Since <code>it</code> is an iterator over key-value pairs, we can dereference, then bind (unpack) the pair to <code>ch</code> and <code>node</code>.</p><div class="alert alert-success d-flex align-items-start"><i class="fas fa-lightbulb ms-1 me-3 mt-1 fs-4" role="img"></i><div class="alert-content flex-fill mt-0"><p>One telltale sign of structured bindings is in the second loop of <code>TrieNode::mix()</code>. Notice how the first item of the pair (<code>ch2 = std::get&lt;0&gt;(pair);</code>) is read but never used.</p><p><a class="lightbox-single" title="The first pair element (a character) is not used." href="/img/posts/ctf/hkcert23/assets/char-not-used-1506w.webp"><img class="mb-2 rw center w-100" src="/img/posts/ctf/hkcert23/assets/char-not-used-1506w.webp" loading="lazy" decoding="async" style="aspect-ratio:auto 1506/465" alt="The first pair element (a character) is not used." title="The first pair element (a character) is not used." srcset="/img/posts/ctf/hkcert23/assets/char-not-used-512w.webp 512w, /img/posts/ctf/hkcert23/assets/char-not-used-1506w.webp 1506w" sizes="(max-width: 512px) 512px, 1506px"></a></p><p class="caption"><sup>Ghidra decompilation of the second loop of <code>mix()</code>. Notice how <code>ch2</code> is never used. (You can also verify this by inspecting the disassembly!)</sup></p><p>Another giveaway is that <code>std::get</code> is rarely used to access map pairs, unless in generic code. The idiomatic ways are:</p><ul><li><code>std::pair</code> members (through iterator): <code>it-&gt;first</code>, <code>it-&gt;second</code></li><li><code>std::pair</code> members (through pair):<pre class="language-cpp"><code class="language-cpp"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> pr <span class="token operator">:</span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// pr.first, pr.second</span>
<span class="token punctuation">}</span></code></pre></li><li>structured bindings (since C++17)</li></ul><p>N.B. With optimisations, these indicators would be less obvious. Thankfully the program <em>wasn't</em> compiled with optimisations.</p></div></div><h3 id="on-const-ref" tabindex="-1"><a class="md-anchor" href="#on-const-ref" aria-hidden="true"></a> On Const Ref</h3><p>We're still short of our target though. Some diff lines stand out:</p><pre class="language-diff-cpp"><code class="language-diff-cpp"><span class="token unchanged language-cpp"><span class="token prefix unchanged"> </span>  <span class="token comment">// Extra stack variables!</span>
</span><span class="token deleted-sign deleted language-cpp"><span class="token prefix deleted">-</span>  sub     rsp<span class="token punctuation">,</span> <span class="token number">0xc8</span>
<span class="token prefix deleted">-</span>  mov     <span class="token punctuation">[</span>rbp<span class="token operator">-</span><span class="token number">0xc8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rdi
</span><span class="token inserted-sign inserted language-cpp"><span class="token prefix inserted">+</span>  sub     rsp<span class="token punctuation">,</span> <span class="token number">0xb8</span>
<span class="token prefix inserted">+</span>  mov     <span class="token punctuation">[</span>rbp<span class="token operator">-</span><span class="token number">0xb8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rdi
</span><span class="token unchanged language-cpp"><span class="token prefix unchanged"> </span>  <span class="token comment">// Calling the wrong overload!</span>
</span><span class="token deleted-sign deleted language-cpp"><span class="token prefix deleted">-</span>  call    _ZSt3getILm0EKcP8TrieNodeERNSt13tuple_elementIXT_ESt4pairIT0_T1_EE4typeERS7_
</span><span class="token inserted-sign inserted language-cpp"><span class="token prefix inserted">+</span>  call    _ZSt3getILm0EKcP8TrieNodeERKNSt13tuple_elementIXT_ESt4pairIT0_T1_EE4typeERKS7_
</span></code></pre><p class="caption"><sup>Extracted diff lines from compiler.py output. Red (-) indicates extra lines in our program. Green (+) indicates missing lines.</sup></p><ol><li>Looks like we declared 16-bytes of extra stack variables.<ul><li>Local variables are stored on the stack, which allocates memory by a simple <code>sub</code> instruction.</li><li>Larger subtraction = more stack memory allocated.</li></ul></li><li>It also looks like we called the wrong overload. The mangled names roughly translate to:<pre class="language-diff-cpp"><code class="language-diff-cpp">// simplified for readability
<span class="token deleted-sign deleted language-cpp"><span class="token prefix deleted">-</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span> TrieNode<span class="token operator">*</span><span class="token operator">></span><span class="token operator">&amp;</span><span class="token punctuation">)</span>
</span><span class="token inserted-sign inserted language-cpp"><span class="token prefix inserted">+</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span> TrieNode<span class="token operator">*</span><span class="token operator">></span> <span class="token keyword">const</span><span class="token operator">&amp;</span><span class="token punctuation">)</span>
</span></code></pre></li></ol><p>We can fix both these issues by qualifying our binding as <code>const&amp;</code>.</p><pre class="language-diff-cpp"><code class="language-diff-cpp"><span class="token unchanged language-cpp"><span class="token prefix unchanged"> </span> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> it <span class="token operator">=</span> next_node<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> next_node<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="token deleted-sign deleted language-cpp"><span class="token prefix deleted">-</span>     <span class="token keyword">auto</span> <span class="token punctuation">[</span>ch<span class="token punctuation">,</span> node<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token punctuation">;</span>
</span><span class="token inserted-sign inserted language-cpp"><span class="token prefix inserted">+</span>     <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> <span class="token punctuation">[</span>ch<span class="token punctuation">,</span> node<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token punctuation">;</span>
</span><span class="token unchanged language-cpp"><span class="token prefix unchanged"> </span>     new_map<span class="token punctuation">[</span>ch <span class="token operator">^</span> cmix<span class="token punctuation">]</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>
<span class="token prefix unchanged"> </span> <span class="token punctuation">}</span>
</span></code></pre><p>With <code>auto</code>, our binding was creating new <code>char</code> and <code>TrieNode*</code> copies. (Hence, the extra 16 bytes.) With <code>const auto&amp;</code>, we take a constant reference.</p><ul><li>Constant: meaning we only <em>read</em> the value. No modifications. This fixes the second issue.</li><li>Reference: meaning we <em>refer</em> (point) to the original objects instead of copying them. This fixes the first issue.</li></ul><p>Using const-refs is good practice for maintainability and performance (imagine copying a 64-byte struct each iteration 🤮).</p><h3 id="on-for-range-loops" tabindex="-1"><a class="md-anchor" href="#on-for-range-loops" aria-hidden="true"></a> On For-Range Loops</h3><p>The astute may notice the above can be refactored slightly with the help of range-based <code>for</code>-loops. These were introduced in C++11, and are like Python <code>for</code>-<code>in</code> loops, but less powerful.</p><details><summary>Example</summary><div class="details-content"><pre class="language-diff-cpp"><code class="language-diff-cpp"><span class="token deleted-sign deleted language-cpp"><span class="token prefix deleted">-</span> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> it <span class="token operator">=</span> next_node<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> next_node<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token prefix deleted">-</span>     <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> <span class="token punctuation">[</span>ch<span class="token punctuation">,</span> node<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span>it<span class="token punctuation">;</span>
</span><span class="token inserted-sign inserted language-cpp"><span class="token prefix inserted">+</span> <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> <span class="token punctuation">[</span>ch<span class="token punctuation">,</span> node<span class="token punctuation">]</span> <span class="token operator">:</span> next_node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="token unchanged language-cpp"><span class="token prefix unchanged"> </span>     new_map<span class="token punctuation">[</span>ch <span class="token operator">^</span> cmix<span class="token punctuation">]</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>
<span class="token prefix unchanged"> </span> <span class="token punctuation">}</span>
</span></code></pre><div class="details-collapse-bottom"><sub><a class="details-collapse-button">(collapse)</a></sub></div></div></details><p>In fact, range-based <code>for</code>-loops are syntactic sugar for the plain loops we all know and love.</p><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">for</span> <span class="token punctuation">(</span>range_decl <span class="token operator">:</span> range_expr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">/* ... */</span>
<span class="token punctuation">}</span></code></pre><p>translates to...</p><pre class="language-cpp"><code class="language-cpp"><span class="token punctuation">{</span>
	<span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> __range <span class="token operator">=</span> range_expr<span class="token punctuation">;</span>
	<span class="token keyword">auto</span> __begin <span class="token operator">=</span> begin<span class="token punctuation">;</span> <span class="token comment">// Usually std::begin(__range)</span>
	<span class="token keyword">auto</span> __end <span class="token operator">=</span> end<span class="token punctuation">;</span>     <span class="token comment">// ...and std::end(__range).</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> __begin <span class="token operator">!=</span> __end<span class="token punctuation">;</span> <span class="token operator">++</span>__begin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		range_decl <span class="token operator">=</span> <span class="token operator">*</span>__begin<span class="token punctuation">;</span>
		<span class="token comment">/* ... */</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><p>(See more: <a href="https://en.cppreference.com/w/cpp/language/range-for">cppreference</a>.)</p><h3 id="on-control-flow" tabindex="-1"><a class="md-anchor" href="#on-control-flow" aria-hidden="true"></a> On Control Flow</h3><p>Decompiler output may not accurately present the control flow of the original program. Changing:</p><ol><li>the order of control flow, and</li><li>which statement is used</li></ol><p>may lead us closer to 100%.</p><p>Would it make more sense to use a <span class="spoiler"><code>switch</code></span> instead of an <code>if</code> in a certain place?</p><h3 id="other-useful-tips" tabindex="-1"><a class="md-anchor" href="#other-useful-tips" aria-hidden="true"></a> Other Useful Tips</h3><ul><li>Use Godbolt’s <strong>Compiler Explorer</strong> to play around with disassembly output. It helps with analysing small details such as variable declaration.<ul><li>Remember to set x86-64 gcc 12.2 and <code>-std=c++17</code>.</li></ul></li><li>Two good sources for standard library documentation are <a href="https://en.cppreference.com/w/"><em>cppreference</em></a> (high quality) and <a href="https://cplusplus.com/reference/"><em>cplusplus.com</em></a> (beginner-friendly).</li><li>Version control is incredibly useful for tracking incremental changes.</li></ul><h2 id="the-infernal-flag" tabindex="-1"><a class="md-anchor" href="#the-infernal-flag" aria-hidden="true"></a> The Infernal Flag</h2><p>Once we recover enough source code, it's time to find the internal flag. This is probably the least interesting part (for me), so I'll keep it short.</p><p>Notice:</p><ul><li>In <code>main</code>, a bunch of garbage strings are inserted into the trie.</li><li>Afterwards, mixing is turned on (<code>node-&gt;should_mix = true</code>), so that the next <code>node-&gt;insert()</code> will jumble the trie...</li></ul><p>Now it's time to take a really close look at <code>mix()</code>.</p><ul><li><em>What</em> is jumbled? All the strings.</li><li>How? <span class="spoiler">All chars are xor'ed with a char (the <code>wordhash</code> of a string).</span></li><li>How many possible chars are there? <span class="spoiler">256</span>.</li><li>Two words: <span class="spoiler">brute force</span>.</li></ul><p>Maybe one of the strings just happens to be the internal flag xor'ed. Who knows?</p><p>After getting ≥ 97.5% similarity and finding the internal flag, submit both to the platform and profit!</p><h2 id="final-remarks" tabindex="-1"><a class="md-anchor" href="#final-remarks" aria-hidden="true"></a> Final Remarks</h2><p>I'm sure the chal is called Vitamin C++ because it's designed to make us (mentally) stronger. Every time you trie harder, you lose a brain cell but strengthen a neuron. Indeed, we covered quite a lot of concepts today:</p><ul><li>Language Features: <code>auto</code>, structured bindings, for-range loops, const-ref.</li><li>Library Features: iterators, unordered map.</li><li>Unordered map is preferred for performance in lookup.</li><li>Scoping (and lvalue-rvalueness) affects position of constructors/destructors. (Very good takeaway for C++ reversing.)</li><li>Pay attention to groups of <code>sub</code> and <code>mov</code> instructions to check if we declared too little/many stack variables.</li><li>Ghidra is pretty powerful.</li><li>C++ is fun.</li></ul><p>Lots of tuning was involved; but the various tricks employed above netted us a first blood, so I can't complain. Despite a couple lines of janky const-uncorrect code, it was a nice challenge.</p><p><a class="lightbox-single" title="Hello?! Const-correctness? Ever heard of it?" href="/img/posts/ctf/hkcert23/assets/where-mah-const-correctness-672w.webp"><img class="mb-2 rw center w-60" src="/img/posts/ctf/hkcert23/assets/where-mah-const-correctness-672w.webp" loading="lazy" decoding="async" style="aspect-ratio:auto 672/457" alt="Hello?! Const-correctness? Ever heard of it?" title="Hello?! Const-correctness? Ever heard of it?" srcset="/img/posts/ctf/hkcert23/assets/where-mah-const-correctness-512w.webp 512w, /img/posts/ctf/hkcert23/assets/where-mah-const-correctness-672w.webp 672w" sizes="(max-width: 512px) 512px, 672px"></a></p><p>Also, who doesn't like a good pun hidden in a challenge?</p><p><a class="lightbox-single" title="An error message saying 'nice trie(graph)' embedded in the sanity checker." href="/img/posts/ctf/hkcert23/assets/nice-trie-graph-1012w.webp"><img class="mb-2 rw center w-60" src="/img/posts/ctf/hkcert23/assets/nice-trie-graph-1012w.webp" loading="lazy" decoding="async" style="aspect-ratio:auto 1012/232" alt="An error message saying 'nice trie(graph)' embedded in the sanity checker." title="An error message saying 'nice trie(graph)' embedded in the sanity checker." srcset="/img/posts/ctf/hkcert23/assets/nice-trie-graph-512w.webp 512w, /img/posts/ctf/hkcert23/assets/nice-trie-graph-1012w.webp 1012w" sizes="(max-width: 512px) 512px, 1012px"></a></p><h2 id="solve-sauce" tabindex="-1"><a class="md-anchor" href="#solve-sauce" aria-hidden="true"></a> Solve Sauce</h2><p>(Files not embedded, as they're a bit big.)</p><ul><li><a href="https://gist.github.com/TrebledJ/43792e01ceed0c94f35717c453d2e4da#file-rev-cpp">rev.cpp: Fully reversed (100% similarity) source.</a></li><li><a href="https://gist.github.com/TrebledJ/43792e01ceed0c94f35717c453d2e4da#file-solve-py">solve.py: For cracking the internal flag.</a></li><li><a href="https://gist.github.com/TrebledJ/43792e01ceed0c94f35717c453d2e4da#file-send-py">send.py: Driver program to test rev.cpp.</a></li></ul><h2 id="flag" tabindex="-1"><a class="md-anchor" href="#flag" aria-hidden="true"></a> Flag</h2><pre class="language-text"><code class="language-text">hkcert23{c++stl_i5_ev3rywh3r3_dur1ng_r3v}</code></pre><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="fn1" class="footnote-item"><p>Decompetition is a reverse-engineering CTF held irregularly. <a href="#fnref1" class="footnote-backref">↩︎</a></p></li><li id="fn2" class="footnote-item"><p>In proper engineering, we would hide implementation behind <code>private</code>, so <code>next_node</code> should be a private variable. <a href="#fnref2" class="footnote-backref">↩︎</a></p></li><li id="fn3" class="footnote-item"><p>Or just read the assembly and follow the call conventions (thiscall for member functions, fastcall for everything else). <a href="#fnref3" class="footnote-backref">↩︎</a></p></li><li id="fn4" class="footnote-item"><p>This also depends on optimisations, and whether the object contains any other classes. In some cases, constructors or destructors may be inlined or optimised away. <a href="#fnref4" class="footnote-backref">↩︎</a></p></li></ol></section></div><a id="end-of-article"></a><br><script defer="defer" src="https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js"></script><div class="post-share dim-light mb-3 d-flex flex-row align-items-center"><span style="margin-right:-4px">Share&nbsp;on</span><div class="d-flex flex-row flex-wrap align-items-center"><a data-sharer="reddit" data-title="HKCERT CTF 2023 – Decompetition: Vitamin C++" data-url="/posts/hkcert-2023-decompetition-vitamin-cpp/"><span class="fs-4 ms-3 me-n1"><i class="fab fa-reddit"></i> </span></a><a data-sharer="telegram" data-title="HKCERT CTF 2023 – Decompetition: Vitamin C++" data-url="/posts/hkcert-2023-decompetition-vitamin-cpp/"><span class="fs-4 ms-3 me-n1"><i class="fab fa-telegram"></i> </span></a><a data-sharer="whatsapp" data-title="HKCERT CTF 2023 – Decompetition: Vitamin C++" data-url="/posts/hkcert-2023-decompetition-vitamin-cpp/"><span class="fs-4 ms-3 me-n1"><i class="fab fa-whatsapp"></i> </span></a><a data-sharer="facebook" data-title="HKCERT CTF 2023 – Decompetition: Vitamin C++" data-url="/posts/hkcert-2023-decompetition-vitamin-cpp/"><span class="fs-4 ms-3 me-n1"><i class="fab fa-facebook"></i> </span></a><a data-sharer="twitter" data-title="HKCERT CTF 2023 – Decompetition: Vitamin C++" data-url="/posts/hkcert-2023-decompetition-vitamin-cpp/"><span class="fs-4 ms-3 me-n1"><i class="fab fa-twitter"></i> </span></a><a id="copy-link-button" data-bs-toggle="tooltip" data-bs-trigger="click" title="Link copied!"><span class="fs-4 ms-3 me-n1"><i class="fas fa-link"></i></span></a></div></div><hr><div id="post-author-container" class="d-flex justify-content-between align-items-center" itemprop="author" itemscope itemtype="https://schema.org/Person"><img src="/img/profile-icon.jpg" class="profile-img me-3" alt="" loading="lazy" decoding="async" itemprop="image"><div class="author-info d-flex flex-column me-3"><p class="profile-name" itemprop="name">TrebledJ</p><p class="profile-bio" itemprop="description">Dabbling in code, music, math, and memes since conception.</p></div><div id="post-author-social-items-wrapper" class="ms-auto mt-1"><button class="btn btn-primary py-1">+&nbsp;Social</button><ul class="social-item-list hidden"><li><div class="d-flex align-items-center"><a href="https://github.com/TrebledJ"><i class="social-icon fab fa-github" style="color:#963cb4!important"></i> </a><a href="https://github.com/TrebledJ"><span class="social-link">GitHub</span></a></div></li><li><div class="d-flex align-items-center"><a href="https://stackoverflow.com/users/10239789/trebledj"><i class="social-icon fab fa-stack-overflow" style="color:#ec7c22!important"></i> </a><a href="https://stackoverflow.com/users/10239789/trebledj"><span class="social-link">StackOverflow</span></a></div></li><li><div class="d-flex align-items-center"><a href="https://www.codingame.com/profile/8444100ecb9723c1ec542346b0630aaa2821532"><i class="social-icon d-flex align-items-center"><img src="/img/logos/codingame.webp" alt="" loading="lazy" decoding="async"></i></a><a href="https://www.codingame.com/profile/8444100ecb9723c1ec542346b0630aaa2821532"><span class="social-link">CodinGame</span></a></div></li><li><div class="d-flex align-items-center"><a href="https://soundcloud.com/trebledj"><i class="social-icon fab fa-soundcloud" style="color:#ed6e1e!important"></i> </a><a href="https://soundcloud.com/trebledj"><span class="social-link">SoundCloud</span></a></div></li><li><div class="d-flex align-items-center"><a href="https://musescore.com/user/20636901"><i class="social-icon d-flex align-items-center"><img src="/img/logos/musescore.webp" alt="" loading="lazy" decoding="async"></i></a><a href="https://musescore.com/user/20636901"><span class="social-link">MuseScore</span></a></div></li><li><div class="d-flex align-items-center"><a href="https://discordapp.com/users/220427982798454794"><i class="social-icon fab fa-discord" style="color:#5464eb!important"></i> </a><a href="https://discordapp.com/users/220427982798454794"><span class="social-link">Discord (TrebledJ#7595)</span></a></div></li><li><div class="d-flex align-items-center"><a href="mailto:trebledjjj@gmail.com"><i class="social-icon fas fa-envelope"></i> </a><a href="mailto:trebledjjj@gmail.com"><span class="social-link">Mail</span></a></div></li><li><div class="d-flex align-items-center"><a href="/feeds"><i class="social-icon fas fa-square-rss"></i> </a><a href="/feeds"><span class="social-link">Feeds</span></a></div></li></ul></div></div><hr class="section-sep"><div id="related" class="w-100"><h3><i class="fas fa-circle-nodes me-2"></i>Related Posts</h3><div class="row gx-3 mt-4"><div class="related-col-flex-auto-4"><article class="post-minified-preview"><a href="/posts/attack-of-the-zip/"></a><div class="d-flex flex-column"><a class="post-thumbnail" href="/posts/attack-of-the-zip/"><img class="post-img-blurred-bg" src="/img/posts/cybersec/attack-of-the-zip/assets/attack-of-the-zip-512w.webp" loading="lazy" decoding="async" style="aspect-ratio:auto 512/218" alt="Thumbnail for Attack of the Zip" srcset="/img/posts/cybersec/attack-of-the-zip/assets/attack-of-the-zip-512w.webp 512w, /img/posts/cybersec/attack-of-the-zip/assets/attack-of-the-zip-1173w.webp 1173w" sizes="(max-width: 512px) 512px, 512px"><div class="post-img-container d-flex w-100 h-100"><img class="post-img-contain" src="/img/posts/cybersec/attack-of-the-zip/assets/attack-of-the-zip-512w.webp" loading="lazy" decoding="async" style="aspect-ratio:auto 512/218" alt="Thumbnail for Attack of the Zip" srcset="/img/posts/cybersec/attack-of-the-zip/assets/attack-of-the-zip-512w.webp 512w, /img/posts/cybersec/attack-of-the-zip/assets/attack-of-the-zip-1173w.webp 1173w" sizes="(max-width: 512px) 512px, 512px"></div></a><div class="post-content d-flex flex-column justify-content-between"><div><h2 class="post-title">Attack of the Zip</h2><div class="post-summary"><p>Deep dive into zip file attacks and mitigations (with examples!).</p></div></div><div class="metadata-tag-container d-flex flex-row align-items-top"><div class="tag-list d-flex flex-row flex-wrap align-items-center"><span><a class="tag" href="/tags/cybersec/" itemprop="keywords">cybersec</a> </span><span><a class="tag" href="/tags/tutorial/" itemprop="keywords">tutorial</a> </span><span><a class="tag" href="/tags/web/" itemprop="keywords">web</a></span></div></div></div></div></article></div><div class="related-col-flex-auto-4"><article class="post-minified-preview"><a href="/posts/subtype-metaprogramming-is-mostly-harmless/"></a><div class="d-flex flex-column"><a class="post-thumbnail" href="/posts/subtype-metaprogramming-is-mostly-harmless/"><img class="post-img-blurred-bg" src="/img/posts/programming/concepts/assets/thumbnail-512w.webp" loading="lazy" decoding="async" style="aspect-ratio:auto 512/249" alt="Thumbnail for N[Subtype Metaprogramming] is N[Mostly Harmless]" srcset="/img/posts/programming/concepts/assets/thumbnail-512w.webp 512w, /img/posts/programming/concepts/assets/thumbnail-804w.webp 804w" sizes="(max-width: 512px) 512px, 512px"><div class="post-img-container d-flex w-100 h-100"><img class="post-img-contain" src="/img/posts/programming/concepts/assets/thumbnail-512w.webp" loading="lazy" decoding="async" style="aspect-ratio:auto 512/249" alt="Thumbnail for N[Subtype Metaprogramming] is N[Mostly Harmless]" srcset="/img/posts/programming/concepts/assets/thumbnail-512w.webp 512w, /img/posts/programming/concepts/assets/thumbnail-804w.webp 804w" sizes="(max-width: 512px) 512px, 512px"></div></a><div class="post-content d-flex flex-column justify-content-between"><div><h2 class="post-title"><sub><sup>N[</sup></sub>Subtype Metaprogramming<sub><sup>]</sup></sub> is <sub><sup>N[</sup></sub>Mostly Harmless<sub><sup>]</sup></sub></h2><div class="post-summary"><p>Inheritance go brrrrrrrr... (ab)using types to write programs.</p></div></div><div class="metadata-tag-container d-flex flex-row align-items-top"><div class="tag-list d-flex flex-row flex-wrap align-items-center"><span><a class="tag" href="/tags/programming/" itemprop="keywords">programming</a> </span><span><a class="tag" href="/tags/ctf/" itemprop="keywords">ctf</a> </span><span><a class="tag" href="/tags/types/" itemprop="keywords">types</a></span></div></div></div></div></article></div><div class="related-col-flex-auto-4"><article class="post-minified-preview"><a href="/posts/hitcon-2023-the-blade/"></a><div class="d-flex flex-column"><a class="post-thumbnail" href="/posts/hitcon-2023-the-blade/"><img class="post-img-blurred-bg" src="/img/posts/ctf/hitcon23/assets/hitcon-thumbnail-512w.webp" loading="lazy" decoding="async" style="aspect-ratio:auto 512/206" alt="Thumbnail for HITCON 2023 – The Blade" srcset="/img/posts/ctf/hitcon23/assets/hitcon-thumbnail-512w.webp 512w, /img/posts/ctf/hitcon23/assets/hitcon-thumbnail-1570w.webp 1570w" sizes="(max-width: 512px) 512px, 512px"><div class="post-img-container d-flex w-100 h-100"><img class="post-img-contain" src="/img/posts/ctf/hitcon23/assets/hitcon-thumbnail-512w.webp" loading="lazy" decoding="async" style="aspect-ratio:auto 512/206" alt="Thumbnail for HITCON 2023 – The Blade" srcset="/img/posts/ctf/hitcon23/assets/hitcon-thumbnail-512w.webp 512w, /img/posts/ctf/hitcon23/assets/hitcon-thumbnail-1570w.webp 1570w" sizes="(max-width: 512px) 512px, 512px"></div></a><div class="post-content d-flex flex-column justify-content-between"><div><h2 class="post-title">HITCON 2023 – The Blade</h2><div class="post-summary"><p>Beginner-friendly writeup for a nifty Rust reversing challenge.</p></div></div><div class="metadata-tag-container d-flex flex-row align-items-top"><div class="tag-list d-flex flex-row flex-wrap align-items-center"><span><a class="tag" href="/tags/ctf/" itemprop="keywords">ctf</a> </span><span><a class="tag" href="/tags/writeup/" itemprop="keywords">writeup</a> </span><span><a class="tag" href="/tags/reverse/" itemprop="keywords">reverse</a></span></div></div></div></div></article></div><div class="related-col-flex-auto-4"><article class="post-minified-preview"><a href="/posts/gdb-cheatsheet/"></a><div class="d-flex flex-column"><a class="post-thumbnail" href="/posts/gdb-cheatsheet/"><img class="post-img-blurred-bg" src="/img/posts/programming/gdb/assets/gef-512w.webp" loading="lazy" decoding="async" style="aspect-ratio:auto 512/250" alt="Thumbnail for GDB/GEF Cheatsheet" srcset="/img/posts/programming/gdb/assets/gef-512w.webp 512w, /img/posts/programming/gdb/assets/gef-906w.webp 906w" sizes="(max-width: 512px) 512px, 512px"><div class="post-img-container d-flex w-100 h-100"><img class="post-img-contain" src="/img/posts/programming/gdb/assets/gef-512w.webp" loading="lazy" decoding="async" style="aspect-ratio:auto 512/250" alt="Thumbnail for GDB/GEF Cheatsheet" srcset="/img/posts/programming/gdb/assets/gef-512w.webp 512w, /img/posts/programming/gdb/assets/gef-906w.webp 906w" sizes="(max-width: 512px) 512px, 512px"></div></a><div class="post-content d-flex flex-column justify-content-between"><div><h2 class="post-title">GDB/GEF Cheatsheet</h2><div class="post-summary"><p>Quick command reference on one of the most powerful tools for dynamic analysis.</p></div></div><div class="metadata-tag-container d-flex flex-row align-items-top"><div class="tag-list d-flex flex-row flex-wrap align-items-center"><span><a class="tag" href="/tags/programming/" itemprop="keywords">programming</a> </span><span><a class="tag" href="/tags/ctf/" itemprop="keywords">ctf</a> </span><span><a class="tag" href="/tags/pwn/" itemprop="keywords">pwn</a></span></div></div></div></div></article></div><div class="related-col-flex-auto-4"><article class="post-minified-preview"><a href="/posts/ductf-2023-wrong-signal/"></a><div class="d-flex flex-column"><a class="post-thumbnail" href="/posts/ductf-2023-wrong-signal/"><img class="post-img-blurred-bg" src="/img/posts/ctf/ductf23/assets/straight-to-oops-512w.webp" loading="lazy" decoding="async" style="aspect-ratio:auto 512/287" alt="Thumbnail for DUCTF 2023 – Wrong Signal" srcset="/img/posts/ctf/ductf23/assets/straight-to-oops-512w.webp 512w, /img/posts/ctf/ductf23/assets/straight-to-oops-888w.webp 888w" sizes="(max-width: 512px) 512px, 512px"><div class="post-img-container d-flex w-100 h-100"><img class="post-img-contain" src="/img/posts/ctf/ductf23/assets/straight-to-oops-512w.webp" loading="lazy" decoding="async" style="aspect-ratio:auto 512/287" alt="Thumbnail for DUCTF 2023 – Wrong Signal" srcset="/img/posts/ctf/ductf23/assets/straight-to-oops-512w.webp 512w, /img/posts/ctf/ductf23/assets/straight-to-oops-888w.webp 888w" sizes="(max-width: 512px) 512px, 512px"></div></a><div class="post-content d-flex flex-column justify-content-between"><div><h2 class="post-title">DUCTF 2023 – Wrong Signal</h2><div class="post-summary"><p>You straight to <code>oops()</code>. Right away.</p></div></div><div class="metadata-tag-container d-flex flex-row align-items-top"><div class="tag-list d-flex flex-row flex-wrap align-items-center"><span><a class="tag" href="/tags/ctf/" itemprop="keywords">ctf</a> </span><span><a class="tag" href="/tags/writeup/" itemprop="keywords">writeup</a> </span><span><a class="tag" href="/tags/reverse/" itemprop="keywords">reverse</a></span></div></div></div></div></article></div><div class="related-col-flex-auto-4"><article class="post-minified-preview"><a href="/posts/hkust-firebird-ctf-team/"></a><div class="d-flex flex-column"><a class="post-thumbnail" href="/posts/hkust-firebird-ctf-team/"><img class="post-img-blurred-bg" src="/img/firebird-400w.webp" loading="lazy" decoding="async" style="aspect-ratio:auto 400/400" alt="Thumbnail for The HKUST Firebird CTF Team" srcset="/img/firebird-400w.webp 400w" sizes="(max-width: 512px) 512px, 400px"><div class="post-img-container d-flex w-100 h-100"><img class="post-img-contain" src="/img/firebird-400w.webp" loading="lazy" decoding="async" style="aspect-ratio:auto 400/400" alt="Thumbnail for The HKUST Firebird CTF Team" srcset="/img/firebird-400w.webp 400w" sizes="(max-width: 512px) 512px, 400px"></div></a><div class="post-content d-flex flex-column justify-content-between"><div><h2 class="post-title">The HKUST Firebird CTF Team</h2><div class="post-summary"><p>Experiences and reflections journeying with the HKUST Firebird CTF Team.</p></div></div><div class="metadata-tag-container d-flex flex-row align-items-top"><div class="tag-list d-flex flex-row flex-wrap align-items-center"><span><a class="tag" href="/tags/experience/" itemprop="keywords">experience</a> </span><span><a class="tag" href="/tags/ctf/" itemprop="keywords">ctf</a> </span><span><a class="tag" href="/tags/hkust/" itemprop="keywords">hkust</a></span></div></div></div></div></article></div></div><hr><h3><i class="fas fa-tags me-2"></i>Related Tags</h3><div class="mt-3"><h4><abbr data-bs-placement="top" data-bs-toggle="tooltip" title="Related to ctf, reverse">software.ctf</abbr></h4><span class="d-flex flex-wrap"><a class="tag" href="/tags/ctf/">ctf</a> <a class="tag" href="/tags/reverse/">reverse</a> <a class="tag" href="/tags/pwn/">pwn</a> <a class="tag" href="/tags/cryptography/">cryptography</a> <a class="tag" href="/tags/stego/">stego</a></span></div><div class="mt-3"><h4><abbr data-bs-placement="top" data-bs-toggle="tooltip" title="Related to programming">software.general</abbr></h4><span class="d-flex flex-wrap"><a class="tag" href="/tags/programming/">programming</a> <a class="tag" href="/tags/software-engineering/">software-engineering</a> <a class="tag" href="/tags/aoc/">aoc</a> <a class="tag" href="/tags/apps/">apps</a> <a class="tag" href="/tags/dsp/">dsp</a> <a class="tag" href="/tags/programming-languages/">programming-languages</a> <a class="tag" href="/tags/web/">web</a> <a class="tag" href="/tags/functional/">functional</a> <a class="tag" href="/tags/types/">types</a> <a class="tag" href="/tags/cybersec/">cybersec</a> <a class="tag" href="/tags/metaprogramming/">metaprogramming</a> <a class="tag" href="/tags/oop/">oop</a></span></div><div class="mt-3"><h4><abbr data-bs-placement="top" data-bs-toggle="tooltip" title="Related to cpp">software.programming-language</abbr></h4><span class="d-flex flex-wrap"><a class="tag" href="/tags/cpp/">cpp</a> <a class="tag" href="/tags/python/">python</a> <a class="tag" href="/tags/c/">c</a> <a class="tag" href="/tags/haskell/">haskell</a> <a class="tag" href="/tags/qt/">qt</a> <a class="tag" href="/tags/js/">js</a> <a class="tag" href="/tags/rust/">rust</a> <a class="tag" href="/tags/qml/">qml</a> <a class="tag" href="/tags/scala/">scala</a> <a class="tag" href="/tags/sql/">sql</a></span></div><div class="mt-3"><h4><abbr data-bs-placement="top" data-bs-toggle="tooltip" title="Related to tutorial, writeup">misc</abbr></h4><span class="d-flex flex-wrap"><a class="tag" href="/tags/writeup/">writeup</a> <a class="tag" href="/tags/hkust/">hkust</a> <a class="tag" href="/tags/tutorial/">tutorial</a> <a class="tag" href="/tags/reflection/">reflection</a> <a class="tag" href="/tags/project/">project</a> <a class="tag" href="/tags/notes/">notes</a> <a class="tag" href="/tags/experience/">experience</a> <a class="tag" href="/tags/faith/">faith</a> <a class="tag" href="/tags/mathematics/">mathematics</a> <a class="tag" href="/tags/essay/">essay</a> <a class="tag" href="/tags/meta/">meta</a> <a class="tag" href="/tags/learning/">learning</a> <a class="tag" href="/tags/cheatsheet/">cheatsheet</a> <a class="tag" href="/tags/reading/">reading</a></span></div></div><hr class="section-sep"><div class="container mt-4 p-4"><a id="comments"></a><p>Comments have been disabled in non-production.</p></div><br></div></div></article></div></div></div><footer><p>Copyright&nbsp;©&nbsp;2024&nbsp;TrebledJ • <a href="/privacy-policy">Privacy&nbsp;Policy</a> • Hosted&nbsp;on&nbsp;Cloudflare&nbsp;Pages.</p></footer><script defer="defer" src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script><script defer="defer" src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script><script defer="defer" src="https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js"></script><script defer="defer" src="/js/head.js"></script><script defer="defer" src="/js/search.js"></script><script defer="defer" src="/js/post.js"></script></body>